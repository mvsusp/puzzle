import{B as h,a as A,M as F,T as S,b as k,O as Ft,V as g,E as $t,c as Nt,C as Ht,N as vt,d as Gt,G as pt,e as Vt,f as Ct,L as Mt,g as V,F as ht,h as gt,i as w,j as Kt,k as Y,l as kt,P as ft,m as it,n as _t,o as wt,p as Xt,D as Tt,R as Yt,q as qt,S as jt,r as Qt,A as Zt,s as Jt,W as te,t as ee,u as ie}from"./AssetLoader-Bs61u6Ma.js";class lt{constructor(t){this.mesh=null,this.falling=!1,this.floatTimer=0,this.swapTimer=0,this.garbageFallChain=!1,this.explosionOrder=0,this.explosionTicks=0,this.explosionAnimationTicks=0,this.explosionTimer=0,this.state=h.NORMAL,this.color=t}static getRandomColor(t=[]){const e=[];for(let i=0;i<Object.keys(A).length/2;i++)t.includes(i)||e.push(i);return e.length===0?Math.floor(Math.random()*(Object.keys(A).length/2)):e[Math.floor(Math.random()*e.length)]}tick(){this.state===h.FLOATING&&this.floatTimer>0&&(this.floatTimer--,this.floatTimer<=0&&!this.falling&&(this.state=h.NORMAL)),(this.state===h.SWAPPING_LEFT||this.state===h.SWAPPING_RIGHT)&&this.swapTimer>0&&(this.swapTimer--,this.swapTimer<=0&&(this.state=h.FLOATING,this.floatTimer=12,delete this.swapTargetPosition)),this.state===h.EXPLODING&&this.explosionTimer<this.explosionTicks&&this.explosionTimer++}startFloat(){this.state=h.FLOATING,this.floatTimer=12}startSwap(t,e){this.state=t==="left"?h.SWAPPING_LEFT:h.SWAPPING_RIGHT,this.swapTimer=3,e&&(this.swapTargetPosition=e)}markMatched(){this.state=h.MATCHED}startExplosion(t=61){this.state=h.EXPLODING,this.explosionTicks=t,this.explosionAnimationTicks=t,this.explosionTimer=0}canMatch(){return this.state===h.NORMAL&&!this.falling}isStable(){return this.state===h.NORMAL&&!this.falling}isAnimating(){return this.state===h.SWAPPING_LEFT||this.state===h.SWAPPING_RIGHT||this.state===h.FLOATING||this.state===h.EXPLODING}reset(){this.state=h.NORMAL,this.falling=!1,this.floatTimer=0,this.swapTimer=0,this.garbageFallChain=!1,this.explosionOrder=0,this.explosionTicks=0,this.explosionAnimationTicks=0,this.explosionTimer=0}dispose(){this.mesh&&(this.mesh.geometry&&this.mesh.geometry.dispose(),this.mesh.material instanceof F&&this.mesh.material.dispose(),this.mesh=null)}toString(){return`Block(${A[this.color]}, ${this.state})`}}var st=(a=>(a.NORMAL="normal",a.GRAY="gray",a))(st||{}),at=(a=>(a.NORMAL="normal",a.TRIGGERED="triggered",a.TRANSFORMING="transforming",a))(at||{});class Wt{constructor(t,e,i,s,n="normal"){this.bufferRow=[],this.transformationTicks=0,this.transformationTimer=0,this.animationStart=0,this.falling=!1,this.initialFall=!0,this.explosionOrder=0,this.x=t,this.y=e,this.width=i,this.height=s,this.type=n,this.state="normal",this.transformationTicks=this.calculateTransformationTime(),this.fillBufferRow()}calculateTransformationTime(){return 60+this.width*this.height*10}fillBufferRow(){this.bufferRow=[];for(let t=0;t<this.width;t++){const e=[];t>0&&e.push(this.bufferRow[t-1].color);const i=lt.getRandomColor(e),s=new lt(i);this.bufferRow.push(s)}}trigger(){return this.state==="transforming"?!1:this.type==="normal"&&this.state==="normal"?(this.state="triggered",this.transformationTimer=0,this.animationStart=0,!0):this.type==="gray"&&this.state==="normal"?(this.state="triggered",this.transformationTimer=0,this.animationStart=0,!0):!1}checkForTrigger(t){const e=[{row:this.y-1,col:this.x},{row:this.y+this.height,col:this.x},{row:this.y,col:this.x-1},{row:this.y,col:this.x+this.width}];for(const i of e){const s=t(i.row,i.col);if(s&&typeof s=="object"&&"type"in s&&"block"in s){const n=s;if(n.type===S.BLOCK&&n.block?.state===h.MATCHED)return!0}}return!1}tick(){(this.state==="triggered"||this.state==="transforming")&&(this.transformationTimer++,this.state==="triggered"&&this.transformationTimer>=30&&(this.state="transforming"))}canFall(t){if(this.falling||this.state!=="normal"||this.y===0)return!1;for(let e=this.x;e<this.x+this.width;e++){const i=t(this.y-1,e);if(i&&typeof i=="object"&&"type"in i&&i.type!==S.AIR)return!1}return!0}startFall(){this.falling=!0}stopFall(){this.falling=!1}fall(){this.y>0&&this.y--,this.initialFall=!1}isTransformationComplete(){return this.state==="transforming"&&this.transformationTimer>=this.transformationTicks}shouldRemove(){return this.isTransformationComplete()}getTransformationBlocks(){return[...this.bufferRow]}getBounds(){return{x:this.x,y:this.y,width:this.width,height:this.height}}containsPosition(t,e){return t>=this.x&&t<this.x+this.width&&e>=this.y&&e<this.y+this.height}getTransformationProgress(){return this.transformationTicks===0?1:Math.min(this.transformationTimer/this.transformationTicks,1)}reset(){this.state="normal",this.transformationTimer=0,this.animationStart=0,this.falling=!1,this.initialFall=!0,this.explosionOrder=0,this.fillBufferRow()}dispose(){this.bufferRow.forEach(t=>t.dispose()),this.bufferRow=[]}toString(){return`GarbageBlock(${this.x},${this.y} ${this.width}x${this.height} ${this.type} ${this.state})`}}const Q=class Q{constructor(){this.logs=[],this.enabled=!0}static getInstance(){return Q.instance||(Q.instance=new Q),Q.instance}log(t,e="match"){if(!this.enabled)return;const i=new Date().toISOString().split("T")[1].substring(0,12),s=this.getEmojiForType(e),n=`[${i}] ${s} ${t}`;this.logs.push(n),this.logs.length>50&&this.logs.shift(),this.updateDebugDisplay()}getEmojiForType(t){switch(t){case"match":return"üéØ";case"combo":return"üî•";case"chain":return"‚õìÔ∏è";case"score":return"üí∞";case"end":return"üèÅ";default:return"üéØ"}}updateDebugDisplay(){const t=document.getElementById("comboPointingLog");if(t){const e=this.logs.slice(-15);t.innerHTML=e.join("<br>"),t.scrollTop=t.scrollHeight}}clear(){this.logs=[],this.updateDebugDisplay()}getLogs(){return[...this.logs]}setEnabled(t){this.enabled=t}};Q.instance=null;let xt=Q;function $(a,t="match"){xt.getInstance().log(a,t)}const l=class l{constructor(t){this.garbageBlocks=[],this.garbageQueue=[],this.ticksRun=0,this.cursorX=2,this.cursorY=5,this.stackOffset=0,this.stackRaiseTicks=10,this.stackRaiseTimer=0,this.stackRaiseForced=!1,this.graceTimer=180,this.activeBlocks=!1,this.chainCounter=1,this.lastChain=0,this.score=0,this.panic=!1,this.tickMatched=0,this.tickChain=!1,this.tickChainEnd=!1,this.tickMatchRow=-1,this.tickMatchCol=-1,this.tickComboSize=0,this.tickChainLength=0,this.lastTickHadMatches=!1,this.consecutiveNonMatchTicks=0,this.warnColumns=new Array(l.BOARD_WIDTH).fill(!1),this.blockOnTopRow=!1,this.countdownState=3,this.audioSystem=null,this.audioSystem=t||null,this.tiles=Array(l.BOARD_HEIGHT).fill(null).map(()=>Array(l.BOARD_WIDTH).fill(null).map(()=>this.createEmptyTile())),this.bufferRow=Array(l.BOARD_WIDTH).fill(null).map(()=>this.createEmptyTile()),this.state=k.COUNTDOWN,this.initializeBoard()}createEmptyTile(){return{type:S.AIR,block:null,garbageRef:null,chain:!1}}initializeBoard(){for(let t=0;t<6;t++)for(let e=0;e<l.BOARD_WIDTH;e++){const i=[];if(e>=2){const o=this.tiles[t][e-1].block,r=this.tiles[t][e-2].block;o&&r&&o.color===r.color&&i.push(o.color)}if(t>=2){const o=this.tiles[t-1][e].block,r=this.tiles[t-2][e].block;o&&r&&o.color===r.color&&i.push(o.color)}const s=lt.getRandomColor(i),n=new lt(s);this.tiles[t][e]={type:S.BLOCK,block:n,garbageRef:null,chain:!1}}this.fillBufferRow()}fillBufferRow(){for(let t=0;t<l.BOARD_WIDTH;t++){const e=[],i=this.tiles[0][t].block;if(i&&e.push(i.color),t>0){const o=this.bufferRow[t-1].block;o&&e.push(o.color)}const s=lt.getRandomColor(e),n=new lt(s);this.bufferRow[t]={type:S.BLOCK,block:n,garbageRef:null,chain:!1}}}tick(){switch(this.ticksRun++,this.initTick(),this.state){case k.COUNTDOWN:this.handleCountdown();break;case k.RUNNING:this.handleGameplay();break;case k.WON:case k.GAME_OVER:break}}initTick(){this.tickMatched=0,this.tickChain=!1,this.tickChainEnd=!1,this.tickMatchRow=-1,this.tickMatchCol=-1,this.tickComboSize=0,this.tickChainLength=this.chainCounter;for(let t=0;t<l.BOARD_HEIGHT;t++)for(let e=0;e<l.BOARD_WIDTH;e++){const i=this.tiles[t][e];i.block&&i.block.tick()}for(const t of this.bufferRow)t.block&&t.block.tick();this.garbageBlocks.forEach(t=>{if(t.tick(),t.canFall((e,i)=>this.getTile(e,i))){for(let e=t.y;e<t.y+t.height;e++)for(let i=t.x;i<t.x+t.width;i++){const s=this.getTile(e,i);s&&s.garbageRef===t&&(s.type=S.AIR,s.garbageRef=null)}t.fall(),this.audioSystem&&(t.width*t.height>=6?this.audioSystem.playSfx("bigthump"):this.audioSystem.playSfx("thump"));for(let e=t.y;e<t.y+t.height;e++)for(let i=t.x;i<t.x+t.width;i++){const s=this.getTile(e,i);s&&(s.type=S.GARBAGE,s.garbageRef=t)}}})}handleCountdown(){if(this.ticksRun>=l.COUNTDOWN_TICKS)this.state=k.RUNNING,this.countdownState=0;else{const t=l.COUNTDOWN_TICKS-this.ticksRun;t>l.COUNTDOWN_TICKS*.75?this.countdownState=3:t>l.COUNTDOWN_TICKS*.5?this.countdownState=2:t>l.COUNTDOWN_TICKS*.25?this.countdownState=1:this.countdownState=0}}handleGameplay(){this.checkGameOver(),this.updatePanicState(),this.processGarbageQueue(),this.handleExplosions(),this.handleGravity(),this.handleMatching(),this.handleStackRaising(),this.updateVisualState()}checkGameOver(){this.blockOnTopRow=!1;for(let t=0;t<l.BOARD_WIDTH;t++){const e=this.tiles[l.TOP_ROW][t];if(e.type===S.BLOCK&&e.block?.isStable()){this.blockOnTopRow=!0;break}}this.blockOnTopRow&&this.graceTimer<=0&&(this.state=k.GAME_OVER)}updatePanicState(){let t=0;for(let i=0;i<l.BOARD_WIDTH;i++)for(let s=l.BOARD_HEIGHT-1;s>=0;s--)if(this.tiles[s][i].type===S.BLOCK){t=Math.max(t,s+1);break}const e=this.panic;this.panic=t>=l.PANIC_HEIGHT,this.panic!==e&&this.audioSystem&&(this.panic?this.audioSystem.crossfadeMusic("battle_panic",1):this.audioSystem.crossfadeMusic("battle_normal",1));for(let i=0;i<l.BOARD_WIDTH;i++)this.warnColumns[i]=this.tiles[l.WARN_HEIGHT][i].type===S.BLOCK}handleStackRaising(){const t=this.stackRaiseTimer<=0;this.stackRaiseForced||t&&this.graceTimer<=0?(this.raiseStack(),this.stackRaiseTimer=this.stackRaiseTicks):this.stackRaiseTimer>0&&this.stackRaiseTimer--,this.graceTimer>0&&this.graceTimer--}raiseStack(){!this.activeBlocks&&!this.blockOnTopRow&&(this.stackOffset<l.STACK_RAISE_STEPS&&this.stackOffset++,this.stackOffset>=l.STACK_RAISE_STEPS&&(this.performFullRowRise(),this.stackRaiseForced&&(this.score+=1),this.stackRaiseForced=!1,this.stackOffset=0))}performFullRowRise(){for(let t=l.BOARD_HEIGHT-1;t>0;t--)for(let e=0;e<l.BOARD_WIDTH;e++)this.tiles[t][e]=this.tiles[t-1][e];for(let t=0;t<l.BOARD_WIDTH;t++)this.tiles[0][t]=this.bufferRow[t];this.fillBufferRow(),this.stackOffset=0,this.cursorY<=10&&this.cursorY++}inputForceStackRaise(){this.state===k.RUNNING&&(this.activeBlocks||(this.stackRaiseForced=!0))}updateVisualState(){this.activeBlocks=!1;for(let t=0;t<l.BOARD_HEIGHT;t++)for(let e=0;e<l.BOARD_WIDTH;e++){const i=this.tiles[t][e];if(i.block&&i.block.isAnimating()){this.activeBlocks=!0;return}}}queueGarbage(t,e,i=st.NORMAL){const s={fullWidth:t,type:i,size:e,spawnTimer:10};this.garbageQueue.push(s)}getTile(t,e){return t<0||t>=l.BOARD_HEIGHT||e<0||e>=l.BOARD_WIDTH?null:this.tiles[t][e]}getBufferRowTile(t){return t<0||t>=l.BOARD_WIDTH?null:this.bufferRow[t]}reset(){for(let t=0;t<l.BOARD_HEIGHT;t++)for(let e=0;e<l.BOARD_WIDTH;e++){const i=this.tiles[t][e];i.block&&i.block.dispose()}for(const t of this.bufferRow)t.block&&t.block.dispose();return this.garbageBlocks.forEach(t=>t.dispose()),new l}hasActiveBlocks(){return this.activeBlocks}getScore(){return this.score}getChainCounter(){return this.chainCounter}isPanic(){return this.panic}getWarnColumn(t){return t>=0&&t<l.BOARD_WIDTH?this.warnColumns[t]:!1}advanceCountdownState(){this.state===k.COUNTDOWN&&(this.countdownState=Math.max(0,this.countdownState-1),this.countdownState===0&&(this.state=k.RUNNING))}win(){this.state=k.WON}handleGravity(){let t=!1;for(let e=l.TOP_ROW;e>=0;e--)for(let i=0;i<l.BOARD_WIDTH;i++){const s=this.tiles[e][i];if(s.type===S.BLOCK&&s.block){const n=s.block;if(n.state===h.SWAPPING_LEFT||n.state===h.SWAPPING_RIGHT||n.state===h.MATCHED||n.state===h.EXPLODING)continue;if(n.state===h.NORMAL&&!n.falling&&!this.hasSupport(e,i)&&(n.falling=!0,n.startFloat(),t=!0),n.falling&&(n.state,h.FLOATING),n.falling&&n.state===h.FLOATING&&n.floatTimer<=0){const o=this.fallToBottom(e,i);o<e&&(t=!0);const r=this.tiles[o][i];r.block&&(r.block.state=h.NORMAL,r.block.falling=!1)}if(n.falling&&n.state===h.NORMAL&&!this.hasSupport(e,i)){const o=this.fallToBottom(e,i);o<e&&(t=!0);const r=this.tiles[o][i];r.block&&(r.block.state=h.NORMAL,r.block.falling=!1)}}}t&&(this.activeBlocks=!0)}hasSupport(t,e){if(t===0)return!0;const i=this.tiles[t-1][e];if(i.type===S.BLOCK&&i.block){const s=i.block;return!s.falling&&s.state!==h.EXPLODING&&s.state!==h.MATCHED}return i.type===S.GARBAGE}canFall(t,e){return t===0?!1:this.tiles[t-1][e].type===S.AIR}moveBlockDown(t,e){if(t===0||!this.canFall(t,e))return;const i=this.tiles[t][e],s=this.tiles[t-1][e];s.type=i.type,s.block=i.block,s.garbageRef=i.garbageRef,s.chain=i.chain,i.type=S.AIR,i.block=null,i.garbageRef=null,i.chain=!1,this.canFall(t-1,e)||s.block&&(s.block.state=h.NORMAL,s.block.falling=!1)}fallToBottom(t,e){if(t===0)return t;const i=this.tiles[t][e];if(!i.block)return t;let s=t;for(let n=t-1;n>=0&&this.tiles[n][e].type===S.AIR;n--)s=n;if(s<t){const n=this.tiles[s][e];n.type=i.type,n.block=i.block,n.garbageRef=i.garbageRef,n.chain=i.chain,i.type=S.AIR,i.block=null,i.garbageRef=null,i.chain=!1}return s}handleMatching(){const t=[];if(this.findMatches(t),t.length>=3){$(`Found ${t.length} matched blocks at: ${t.map(n=>`(${n.row},${n.col})`).join(" ")}`,"match"),this.tickMatched=t.length,this.lastTickHadMatches=!0,this.consecutiveNonMatchTicks=0;let e=!1,i=[];i=this.groupMatchesIntoCombo(t),this.tickComboSize=i.length,this.tickComboSize>1&&($(`${this.tickComboSize} simultaneous combos detected!`,"combo"),i.forEach((n,o)=>{n.map(r=>{const c=this.tiles[r.row][r.col];return c.block?["Purple","Yellow","Red","Cyan","Green"][c.block.color]:"Unknown"})}));let s=0;for(const n of t){const o=this.tiles[n.row][n.col];if(o.block){this.isChainBlock(n.row,n.col)&&(e=!0,o.block.falling=!1),o.block.markMatched(),o.block.explosionOrder=s++;const r=l.BASE_EXPLOSION_TICKS+l.ADD_EXPLOSION_TICKS*o.block.explosionOrder;o.block.startExplosion(r)}}e?(this.tickChain=!0,this.chainCounter++,this.tickChainLength=this.chainCounter,$(`Chain extended to ${this.chainCounter}! ${t.length} chain blocks matched`,"chain"),this.audioSystem&&this.audioSystem.playChain(this.chainCounter,t.length)):this.chainCounter>1?(this.chainCounter=1,this.tickChainLength=1,$("Chain broken - reset to 1","chain")):(this.chainCounter=1,this.tickChainLength=1,$(`Regular match (no chain) - ${t.length} blocks`,"match"),this.audioSystem&&t.length>=4&&this.audioSystem.playSfx("combo")),this.calculateAdvancedScore(t.length,i.length),t.length>0&&(this.tickMatchRow=t[0].row,this.tickMatchCol=t[0].col)}else this.lastTickHadMatches=!1,this.consecutiveNonMatchTicks++,this.chainCounter>1&&this.consecutiveNonMatchTicks>=2&&(this.tickChainEnd=!0,this.lastChain=this.chainCounter,$(`Chain ENDED at length ${this.chainCounter}! Total chain bonus applied.`,"end"),this.chainCounter=1)}findMatches(t){const e=new Set;for(let i=0;i<=l.TOP_ROW;i++)for(let s=0;s<l.BOARD_WIDTH-2;s++){const n=this.findHorizontalMatch(i,s);if(n.length>=3)for(const o of n){const r=`${o.row},${o.col}`;e.has(r)||(e.add(r),t.push(o))}}for(let i=0;i<l.BOARD_WIDTH;i++)for(let s=0;s<=l.TOP_ROW-2;s++){const n=this.findVerticalMatch(s,i);if(n.length>=3)for(const o of n){const r=`${o.row},${o.col}`;e.has(r)||(e.add(r),t.push(o))}}}findHorizontalMatch(t,e){const i=[],s=this.tiles[t][e];if(s.type!==S.BLOCK||!s.block||!s.block.canMatch())return i;const n=s.block.color;i.push({row:t,col:e});for(let o=e+1;o<l.BOARD_WIDTH;o++){const r=this.tiles[t][o];if(r.type===S.BLOCK&&r.block&&r.block.canMatch()&&r.block.color===n)i.push({row:t,col:o});else break}return i}findVerticalMatch(t,e){const i=[],s=this.tiles[t][e];if(s.type!==S.BLOCK||!s.block||!s.block.canMatch())return i;const n=s.block.color;i.push({row:t,col:e});for(let o=t+1;o<=l.TOP_ROW;o++){const r=this.tiles[o][e];if(r.type===S.BLOCK&&r.block&&r.block.canMatch()&&r.block.color===n)i.push({row:o,col:e});else break}return i}handleExplosions(){const t=[];for(let e=0;e<=l.TOP_ROW;e++)for(let i=0;i<l.BOARD_WIDTH;i++){const s=this.tiles[e][i];s.type===S.BLOCK&&s.block&&s.block.state===h.EXPLODING&&s.block.explosionTimer>=s.block.explosionTicks&&t.push({row:e,col:i})}t.length>0;for(const{row:e,col:i}of t){const s=this.tiles[e][i];s.block&&s.block.dispose(),s.type=S.AIR,s.block=null,s.garbageRef=null;for(let n=e+1;n<=l.TOP_ROW;n++){const o=this.tiles[n][i];if(o.type===S.BLOCK&&o.block)o.chain=!0,!o.block.falling&&o.block.state===h.NORMAL&&(o.block.falling=!0,o.block.startFloat());else break}}t.length>0&&(this.activeBlocks=!0)}isChainBlock(t,e){const i=this.tiles[t][e];if(!i||!i.block)return!1;if(i.chain||i.block.falling)return!0;if(t>0){const s=this.tiles[t-1][e];if(s.type===S.BLOCK&&s.block&&(s.block.state===h.MATCHED||s.block.state===h.EXPLODING))return!0}return!1}groupMatchesIntoCombo(t){const e=[],i=new Set;for(const s of t){const n=`${s.row},${s.col}`;if(i.has(n))continue;const o=this.findConnectedMatches(s.row,s.col,t,i);o.length>0&&e.push(o)}return e}findConnectedMatches(t,e,i,s){const n=[],o=[{row:t,col:e}],r=new Set(i.map(u=>`${u.row},${u.col}`)),c=this.tiles[t][e];if(!c.block)return n;const d=c.block.color;for(;o.length>0;){const u=o.shift();if(!u)break;const b=`${u.row},${u.col}`;if(s.has(b)||!r.has(b))continue;const N=this.tiles[u.row][u.col];if(!N.block||N.block.color!==d)continue;s.add(b),n.push(u);const R=[{row:u.row+1,col:u.col},{row:u.row-1,col:u.col},{row:u.row,col:u.col+1},{row:u.row,col:u.col-1}];for(const y of R)y.row>=0&&y.row<=l.TOP_ROW&&y.col>=0&&y.col<l.BOARD_WIDTH&&o.push(y)}return n}calculateAdvancedScore(t,e){let i=10*t*t;if(e>1){const o=1+(e-1)*.5,r=i;i=Math.floor(i*o),$(`Combo multiplier! ${e} combos √ó ${o.toFixed(2)} = ${r} ‚Üí ${i} points`,"score")}let s=0;if(this.chainCounter>=2){const o=[0,0,50,80,150,300,400,500,700,900,1100];this.chainCounter<o.length?s=o[this.chainCounter]:s=1300+(this.chainCounter-11)*200,$(`Chain bonus! Chain ${this.chainCounter} = +${s} points`,"score")}const n=i+s;this.score+=n}processGarbageQueue(){for(const e of this.garbageQueue)e.spawnTimer--;const t=this.garbageQueue.filter(e=>e.spawnTimer<=0);this.garbageQueue=this.garbageQueue.filter(e=>e.spawnTimer>0);for(const e of t)this.spawnGarbageBlock(e)}spawnGarbageBlock(t){const e=t.fullWidth?l.BOARD_WIDTH:t.size,i=1;let s=0;t.fullWidth||(s=Math.floor((l.BOARD_WIDTH-e)/2));const n=l.TOP_ROW+5;let o=!0;for(let c=n;c<n+i;c++){for(let d=s;d<s+e;d++){const u=this.getTile(c,d);if(!u||u.type!==S.AIR){o=!1;break}}if(!o)break}if(!o){t.spawnTimer=60,this.garbageQueue.push(t);return}const r=new Wt(s,n,e,i,t.type);this.garbageBlocks.push(r);for(let c=n;c<n+i;c++)for(let d=s;d<s+e;d++){const u=this.tiles[c][d];u.type=S.GARBAGE,u.garbageRef=r}}resetForNewGame(){this.state=k.COUNTDOWN,this.ticksRun=0,this.score=0,this.chainCounter=1,this.lastChain=0,this.panic=!1,this.cursorX=2,this.cursorY=5,this.stackOffset=0,this.stackRaiseTicks=10,this.stackRaiseTimer=0,this.stackRaiseForced=!1,this.graceTimer=180,this.activeBlocks=!1,this.tickMatched=0,this.tickChain=!1,this.tickChainEnd=!1,this.tickMatchRow=-1,this.tickMatchCol=-1,this.tickComboSize=0,this.tickChainLength=0,this.lastTickHadMatches=!1,this.consecutiveNonMatchTicks=0,this.warnColumns.fill(!1),this.blockOnTopRow=!1,this.countdownState=3;for(let t=0;t<l.BOARD_HEIGHT;t++)for(let e=0;e<l.BOARD_WIDTH;e++){const i=this.tiles[t][e];i.type=S.AIR,i.block=null,i.garbageRef=null,i.chain=!1}for(let t=0;t<l.BOARD_WIDTH;t++){const e=this.bufferRow[t];e.type=S.AIR,e.block=null,e.garbageRef=null,e.chain=!1}this.garbageBlocks.length=0,this.garbageQueue.length=0,this.initializeBoard()}getGarbageBlocks(){return this.garbageBlocks}setStackRaiseSpeed(t){this.stackRaiseTicks=Math.max(1,t)}getStackRaiseSpeed(){return this.stackRaiseTicks}setAutoRaise(t){t?this.stackRaiseTimer=this.stackRaiseTicks:this.stackRaiseTimer=0}setGarbageSpawningEnabled(t){t||(this.garbageQueue.length=0)}hasActiveMatches(){for(let t=0;t<l.BOARD_HEIGHT;t++)for(let e=0;e<l.BOARD_WIDTH;e++){const i=this.tiles[t][e];if(i.block&&(i.block.state===h.MATCHED||i.block.state===h.EXPLODING))return!0}return!1}hasFloatingBlocks(){for(let t=0;t<l.BOARD_HEIGHT;t++)for(let e=0;e<l.BOARD_WIDTH;e++){const i=this.tiles[t][e];if(i.block&&i.block.state===h.FLOATING)return!0}return!1}getHighestOccupiedRow(){for(let t=l.BOARD_HEIGHT-1;t>=0;t--)for(let e=0;e<l.BOARD_WIDTH;e++)if(this.tiles[t][e].type!==S.AIR)return t;return-1}findGarbageSpawnRow(t){for(let e=l.BOARD_HEIGHT-t;e>=l.TOP_ROW+1;e--){let i=!0;for(let s=e;s<e+t;s++){for(let n=0;n<l.BOARD_WIDTH;n++)if(this.tiles[s][n].type!==S.AIR){i=!1;break}if(!i)break}if(i)return e}return-1}addGarbageBlock(t){this.garbageBlocks.push(t);for(let e=t.y;e<t.y+t.height;e++)for(let i=t.x;i<t.x+t.width;i++)if(e>=0&&e<l.BOARD_HEIGHT&&i>=0&&i<l.BOARD_WIDTH){const s=this.tiles[e][i];s.type=S.GARBAGE,s.garbageRef=t}}isGameOver(){return this.state===k.GAME_OVER}resetToStartingState(){this.resetForNewGame()}getDebugInfo(){return`Board: ${this.state}, Ticks: ${this.ticksRun}, Score: ${this.score}, Chain: ${this.chainCounter}, Garbage: ${this.garbageBlocks.length}`}};l.BOARD_WIDTH=6,l.BOARD_HEIGHT=24,l.TOP_ROW=11,l.PANIC_HEIGHT=9,l.WARN_HEIGHT=10,l.FLOAT_TICKS=12,l.STACK_RAISE_STEPS=32,l.BASE_EXPLOSION_TICKS=61,l.ADD_EXPLOSION_TICKS=9,l.SWAP_DELAY=3,l.COUNTDOWN_TICKS=188;let T=l;const M={BLOCK_WIDTH:108,BLOCK_HEIGHT:103,BLOCK_DEPTH:16,BLOCK_GAP:10,TILE_SIZE_X:118,TILE_SIZE_Y:113},L={BOARD_PIXEL_WIDTH:M.BLOCK_WIDTH*6+M.BLOCK_GAP*5,BOARD_PIXEL_HEIGHT:M.BLOCK_HEIGHT*12+M.BLOCK_GAP*11};function et(a,t){const e=t*M.TILE_SIZE_X-L.BOARD_PIXEL_WIDTH/2+M.BLOCK_WIDTH/2,i=a*M.TILE_SIZE_Y-L.BOARD_PIXEL_HEIGHT/2+M.BLOCK_HEIGHT/2;return{x:e,y:i}}function se(){const a=M.BLOCK_WIDTH*2+M.BLOCK_GAP,t=M.BLOCK_HEIGHT;return{width:a,height:t}}const v={MATCH_BLINK_TICKS:5,MATCH_LANDED_TICKS:45,MATCH_ROTATE_TICKS:12},Et={MATCHED_SCALE_X:(M.BLOCK_WIDTH+5*2)/M.BLOCK_WIDTH,MATCHED_SCALE_Y:(M.BLOCK_HEIGHT+5*2)/M.BLOCK_HEIGHT};var B=(a=>(a.LINEAR="linear",a.EASE_IN="ease-in",a.EASE_OUT="ease-out",a.EASE_IN_OUT="ease-in-out",a.BOUNCE_OUT="bounce-out",a.ELASTIC_OUT="elastic-out",a))(B||{});const Z=class Z{constructor(){this.tweens=new Map,this.currentTick=0,this.nextId=0}static getInstance(){return Z.instance||(Z.instance=new Z),Z.instance}createTween(t){const e=`tween_${this.nextId++}`,i={id:e,config:t,startTime:this.currentTick+(t.delay||0),currentTime:this.currentTick,isComplete:!1,isActive:!1};return this.tweens.set(e,i),e}removeTween(t){return this.tweens.delete(t)}stopTweensForTarget(t){const e=[];this.tweens.forEach((i,s)=>{i.config.target===t&&e.push(s)}),e.forEach(i=>this.tweens.delete(i))}clearAllTweens(){this.tweens.clear()}tick(){this.currentTick++;const t=[];this.tweens.forEach((e,i)=>{if(!e.isActive&&this.currentTick>=e.startTime&&(e.isActive=!0),e.isActive&&!e.isComplete){const s=this.currentTick-e.startTime,n=Math.min(s/e.config.duration,1),o=this.applyEasing(n,e.config.easing||"linear");this.updateTweenTarget(e,o),e.config.onUpdate&&e.config.onUpdate(o),n>=1&&(e.isComplete=!0,t.push(i),e.config.onComplete&&e.config.onComplete())}}),t.forEach(e=>this.tweens.delete(e))}applyEasing(t,e){switch(e){case"linear":return t;case"ease-in":return t*t;case"ease-out":return 1-Math.pow(1-t,2);case"ease-in-out":return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;case"bounce-out":return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375;case"elastic-out":{const i=2*Math.PI/3;return t===0?0:t===1?1:Math.pow(2,-10*t)*Math.sin((t*10-.75)*i)+1}default:return t}}updateTweenTarget(t,e){const{target:i,from:s,to:n}=t.config;i instanceof Ft&&(s.position&&n.position&&i.position.lerpVectors(s.position,n.position,e),s.scale&&n.scale&&i.scale.lerpVectors(s.scale,n.scale,e),s.rotation&&n.rotation&&(i.rotation.x=this.lerp(s.rotation.x,n.rotation.x,e),i.rotation.y=this.lerp(s.rotation.y,n.rotation.y,e),i.rotation.z=this.lerp(s.rotation.z,n.rotation.z,e))),i instanceof F&&(s.opacity!==void 0&&n.opacity!==void 0&&(i.opacity=this.lerp(s.opacity,n.opacity,e)),s.color&&n.color&&"color"in i&&i.color.lerpColors(s.color,n.color,e))}lerp(t,e,i){return t+(e-t)*i}getActiveTweenCount(){return this.tweens.size}getDebugInfo(){return`Tweens: ${Array.from(this.tweens.values()).filter(e=>e.isActive).length}/${this.tweens.size} active`}};Z.instance=null;let nt=Z;const dt=class dt{static animateBlockFall(t,e,i,s,n){const o=e*M.TILE_SIZE_Y-L.BOARD_PIXEL_HEIGHT/2+M.BLOCK_HEIGHT/2,r=i*M.TILE_SIZE_Y-L.BOARD_PIXEL_HEIGHT/2+M.BLOCK_HEIGHT/2;return this.tween.createTween({target:t,duration:15,from:{position:new g(t.position.x,o,t.position.z)},to:{position:new g(t.position.x,r,t.position.z)},easing:"ease-in",onComplete:n})}static animateBlockSwap(t,e,i,s){const n=e==="left"?-118:M.TILE_SIZE_X,o=t.position.clone(),r=new g(o.x+n,o.y,o.z);return this.tween.createTween({target:t,duration:3,from:{position:o},to:{position:r},easing:"ease-in-out",onComplete:s})}static animateBlockSwapToPosition(t,e,i){const s=t.position.clone(),n=e.clone();return this.tween.createTween({target:t,duration:3,from:{position:s},to:{position:n},easing:"ease-in-out",onComplete:i})}static animateBlockExplosion(t,e,i,s){const n=t.scale.clone(),o=new g(n.x*1.5,n.y*1.5,n.z);return this.tween.createTween({target:t,duration:i,from:{scale:n,opacity:e.opacity},to:{scale:o,opacity:0},easing:"ease-out",onComplete:s})}static animateFloatBobbing(t){const e=t.position.y,i=2;return this.tween.createTween({target:t,duration:60,from:{position:new g(t.position.x,e-i,t.position.z)},to:{position:new g(t.position.x,e+i,t.position.z)},easing:"ease-in-out",onComplete:()=>{this.tween.createTween({target:t,duration:60,from:{position:new g(t.position.x,e+i,t.position.z)},to:{position:new g(t.position.x,e-i,t.position.z)},easing:"ease-in-out",onComplete:()=>dt.animateFloatBobbing(t)})}})}static animateStackRaise(t,e,i){let n=0;const o=t.flat().length;return t.forEach(r=>{r.forEach(c=>{const d=c.position.y,u=d+e;this.tween.createTween({target:c,duration:32,from:{position:new g(c.position.x,d,c.position.z)},to:{position:new g(c.position.x,u,c.position.z)},easing:"linear",onComplete:()=>{n++,n===o&&i&&i()}})})}),"stack_raise_animation"}static animateCursorPulse(t,e){return this.tween.createTween({target:e,duration:30,from:{opacity:.7},to:{opacity:1},easing:"ease-in-out",onComplete:()=>{this.tween.createTween({target:e,duration:30,from:{opacity:1},to:{opacity:.7},easing:"ease-in-out",onComplete:()=>dt.animateCursorPulse(t,e)})}})}};dt.tween=nt.getInstance();let ut=dt;class ne{constructor(t=M.TILE_SIZE_X){this.animationStates=new Map,this.tweenSystem=nt.getInstance(),this.tileSize=t,this.tileSizeY=M.TILE_SIZE_Y}startMatchRotation(t,e,i=12,s=0){if(e.userData&&e.userData.matchRotated)return;e.userData?e.userData.matchRotated=!0:e.userData={matchRotated:!0};const n=e.rotation.clone(),o=e.scale.clone(),r=e.position.z,c=Nt.degToRad(15),d=4;this.tweenSystem.createTween({target:e,duration:i,from:{rotation:n},to:{rotation:new $t(n.x,n.y+Math.PI/2,n.z)},delay:s,onUpdate:u=>{const b=-c*Math.sin(Math.PI*u);e.rotation.x=n.x+b;const N=1+.5*Math.sin(Math.PI*u);if(e.scale.set(o.x,o.y,N),e.position.z=r+d*Math.sin(Math.PI*u),Array.isArray(e.material)){const R=.25*Math.sin(Math.PI*u);for(let y=0;y<e.material.length;y++){const C=e.material[y];C&&C.emissive&&(y<=3?C.emissive.setRGB(R,R,R):C.emissive.setRGB(0,0,0))}}},onComplete:()=>{e.scale.copy(o),e.position.z=r,Array.isArray(e.material)&&e.material.forEach(u=>{const b=u;b&&b.emissive&&b.emissive.setRGB(0,0,0)})}})}tick(){this.updateAnimationStates()}startFallAnimation(t,e,i,s,n){this.stopBlockAnimations(t);const o={isFalling:!0,isSwapping:!1,isExploding:!1,isFloating:!1,fallFromRow:i,fallToRow:s};this.animationStates.set(t,o),ut.animateBlockFall(e,i,s,this.tileSize,()=>{o.isFalling=!1,n&&n()})}startSwapAnimation(t,e,i,s){this.stopBlockAnimations(t);const n={isFalling:!1,isSwapping:!0,isExploding:!1,isFloating:!1,swapDirection:i};this.animationStates.set(t,n),ut.animateBlockSwap(e,i,this.tileSize,()=>{n.isSwapping=!1,s&&s()})}startSwapAnimationToPosition(t,e,i,s){this.stopBlockAnimations(t);const n={isFalling:!1,isSwapping:!0,isExploding:!1,isFloating:!1};this.animationStates.set(t,n),ut.animateBlockSwapToPosition(e,i,()=>{n.isSwapping=!1,s&&s()})}startExplosionAnimation(t,e,i,s){this.stopBlockAnimations(t);const n={isFalling:!1,isSwapping:!1,isExploding:!0,isFloating:!1};this.animationStates.set(t,n),e.scale.set(Et.MATCHED_SCALE_X,Et.MATCHED_SCALE_Y,1);const o=v.MATCH_ROTATE_TICKS,r=v.MATCH_BLINK_TICKS+v.MATCH_LANDED_TICKS;this.createExplosionEffect(e,i,o,()=>{n.isExploding=!1,i.opacity=1,e.scale.set(1,1,1),e.rotation.set(0,0,0),s&&s()},r)}startFloatAnimation(t,e){if(this.animationStates.get(t)?.isFloating)return;const s={isFalling:!1,isSwapping:!1,isExploding:!1,isFloating:!0};this.animationStates.set(t,s),s.floatBobId=this.createFloatBobbing(e)}stopBlockAnimations(t){const e=this.animationStates.get(t);e?.floatBobId&&this.tweenSystem.removeTween(e.floatBobId),this.animationStates.delete(t)}isBlockAnimating(t){const e=this.animationStates.get(t);return!!(e?.isFalling||e?.isSwapping||e?.isExploding)}getAnimationState(t){return this.animationStates.get(t)||null}updateAnimationStates(){this.animationStates.forEach((t,e)=>{e.state===h.FLOATING&&!t.isFloating&&console.warn("Block in FLOATING state but no float animation active"),!t.isFalling&&!t.isSwapping&&!t.isExploding&&!t.isFloating&&this.animationStates.delete(e)})}createExplosionEffect(t,e,i,s,n=0){const o=e.opacity;this.tweenSystem.createTween({target:e,duration:i,from:{opacity:o},to:{opacity:0},easing:B.LINEAR,delay:n,onComplete:s})}createFloatBobbing(t){const e=t.position.y,i=3,s=40,n=()=>this.tweenSystem.createTween({target:t,duration:s,from:{position:new g(t.position.x,e-i,t.position.z)},to:{position:new g(t.position.x,e+i,t.position.z)},easing:B.EASE_IN_OUT,onComplete:()=>o()}),o=()=>this.tweenSystem.createTween({target:t,duration:s,from:{position:new g(t.position.x,e+i,t.position.z)},to:{position:new g(t.position.x,e-i,t.position.z)},easing:B.EASE_IN_OUT,onComplete:()=>n()});return n()}getDebugInfo(){const t=this.animationStates.size,e=this.tweenSystem.getDebugInfo();return`BlockAnimator: ${t} blocks, ${e}`}dispose(){this.tweenSystem.clearAllTweens(),this.animationStates.clear()}}class oe{constructor(t,e=32){this.riseState=null,this.tweenSystem=nt.getInstance(),this.board=t,this.tileSize=e}startStackRise(t){if(this.riseState?.isRising){console.warn("Stack rise already in progress");return}this.onRiseComplete=t,this.riseState={isRising:!0,currentStep:0,totalSteps:T.STACK_RAISE_STEPS,targetOffset:this.tileSize,startOffset:this.board.stackOffset},this.animateStackRise()}tick(){this.riseState?.isRising&&this.updateStackRiseProgress()}isRising(){return this.riseState?.isRising||!1}getStackOffset(){if(this.riseState){const t=this.riseState.currentStep/this.riseState.totalSteps;return this.riseState.startOffset+this.riseState.targetOffset*t}return this.board.stackOffset}getRiseProgress(){return this.riseState?this.riseState.currentStep/this.riseState.totalSteps:0}stopStackRise(){this.riseState&&(this.riseState.isRising=!1,this.board.stackOffset+=this.riseState.targetOffset,this.riseState=null)}animateBlockMeshes(t){if(!this.riseState?.isRising)return;const e=this.getRiseProgress(),i=this.tileSize*e;for(let s=0;s<=T.TOP_ROW;s++)for(let n=0;n<T.BOARD_WIDTH;n++){const o=t[s]?.[n];if(o&&o.visible){const r=n*this.tileSize-T.BOARD_WIDTH*this.tileSize/2+this.tileSize/2,c=s*this.tileSize-(T.TOP_ROW+1)*this.tileSize/2+this.tileSize/2;o.position.x=r,o.position.y=c+i}}}animateGridLines(t){if(!this.riseState?.isRising)return;const e=this.tileSize*this.getRiseProgress();t.forEach(i=>{i.position.y=e})}animateStackRise(){if(!this.riseState)return;const t={value:0};this.tweenSystem.createTween({target:t,duration:this.riseState.totalSteps,from:{value:0},to:{value:1},easing:B.LINEAR,onUpdate:e=>{this.riseState&&(this.riseState.currentStep=Math.floor(e*this.riseState.totalSteps))},onComplete:()=>{this.completeStackRise()}})}updateStackRiseProgress(){this.riseState&&this.riseState.currentStep>=this.riseState.totalSteps&&this.completeStackRise()}completeStackRise(){if(!this.riseState)return;this.board.stackOffset=0,this.riseState.isRising=!1,this.riseState=null;const t=this.onRiseComplete;this.onRiseComplete=void 0,t&&t()}getDebugInfo(){if(this.riseState?.isRising){const t=(this.getRiseProgress()*100).toFixed(1);return`StackRise: ${this.riseState.currentStep}/${this.riseState.totalSteps} (${t}%)`}return"StackRise: idle"}dispose(){this.stopStackRise()}}class Bt{constructor(t,e=M.TILE_SIZE_X){this.cursorMesh=null,this.cursorMaterial=null,this.tweenSystem=nt.getInstance(),this.cursor=t,this.tileSize=e,this.tileSizeY=M.TILE_SIZE_Y,this.animationState={isPulsing:!1,isMoving:!1}}setCursorMesh(t,e){this.cursorMesh=t,this.cursorMaterial=e,this.startPulseAnimation()}tick(){this.updateCursorEffects()}startPulseAnimation(){!this.cursorMaterial||this.animationState.isPulsing||(this.animationState.isPulsing=!0,this.animationState.pulseId=this.createPulseLoop())}stopPulseAnimation(){this.animationState.pulseId&&(this.tweenSystem.removeTween(this.animationState.pulseId),this.animationState.pulseId=void 0),this.animationState.isPulsing=!1}startMoveAnimation(t,e,i,s,n){if(!this.cursorMesh)return;this.animationState.moveId&&this.tweenSystem.removeTween(this.animationState.moveId),this.animationState.isMoving=!0;const o=this.boardToWorldPosition(e,t),r=this.boardToWorldPosition(s,i);this.cursorMesh&&(this.animationState.moveId=this.tweenSystem.createTween({target:this.cursorMesh,duration:8,from:{position:o},to:{position:r},easing:B.EASE_OUT,onComplete:n?()=>{this.animationState.isMoving=!1,this.animationState.moveId=void 0,n()}:()=>{this.animationState.isMoving=!1,this.animationState.moveId=void 0}}))}animateSwapFeedback(){if(!this.cursorMesh)return;const t=this.cursorMesh.scale.clone(),e=new g(t.x*1.3,t.y*1.3,t.z);this.cursorMesh&&(this.animationState.swapFeedbackId=this.tweenSystem.createTween({target:this.cursorMesh,duration:8,from:{scale:t},to:{scale:e},easing:B.EASE_OUT,onComplete:()=>{this.cursorMesh&&this.tweenSystem.createTween({target:this.cursorMesh,duration:8,from:{scale:e},to:{scale:t},easing:B.EASE_IN,onComplete:()=>{this.animationState.swapFeedbackId=void 0}})}}))}startPanicMode(){this.stopPulseAnimation(),this.cursorMaterial&&(this.animationState.isPulsing=!0,this.animationState.pulseId=this.createPanicPulseLoop())}stopPanicMode(){this.stopPulseAnimation(),this.startPulseAnimation()}isMoving(){return this.animationState.isMoving}updateCursorEffects(){if(!(!this.cursorMesh||!this.cursorMaterial)&&!this.animationState.isMoving){const t=this.cursor.getPosition(),e=this.boardToWorldPosition(t.y,t.x);this.cursorMesh.position.copy(e)}}createPulseLoop(){if(!this.cursorMaterial)return"";const t=.6,e=1,i=30,s=()=>{const o=this.cursorMaterial;return o?this.tweenSystem.createTween({target:o,duration:i,from:{opacity:t},to:{opacity:e},easing:B.EASE_IN_OUT,onComplete:()=>{this.animationState.isPulsing&&n()}}):""},n=()=>{const o=this.cursorMaterial;return o?this.tweenSystem.createTween({target:o,duration:i,from:{opacity:e},to:{opacity:t},easing:B.EASE_IN_OUT,onComplete:()=>{this.animationState.isPulsing&&s()}}):""};return s()}createPanicPulseLoop(){if(!this.cursorMaterial)return"";const t=.4,e=1,i=15,s=()=>{const o=this.cursorMaterial;return o?this.tweenSystem.createTween({target:o,duration:i,from:{opacity:t},to:{opacity:e},easing:B.EASE_IN_OUT,onComplete:()=>{this.animationState.isPulsing&&n()}}):""},n=()=>{const o=this.cursorMaterial;return o?this.tweenSystem.createTween({target:o,duration:i,from:{opacity:e},to:{opacity:t},easing:B.EASE_IN_OUT,onComplete:()=>{this.animationState.isPulsing&&s()}}):""};return s()}boardToWorldPosition(t,e){const i=et(t,e),s=i.x+M.BLOCK_WIDTH/2+M.BLOCK_GAP/2,n=i.y;return new g(s,n,2)}getDebugInfo(){const t=[];return this.animationState.isPulsing&&t.push("pulsing"),this.animationState.isMoving&&t.push("moving"),this.animationState.swapFeedbackId&&t.push("swap-feedback"),`CursorAnimator: ${t.join(", ")||"idle"}`}dispose(){this.stopPulseAnimation(),this.animationState.moveId&&this.tweenSystem.removeTween(this.animationState.moveId),this.animationState.swapFeedbackId&&this.tweenSystem.removeTween(this.animationState.swapFeedbackId),this.animationState={isPulsing:!1,isMoving:!1}}}class ae{constructor(t,e){this.cursor=null,this.cursorAnimator=null,this.lastBlockStates=new Map,this.blockMeshMap=new Map,this.blockMaterialMap=new Map,this.pendingMatchRotations=new Map,this.flipStarted=new Set,this.ROTATE_SAFETY_TICKS=4,this.board=t,this.tweenSystem=nt.getInstance(),this.tileSize=32,this.config={enableBlockAnimations:!0,enableStackAnimations:!0,enableCursorAnimations:!0,animationSpeed:1,...e},this.blockAnimator=new ne(this.tileSize),this.stackAnimator=new oe(this.board,this.tileSize)}setCursor(t){this.cursor=t,this.config.enableCursorAnimations&&(this.cursorAnimator=new Bt(t,this.tileSize))}setCursorMesh(t,e){this.cursorAnimator&&this.cursorAnimator.setCursorMesh(t,e)}registerBlockMesh(t,e,i){if(this.tweenSystem.stopTweensForTarget(e),this.blockMeshMap.set(t,e),this.blockMaterialMap.set(t,i),this.lastBlockStates.set(t,t.state),t.state===h.EXPLODING){const s=Math.max(0,v.MATCH_BLINK_TICKS+v.MATCH_LANDED_TICKS-this.ROTATE_SAFETY_TICKS),n=Math.max(0,s-(t.explosionTimer||0));if(!(!!(e.userData&&e.userData.matchRotated)||this.flipStarted.has(t)))if(n===0){const r=Math.max(0,(t.explosionTicks||0)-(t.explosionTimer||0)),c=Math.max(4,Math.min(v.MATCH_ROTATE_TICKS,r-1));this.blockAnimator.startMatchRotation(t,e,c),this.flipStarted.add(t)}else{const r=this.pendingMatchRotations.get(t);(r===void 0||r>n)&&this.pendingMatchRotations.set(t,n)}}}unregisterBlockMesh(t){this.blockMeshMap.delete(t),this.blockMaterialMap.delete(t),this.lastBlockStates.delete(t),this.blockAnimator.stopBlockAnimations(t)}tick(){this.tweenSystem.tick(),this.blockAnimator.tick(),this.stackAnimator.tick(),this.cursorAnimator?.tick(),this.updatePendingMatchRotations(),this.config.enableBlockAnimations&&this.updateBlockAnimations(),this.config.enableStackAnimations&&this.updateStackAnimations()}startStackRise(t){if(!this.config.enableStackAnimations){t&&t();return}this.stackAnimator.startStackRise(t)}triggerSwapFeedback(){this.cursorAnimator&&this.config.enableCursorAnimations&&this.cursorAnimator.animateSwapFeedback()}setPanicMode(t){this.cursorAnimator&&(t?this.cursorAnimator.startPanicMode():this.cursorAnimator.stopPanicMode())}animateBlockMeshesForStackRise(t){this.stackAnimator.isRising()&&this.stackAnimator.animateBlockMeshes(t)}hasCriticalAnimations(){return this.stackAnimator.isRising()||this.hasBlockFallAnimations()||this.hasBlockExplosionAnimations()}hasBlockFallAnimations(){for(const t of this.blockMeshMap.keys())if(this.blockAnimator.getAnimationState(t)?.isFalling)return!0;return!1}hasBlockExplosionAnimations(){for(const t of this.blockMeshMap.keys())if(this.blockAnimator.getAnimationState(t)?.isExploding)return!0;return!1}updateBlockAnimations(){this.blockMeshMap.forEach((t,e)=>{const i=this.blockMaterialMap.get(e);if(!i)return;const s=e.state,n=this.lastBlockStates.get(e);s!==n&&(this.handleBlockStateChange(e,t,i,n,s),this.lastBlockStates.set(e,s)),this.handleOngoingAnimations(e,t,i,s)})}handleBlockStateChange(t,e,i,s,n){switch(n){case h.FLOATING:s!==h.FLOATING&&this.blockAnimator.startFloatAnimation(t,e);break;case h.SWAPPING_LEFT:if(t.swapTargetPosition){const o=new g(t.swapTargetPosition.x,t.swapTargetPosition.y,e.position.z);console.log(`[ANIMATION] Using ABSOLUTE positioning for LEFT swap: from (${e.position.x.toFixed(2)}, ${e.position.y.toFixed(2)}) to (${o.x.toFixed(2)}, ${o.y.toFixed(2)})`),this.blockAnimator.startSwapAnimationToPosition(t,e,o)}else console.log("[ANIMATION] Using RELATIVE positioning for LEFT swap (no target)"),this.blockAnimator.startSwapAnimation(t,e,"left");break;case h.SWAPPING_RIGHT:if(t.swapTargetPosition){const o=new g(t.swapTargetPosition.x,t.swapTargetPosition.y,e.position.z);console.log(`[ANIMATION] Using ABSOLUTE positioning for RIGHT swap: from (${e.position.x.toFixed(2)}, ${e.position.y.toFixed(2)}) to (${o.x.toFixed(2)}, ${o.y.toFixed(2)})`),this.blockAnimator.startSwapAnimationToPosition(t,e,o)}else console.log("[ANIMATION] Using RELATIVE positioning for RIGHT swap (no target)"),this.blockAnimator.startSwapAnimation(t,e,"right");break;case h.EXPLODING:if(s!==h.EXPLODING){this.blockAnimator.startExplosionAnimation(t,e,i);const o=Math.max(0,v.MATCH_BLINK_TICKS+v.MATCH_LANDED_TICKS-this.ROTATE_SAFETY_TICKS),r=Math.max(0,o-(t.explosionTimer||0));this.pendingMatchRotations.set(t,r)}break;case h.NORMAL:s===h.FLOATING&&this.blockAnimator.stopBlockAnimations(t);break}}handleOngoingAnimations(t,e,i,s){switch(t.falling&&this.blockAnimator.getAnimationState(t)?.isFalling,s){case h.FLOATING:this.blockAnimator.getAnimationState(t)?.isFloating||this.blockAnimator.startFloatAnimation(t,e);break;case h.EXPLODING:break}}updateStackAnimations(){}updatePendingMatchRotations(){if(this.pendingMatchRotations.size===0)return;const t=[];this.pendingMatchRotations.forEach((e,i)=>{const s=e-1,n=Math.max(0,s);this.pendingMatchRotations.set(i,n),n===0&&t.push(i)});for(const e of t){const i=this.blockMeshMap.get(e);if(i&&!(i.userData&&i.userData.matchRotated)&&!this.flipStarted.has(e)){const s=Math.max(0,(e.explosionTicks||0)-(e.explosionTimer||0)),n=Math.max(4,Math.min(v.MATCH_ROTATE_TICKS,s-1));this.blockAnimator.startMatchRotation(e,i,n),this.pendingMatchRotations.delete(e),this.flipStarted.add(e)}}}hasFlipStarted(t){return this.flipStarted.has(t)}markFlipStarted(t){this.flipStarted.add(t)}getDebugInfo(){const t=[];return t.push(`AnimMgr: ${this.config.enableBlockAnimations?"ON":"OFF"}`),this.blockAnimator&&t.push(this.blockAnimator.getDebugInfo()),this.stackAnimator&&t.push(this.stackAnimator.getDebugInfo()),this.cursorAnimator&&t.push(this.cursorAnimator.getDebugInfo()),t.join(" | ")}updateConfig(t){this.config={...this.config,...t},!this.config.enableCursorAnimations&&this.cursorAnimator?(this.cursorAnimator.dispose(),this.cursorAnimator=null):this.config.enableCursorAnimations&&!this.cursorAnimator&&this.cursor&&(this.cursorAnimator=new Bt(this.cursor,this.tileSize))}dispose(){this.tweenSystem.clearAllTweens(),this.blockAnimator.dispose(),this.stackAnimator.dispose(),this.cursorAnimator?.dispose(),this.blockMeshMap.clear(),this.blockMaterialMap.clear(),this.lastBlockStates.clear()}}class re{constructor(t){this.assetLoader=t,this.spritesheet=null,this.canvasCache=new Map,this.textureCache=new Map}async initialize(){await this.loadSpritesheet(),this.generateAllSprites()}loadSpritesheet(){return new Promise((t,e)=>{const i=this.assetLoader.getTexture("spritesheet");if(!i){e(new Error("Spritesheet not found"));return}this.spritesheet=new Image,this.spritesheet.onload=()=>t(),this.spritesheet.onerror=e,this.spritesheet.src=i.image.src})}generateAllSprites(){if(!this.spritesheet)return;const t=32,e={purple:{x:96,y:0},yellow:{x:0,y:0},red:{x:128,y:0},cyan:{x:64,y:0},green:{x:32,y:0}},i={normal:{y:0},landed:{y:128},exploding:{y:160}};for(const[s]of Object.entries(A).filter(([n])=>isNaN(Number(n))))for(const[n]of Object.entries(h).filter(([o])=>isNaN(Number(o)))){const o=e[s.toLowerCase()],r=i[n.toLowerCase()]?.y;if(o&&r!==void 0){const c=`${s}-${n}`,d=this.createPixelPerfectSprite(o.x,r,t);if(d){this.canvasCache.set(c,d);const u=new Ht(d);u.magFilter=vt,u.minFilter=vt,u.wrapS=Gt,u.wrapT=Gt,u.flipY=!1,this.textureCache.set(c,u)}}}}createPixelPerfectSprite(t,e,i){if(!this.spritesheet)return null;const s=document.createElement("canvas");s.width=i,s.height=i;const n=s.getContext("2d");return n?(n.imageSmoothingEnabled=!1,n.drawImage(this.spritesheet,t,e,i,i,0,0,i,i),s):null}getTexture(t,e){const i=`${t}-${e}`;return this.textureCache.get(i)||null}getCanvas(t,e){const i=`${t}-${e}`;return this.canvasCache.get(i)||null}dispose(){for(const t of this.textureCache.values())t.dispose();this.textureCache.clear(),this.canvasCache.clear(),this.spritesheet=null}}const H=class H{constructor(t,e,i){this.visualEffectsManager=null,this.gridMesh=null,this.gridLines=[],this.blockMaterials=new Map,this.sideMaterials=new Map,this.blockMeshes=[],this.garbageMaterials=new Map,this.cursorMesh=null,this.cursorMaterial=null,this.blinkTimer=0,this.lastBoardState={score:0,chainCounter:1,tickMatched:0,tickComboSize:0,panic:!1},this.board=t,this.assetLoader=e,this.pixelPerfectRenderer=new re(e),this.blockTextureManager=e.getBlockTextureManager(),this.boardGroup=new pt,this.boardGroup.name="EnhancedBoardGroup",this.boardGroup.rotation.x=Nt.degToRad(-6),this.animationManager=new ae(t,{enableBlockAnimations:!0,enableStackAnimations:!0,enableCursorAnimations:!0,animationSpeed:1}),i&&this.animationManager.setCursor(i),this.blockGeometry=new Vt(M.BLOCK_WIDTH,M.BLOCK_HEIGHT,M.BLOCK_DEPTH),this.blockEdgesGeometry=new Ct(this.blockGeometry),this.rimMaterial=new Mt({color:16777215,transparent:!0,opacity:.25}),this.initializeBlockMaterials(),this.initializeGarbageMaterials(),this.initializeBlockMeshes(),this.createGridBackground(),this.createCursor(i),this.initializePixelPerfectSprites().then(()=>{this.initializeBlockMaterials()})}async initializePixelPerfectSprites(){try{await this.pixelPerfectRenderer.initialize(),console.log("Pixel-perfect sprite renderer initialized")}catch(t){console.warn("Failed to initialize pixel-perfect sprites:",t)}}initializeBlockMaterials(){const t=[A.RED,A.GREEN,A.CYAN,A.YELLOW,A.PURPLE],e=[h.NORMAL,h.MATCHED,h.EXPLODING];for(const i of t){for(const n of e){const o=A[i],r=n.toUpperCase(),c=`${o}-${r}`,d=this.blockTextureManager.getTexture(i,n);if(d){const u=new V({map:d,transparent:!0,opacity:1,emissive:0,side:ht});this.blockMaterials.set(c,u)}else{const u=gt[i],b=new V({color:u,transparent:!0,opacity:1,emissive:0});this.blockMaterials.set(c,b)}}const s=`SIDE-${A[i]}`;if(!this.sideMaterials.get(s)){const o=new w(gt[i]).clone().multiplyScalar(.6),r=new V({color:o,transparent:!0,opacity:1,emissive:0,side:ht});this.sideMaterials.set(s,r)}}}initializeBlockMaterialsFallback(){Object.entries(gt).forEach(([t,e])=>{const i=parseInt(t),s=new V({color:e,transparent:!0,opacity:1,emissive:0});this.blockMaterials.set(i.toString(),s)})}initializeGarbageMaterials(){Object.entries(Kt).forEach(([t,e])=>{const i=new V({color:e,transparent:!0,opacity:1,emissive:0});this.garbageMaterials.set(t,i)})}initializeBlockMeshes(){this.blockMeshes=[];for(let t=0;t<T.BOARD_HEIGHT;t++){this.blockMeshes[t]=[];for(let e=0;e<T.BOARD_WIDTH;e++){const i=new Y(this.blockGeometry),s=et(t,e),n=1-M.BLOCK_DEPTH/2;i.position.set(s.x,s.y,n),i.name=`Block_${t}_${e}`,i.visible=!1;const o=new kt(this.blockEdgesGeometry,this.rimMaterial);o.name=`BlockRim_${t}_${e}`,o.scale.set(1.001,1.001,1.001),i.add(o),this.blockMeshes[t][e]=i,this.boardGroup.add(i)}}}createGridBackground(){const t=new ft(H.BOARD_PIXEL_WIDTH,H.BOARD_PIXEL_HEIGHT),e=new it({color:2236962,transparent:!0,opacity:.3,wireframe:!1});this.gridMesh=new Y(t,e),this.gridMesh.name="GridBackground",this.gridMesh.position.z=0,this.boardGroup.add(this.gridMesh),this.createEnhancedGridLines()}createEnhancedGridLines(){const t=new Mt({color:4473924,transparent:!0,opacity:.5});for(let e=0;e<=T.BOARD_WIDTH;e++){const i=[],s=e*M.TILE_SIZE_X-L.BOARD_PIXEL_WIDTH/2-M.BLOCK_GAP/2;i.push(new g(s,-1346/2,.1)),i.push(new g(s,L.BOARD_PIXEL_HEIGHT/2,.1));const n=new _t().setFromPoints(i),o=new wt(n,t.clone());o.name=`VerticalLine_${e}`,this.gridLines.push(o),this.boardGroup.add(o)}for(let e=0;e<=T.TOP_ROW+1;e++){const i=[],s=e*M.TILE_SIZE_Y-L.BOARD_PIXEL_HEIGHT/2-M.BLOCK_GAP/2;i.push(new g(-698/2,s,.1)),i.push(new g(L.BOARD_PIXEL_WIDTH/2,s,.1));const n=new _t().setFromPoints(i),o=new wt(n,t.clone());o.name=`HorizontalLine_${e}`,this.gridLines.push(o),this.boardGroup.add(o)}}createCursor(t){if(!t)return;const e=se(),i=e.width,s=e.height,n=8,o=new Ct(new ft(i,s));this.cursorMaterial=new Mt({color:16777215,transparent:!0,opacity:.8,linewidth:n}),this.cursorMesh=new kt(o,this.cursorMaterial),this.cursorMesh.name="AnimatedCursor",this.cursorMesh.position.z=2,this.cursorMesh&&this.cursorMaterial&&this.animationManager.setCursorMesh(this.cursorMesh,this.cursorMaterial),this.cursorMesh&&this.boardGroup.add(this.cursorMesh)}setVisualEffectsManager(t){this.visualEffectsManager=t}tick(){this.blinkTimer++,this.animationManager.tick(),this.visualEffectsManager&&(this.visualEffectsManager.tick(),this.checkForGameEvents()),this.updateBlockVisuals(),this.updateStackRiseVisuals(),this.updateCursorFallback()}updateBlockVisuals(){for(let t=0;t<=T.TOP_ROW;t++)for(let e=0;e<T.BOARD_WIDTH;e++){const i=this.board.getTile(t,e),s=this.blockMeshes[t][e];i&&i.type===S.BLOCK&&i.block?this.updateBlockMesh(s,i.block,i,t,e):i&&i.type===S.GARBAGE&&i.garbageRef?this.updateGarbageMesh(s,i.garbageRef,i,t,e):(s.visible=!1,s.userData.registeredBlock&&(this.animationManager.unregisterBlockMesh(s.userData.registeredBlock),s.userData.registeredBlock=null),s.userData.matchRotated=!1,s.rotation.set(0,0,0),s.scale.set(1,1,1))}}updateBlockMesh(t,e,i,s,n){t.visible=!0;const o=A[e.color],r=v.MATCH_BLINK_TICKS;let c=e.state;e.state===h.EXPLODING&&(c=e.explosionTimer<=r?h.EXPLODING:h.MATCHED);const d=c.toUpperCase(),u=`${o}-${d}`,b=this.blockMaterials.get(u);if(b){const C=`SIDE-${o}`;let P=this.sideMaterials.get(C);if(!P){const bt=new w(gt[e.color]).clone().multiplyScalar(.6);P=new V({color:bt,transparent:!0,opacity:1,emissive:0,side:ht}),this.sideMaterials.set(C,P)}const I=[P,P,P,P,b,b];t.material=I,t.userData.registeredBlock!==e&&(t.userData.registeredBlock&&this.animationManager.unregisterBlockMesh(t.userData.registeredBlock),this.animationManager.registerBlockMesh(e,t,b),t.userData.registeredBlock=e,t.userData.matchRotated=!1,t.rotation.set(0,0,0),t.scale.set(1,1,1))}else{const C=this.blockMaterials.get(`${o}-NORMAL`);if(C){const P=`SIDE-${o}`,I=this.sideMaterials.get(P)||new V({color:3355443});t.material=[I,I,I,I,C,C]}}const N=et(s,n),R=N.x,y=N.y;if(e.state===h.SWAPPING_LEFT||e.state===h.SWAPPING_RIGHT?(t.userData.swapDebugLogged||(console.log(`[SWAP DEBUG] Row ${s}, Col ${n}:`),console.log(`  - Block color: ${A[e.color]}`),console.log(`  - Block state: ${e.state}`),console.log(`  - Mesh position before: x=${t.position.x.toFixed(2)}`),console.log(`  - Grid position: x=${R.toFixed(2)}`),console.log(`  - Has target position: ${!!e.swapTargetPosition}`),e.swapTargetPosition&&console.log(`  - Target position: x=${e.swapTargetPosition.x.toFixed(2)}`),t.userData.swapDebugLogged=!0),e.swapTargetPosition?console.log("  - PRESERVING mesh position for absolute animation"):(t.position.x=R,t.position.y=y,console.log("  - RESET mesh position for relative animation"))):this.isBlockAnimating(e)||(t.position.x=R,t.position.y=y,t.userData.swapDebugLogged=!1),e.state===h.EXPLODING){const P=Math.max(0,v.MATCH_BLINK_TICKS+v.MATCH_LANDED_TICKS-4);if(!(!!(t.userData&&t.userData.matchRotated)||this.animationManager.hasFlipStarted(e))&&e.explosionTimer>=P){const q=this.animationManager.blockAnimator;if(q){const bt=Math.max(0,(e.explosionTicks||0)-(e.explosionTimer||0)),zt=Math.max(4,Math.min(v.MATCH_ROTATE_TICKS,bt-1));q.startMatchRotation(e,t,zt),this.animationManager.markFlipStarted(e)}}}this.applyBlockStateFallbacks(t,e,i)}applyBlockStateFallbacks(t,e,i){if(this.isBlockAnimating(e))return;const s=Array.isArray(t.material)?t.material:[t.material];if(!s||s.length===0)return;t.scale.set(1,1,1),t.rotation.set(0,0,0),s.forEach(o=>{o&&(o.opacity=1)}),i.chain&&s.forEach(o=>{o&&(o.opacity=Math.min((o.opacity??1)+.2,1))}),e.state===h.MATCHED&&t.scale.set(Et.MATCHED_SCALE_X,Et.MATCHED_SCALE_Y,1);const n=o=>{s.forEach(r=>{r&&r.emissive&&r.emissive.setHex(o)})};t.position.y>H.BOARD_PIXEL_HEIGHT*.7&&Math.sin(this.blinkTimer*.5)>0?n(4456448):n(0)}isBlockAnimating(t){const e=this.animationManager.blockAnimator.getAnimationState(t);return!!(e?.isFalling||e?.isSwapping||e?.isExploding||e?.isFloating)}updateGarbageMesh(t,e,i,s,n){t.visible=!0;let o="NORMAL";e.type===st.GRAY&&(o="GRAY"),e.state===at.TRIGGERED?o="TRIGGERED":e.state===at.TRANSFORMING&&(o="TRANSFORMING");const r=this.garbageMaterials.get(o);r&&(t.material=r);const c=et(s,n),d=c.x,u=c.y;if(t.position.x=d,t.position.y=u,t.scale.set(1,1,1),t.rotation.z=0,e.state===at.TRANSFORMING){const b=1+Math.sin(this.blinkTimer*.3)*.1;t.scale.set(b,b,1)}if(e.state===at.TRIGGERED){const b=Math.sin(this.blinkTimer*.8)*.5+.5;r&&r.emissive.setRGB(b*.2,b*.1,0)}else r&&r.emissive.setHex(0)}updateStackRiseVisuals(){this.animationManager.animateBlockMeshesForStackRise(this.blockMeshes)}updateCursorFallback(){!this.cursorMesh||this.cursorMaterial}checkForGameEvents(){if(!this.visualEffectsManager)return;const t={score:this.board.score,chainCounter:this.board.getChainCounter(),tickMatched:this.board.tickMatched,tickComboSize:this.board.tickComboSize,panic:this.board.panic};t.tickMatched>0&&this.triggerMatchEffects(t),t.panic!==this.lastBoardState.panic&&(t.panic?this.visualEffectsManager.onSpecialEvent("panic_start"):this.visualEffectsManager.onSpecialEvent("panic_end")),this.checkForGarbageEvents(),this.lastBoardState={...t}}triggerMatchEffects(t){if(!this.visualEffectsManager)return;const e=[],i=[];for(let s=0;s<=T.TOP_ROW;s++)for(let n=0;n<T.BOARD_WIDTH;n++){const o=this.board.getTile(s,n);o&&o.type===S.BLOCK&&o.block&&(o.block.state===h.MATCHED||o.block.state===h.EXPLODING)&&(e.push(o.block),i.push(this.boardToWorldPosition(s,n)))}if(e.length>0){const s=t.score-this.lastBoardState.score,n={blocks:e,positions:i,isChain:t.chainCounter>1,chainLength:t.chainCounter,comboSize:t.tickComboSize,score:s>0?s:0};this.visualEffectsManager.onBlockMatch(n)}}checkForGarbageEvents(){if(!this.visualEffectsManager)return;this.board.getGarbageBlocks().forEach(e=>{if(e.state===at.TRANSFORMING&&this.visualEffectsManager){const i={position:this.boardToWorldPosition(e.y+e.height/2,e.x+e.width/2),size:e.width*e.height,type:"transform"};this.visualEffectsManager.onGarbageEvent(i)}})}triggerStackRise(t){this.animationManager.startStackRise(t)}triggerSwapFeedback(){this.animationManager.triggerSwapFeedback()}setPanicMode(t){if(this.animationManager.setPanicMode(t),this.gridMesh){const e=this.gridMesh.material;t?(e.color.setHex(4456448),e.opacity=.4):(e.color.setHex(2236962),e.opacity=.3)}}hasCriticalAnimations(){return this.animationManager.hasCriticalAnimations()}getBoardGroup(){return this.boardGroup}getBounds(){return{width:H.BOARD_PIXEL_WIDTH,height:H.BOARD_PIXEL_HEIGHT}}boardToWorldPosition(t,e){const i=et(t,e),s=i.x,n=i.y,o=this.boardGroup.position.clone();return o.x+=s,o.y+=n,o.z=1,o}getAnimationDebugInfo(){return this.animationManager.getDebugInfo()}dispose(){for(this.pixelPerfectRenderer.dispose(),this.visualEffectsManager&&this.visualEffectsManager.dispose(),this.animationManager.dispose(),this.blockGeometry.dispose(),this.blockEdgesGeometry.dispose(),this.cursorMesh?.geometry&&this.cursorMesh.geometry.dispose(),this.blockMaterials.forEach(t=>t.dispose()),this.blockMaterials.clear(),this.sideMaterials.forEach(t=>t.dispose()),this.sideMaterials.clear(),this.garbageMaterials.forEach(t=>t.dispose()),this.garbageMaterials.clear(),this.cursorMaterial&&this.cursorMaterial.dispose(),this.rimMaterial.dispose();this.boardGroup.children.length>0;){const t=this.boardGroup.children[0];this.boardGroup.remove(t),t instanceof Y?(t.geometry&&t.geometry.dispose(),t.material instanceof F&&t.material.dispose()):t instanceof wt&&(t.geometry&&t.geometry.dispose(),t.material instanceof F&&t.material.dispose())}this.blockMeshes=[],this.gridLines=[]}};H.TILE_SIZE=M.TILE_SIZE_Y,H.BOARD_PIXEL_WIDTH=L.BOARD_PIXEL_WIDTH,H.BOARD_PIXEL_HEIGHT=L.BOARD_PIXEL_HEIGHT;let mt=H;class le{constructor(t){this.mesh=null,this.active=!1,this.position=t?.position?.clone()||new g,this.velocity=t?.velocity?.clone()||new g,this.acceleration=t?.acceleration?.clone()||new g,this.color=t?.color?.clone()||new w(16777215),this.size=t?.size||4,this.lifetime=t?.lifetime||60,this.maxLifetime=this.lifetime,this.fadeOut=t?.fadeOut||!0,this.gravity=t?.gravity||!1}reset(t){this.position.copy(t.position),this.velocity.copy(t.velocity),this.acceleration.copy(t.acceleration||new g),this.color.copy(t.color),this.size=t.size,this.lifetime=t.lifetime,this.maxLifetime=this.lifetime,this.fadeOut=t.fadeOut!==!1,this.gravity=t.gravity||!1,this.active=!0,this.gravity&&(this.acceleration.y=-.5)}update(){if(!this.active)return!1;if(this.velocity.add(this.acceleration),this.position.add(this.velocity),this.lifetime--,this.mesh){if(this.mesh.position.copy(this.position),this.mesh.position.z=10,this.fadeOut&&this.mesh.material){const e=this.mesh.material,i=this.lifetime/this.maxLifetime;e.opacity=i}const t=Math.max(.1,this.lifetime/this.maxLifetime);this.mesh.scale.setScalar(t)}return this.lifetime<=0?(this.active=!1,!1):!0}setMesh(t){if(this.mesh=t,this.mesh.position.copy(this.position),this.mesh.position.z=10,this.mesh.material){const e=this.mesh.material;e.color.copy(this.color),e.transparent=!0,e.opacity=1}}dispose(){this.active=!1,this.mesh=null}}class ce{constructor(t=200){this.particles=[],this.availableParticles=[],this.activeParticles=[],this.particleMaterials=new Map,this.maxParticles=t,this.particleGeometry=new Xt(2,8);for(let e=0;e<t;e++){const i=new le;this.particles.push(i),this.availableParticles.push(i)}this.initializeMaterials()}initializeMaterials(){const t=new it({color:16777215,transparent:!0,opacity:1,side:ht,alphaTest:.1});this.particleMaterials.set("white",t),Object.entries({purple:10040012,yellow:16766720,red:16729156,cyan:49151,green:3329330}).forEach(([i,s])=>{const n=new it({color:s,transparent:!0,opacity:1,side:ht,alphaTest:.1});this.particleMaterials.set(i,n)})}getParticle(t){if(this.availableParticles.length===0)if(this.activeParticles.length>0){const i=this.activeParticles.shift();this.recycleParticle(i)}else return null;const e=this.availableParticles.pop();return e.reset(t),this.activeParticles.push(e),e}createParticleMesh(t,e){const i=this.getColorMaterialKey(t.color);let s=this.particleMaterials.get(i);s||(s=new it({color:t.color,transparent:!0,opacity:1,side:Tt}),this.particleMaterials.set(i,s));const n=new Y(this.particleGeometry,s.clone());return n.scale.setScalar(t.size/2),n.renderOrder=1e3,t.setMesh(n),e.add(n),n}getColorMaterialKey(t){return`#${t.getHexString()}`}update(){for(let t=this.activeParticles.length-1;t>=0;t--){const e=this.activeParticles[t];e.update()||(this.activeParticles.splice(t,1),this.recycleParticle(e))}}recycleParticle(t){t.mesh&&(t.mesh.visible=!1,t.mesh.parent?.remove(t.mesh),t.mesh.material instanceof F&&t.mesh.material.dispose()),t.dispose(),this.availableParticles.push(t)}getActiveCount(){return this.activeParticles.length}getAvailableCount(){return this.availableParticles.length}dispose(){this.activeParticles.forEach(t=>this.recycleParticle(t)),this.activeParticles=[],this.availableParticles=[],this.particles=[],this.particleGeometry.dispose(),this.particleMaterials.forEach(t=>t.dispose()),this.particleMaterials.clear()}}class he{constructor(t,e=200){this.scene=t,this.particlePool=new ce(e),this.effectsGroup=new pt,this.effectsGroup.name="ParticleEffects",t.add(this.effectsGroup)}createBlockExplosionParticles(t,e,i=8){const s=this.getBlockColor(e);console.log(`Creating ${i} explosion particles at`,t,"color:",s.getHexString());for(let n=0;n<i;n++){const o=n/i*Math.PI*2,r=2+Math.random()*3,c=new g(Math.cos(o)*r,Math.sin(o)*r+Math.random()*2,0),d=this.particlePool.getParticle({position:t.clone(),velocity:c,color:s,size:12+Math.random()*8,lifetime:30+Math.random()*20,gravity:!0,fadeOut:!0});d&&this.particlePool.createParticleMesh(d,this.effectsGroup)}}createMatchFlashParticles(t,e,i=12){const s=this.getBlockColor(e);s.multiplyScalar(1.5);for(let n=0;n<i;n++){const o=n/i*Math.PI*2,r=1+Math.random()*2,c=new g(Math.cos(o)*r,Math.sin(o)*r,0),d=this.particlePool.getParticle({position:t.clone(),velocity:c,color:s,size:3+Math.random()*2,lifetime:20+Math.random()*10,gravity:!1,fadeOut:!0});d&&this.particlePool.createParticleMesh(d,this.effectsGroup)}}createChainEffectParticles(t,e){const i=new w(16766720);i.lerp(new w(16729156),Math.min(e/10,1)),t.forEach(s=>{for(let n=0;n<6;n++){const o=Math.random()*Math.PI*2,r=1+Math.random()*2,c=new g(Math.cos(o)*r,Math.sin(o)*r+3,0),d=this.particlePool.getParticle({position:s.clone(),velocity:c,color:i.clone(),size:4+Math.random()*3,lifetime:40+Math.random()*20,gravity:!0,fadeOut:!0});d&&this.particlePool.createParticleMesh(d,this.effectsGroup)}})}getBlockColor(t){switch(t){case A.PURPLE:return new w(10040012);case A.YELLOW:return new w(16766720);case A.RED:return new w(16729156);case A.CYAN:return new w(49151);case A.GREEN:return new w(3329330);default:return new w(16777215)}}tick(){this.particlePool.update()}getDebugInfo(){return`Particles: ${this.particlePool.getActiveCount()}/${this.particlePool.getActiveCount()+this.particlePool.getAvailableCount()}`}dispose(){for(this.particlePool.dispose(),this.scene.remove(this.effectsGroup);this.effectsGroup.children.length>0;){const t=this.effectsGroup.children[0];this.effectsGroup.remove(t)}}}class ue{constructor(t){this.mesh=null,this.active=!1,this.position=t?.position?.clone()||new g,this.velocity=new g,this.text=t?.text||"",this.color=t?.color?.clone()||new w(16777215),this.fontSize=t?.fontSize||16,this.lifetime=t?.lifetime||90,this.maxLifetime=this.lifetime,this.fadeOut=t?.fadeOut!==!1,this.moveUp=t?.moveUp!==!1,this.scale=t?.scale||1,this.initialScale=this.scale,this.moveUp&&(this.velocity.y=1)}reset(t){this.position.copy(t.position),this.velocity.set(0,0,0),this.text=t.text,this.color.copy(t.color||new w(16777215)),this.fontSize=t.fontSize||16,this.lifetime=t.lifetime||90,this.maxLifetime=this.lifetime,this.fadeOut=t.fadeOut!==!1,this.moveUp=t.moveUp!==!1,this.scale=t.scale||1,this.initialScale=this.scale,this.active=!0,this.moveUp&&(this.velocity.y=1)}update(){if(!this.active)return!1;if(this.position.add(this.velocity),this.velocity.multiplyScalar(.98),this.lifetime--,this.mesh){if(this.mesh.position.copy(this.position),this.fadeOut&&this.mesh.material){const i=this.mesh.material,s=this.lifetime/this.maxLifetime;i.opacity=s}const t=this.lifetime/this.maxLifetime;let e=1;t>.8?e=1+(1-t)*2:t<.2&&(e=t*5),this.mesh.scale.setScalar(this.initialScale*e)}return this.lifetime<=0?(this.active=!1,!1):!0}setMesh(t){this.mesh=t,this.mesh.position.copy(this.position),this.mesh.position.z=20}dispose(){this.active=!1,this.mesh=null}}class de{constructor(t=50){this.popups=[],this.availablePopups=[],this.activePopups=[],this.textureCache=new Map,this.maxPopups=t,this.canvas=document.createElement("canvas"),this.canvas.width=256,this.canvas.height=64,this.context=this.canvas.getContext("2d");for(let e=0;e<t;e++){const i=new ue;this.popups.push(i),this.availablePopups.push(i)}}getPopup(t){if(this.availablePopups.length===0)if(this.activePopups.length>0){const i=this.activePopups.shift();this.recyclePopup(i)}else return null;const e=this.availablePopups.pop();return e.reset(t),this.activePopups.push(e),e}createPopupMesh(t,e){const i=`${t.text}_${t.fontSize}_${t.color.getHexString()}`;let s=this.textureCache.get(i);s||(s=this.createTextTexture(t.text,t.fontSize,t.color),this.textureCache.set(i,s));const n=new it({map:s,transparent:!0,opacity:1,side:Tt,alphaTest:.1}),o=s.image.width/s.image.height,r=t.fontSize*o*2,c=t.fontSize*2,d=new ft(r,c),u=new Y(d,n);return u.position.z=20,u.renderOrder=2e3,console.log(`Creating popup: "${t.text}" at position`,t.position,"size:",r,"x",c),t.setMesh(u),e.add(u),u}createTextTexture(t,e,i){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.font=`bold ${e}px Arial, sans-serif`,this.context.fillStyle=`#${i.getHexString()}`,this.context.textAlign="center",this.context.textBaseline="middle",this.context.strokeStyle="#000000",this.context.lineWidth=3,this.context.strokeText(t,this.canvas.width/2,this.canvas.height/2),this.context.fillText(t,this.canvas.width/2,this.canvas.height/2);const s=new Ht(this.canvas);return s.needsUpdate=!0,s}update(){for(let t=this.activePopups.length-1;t>=0;t--){const e=this.activePopups[t];e.update()||(this.activePopups.splice(t,1),this.recyclePopup(e))}}recyclePopup(t){t.mesh&&(t.mesh.visible=!1,t.mesh.parent?.remove(t.mesh),t.mesh.material instanceof F&&t.mesh.material.dispose(),t.mesh.geometry&&t.mesh.geometry.dispose()),t.dispose(),this.availablePopups.push(t)}getActiveCount(){return this.activePopups.length}getAvailableCount(){return this.availablePopups.length}dispose(){this.activePopups.forEach(t=>this.recyclePopup(t)),this.activePopups=[],this.availablePopups=[],this.popups=[],this.textureCache.forEach(t=>t.dispose()),this.textureCache.clear()}}class pe{constructor(t,e=50){this.scene=t,this.popupPool=new de(e),this.popupGroup=new pt,this.popupGroup.name="PopupEffects",t.add(this.popupGroup)}showChainPopup(t,e){const i=this.getChainColor(e),s=`${e}x CHAIN`,n=Math.min(32+e*4,48),o=this.popupPool.getPopup({position:t.clone().add(new g(0,40,0)),text:s,color:i,fontSize:n,lifetime:90+e*5,moveUp:!0,scale:1});o&&this.popupPool.createPopupMesh(o,this.popupGroup)}showComboPopup(t,e){const i=this.getComboColor(e),s=`${e} COMBO`,n=Math.min(30+e*2,42),o=this.popupPool.getPopup({position:t.clone().add(new g(0,20,0)),text:s,color:i,fontSize:n,lifetime:75+e*3,moveUp:!0,scale:1});o&&this.popupPool.createPopupMesh(o,this.popupGroup)}showScorePopup(t,e){const i=new w(16766720),s=`+${e}`,o=this.popupPool.getPopup({position:t.clone().add(new g(0,-20,0)),text:s,color:i,fontSize:24,lifetime:60,moveUp:!0,scale:1});o&&this.popupPool.createPopupMesh(o,this.popupGroup)}showSpecialEffectPopup(t,e,i){const s=i||new w(16729343),o=this.popupPool.getPopup({position:t.clone(),text:e,color:s,fontSize:36,lifetime:120,moveUp:!0,scale:1.5});o&&this.popupPool.createPopupMesh(o,this.popupGroup)}getChainColor(t){return t<=2?new w(65280):t<=4?new w(16776960):t<=6?new w(16746496):t<=8?new w(16729088):new w(16711935)}getComboColor(t){return t<=4?new w(65535):t<=8?new w(4521796):t<=12?new w(16777028):new w(16729156)}tick(){this.popupPool.update()}getDebugInfo(){return`Popups: ${this.popupPool.getActiveCount()}/${this.popupPool.getActiveCount()+this.popupPool.getAvailableCount()}`}dispose(){for(this.popupPool.dispose(),this.scene.remove(this.popupGroup);this.popupGroup.children.length>0;){const t=this.popupGroup.children[0];this.popupGroup.remove(t)}}}class fe{constructor(t){this.isShaking=!1,this.intensity=0,this.duration=0,this.frequency=10,this.dampening=.95,this.elapsedTime=0,this.originalDuration=0,this.shakeX=0,this.shakeY=0,this.phase=0,this.camera=t,this.originalPosition=t.position.clone()}startShake(t){this.isShaking&&t.intensity<=this.intensity||(this.intensity=t.intensity,this.duration=t.duration,this.originalDuration=t.duration,this.frequency=t.frequency||10,this.dampening=t.dampening||.95,this.elapsedTime=0,this.isShaking=!0,this.phase=0,this.isShaking||this.originalPosition.copy(this.camera.position))}update(){if(!this.isShaking)return;this.elapsedTime++,this.duration--;const t=this.intensity*Math.pow(this.dampening,this.elapsedTime/10);this.phase+=this.frequency*(1/60),this.shakeX=Math.sin(this.phase)*t,this.shakeY=Math.sin(this.phase*1.3)*t,this.shakeX+=(Math.random()-.5)*t*.5,this.shakeY+=(Math.random()-.5)*t*.5,this.camera.position.copy(this.originalPosition),this.camera.position.x+=this.shakeX,this.camera.position.y+=this.shakeY,this.duration<=0&&this.stopShake()}stopShake(){this.isShaking&&(this.isShaking=!1,this.intensity=0,this.duration=0,this.shakeX=0,this.shakeY=0,this.camera.position.copy(this.originalPosition))}updateCameraPosition(t){this.originalPosition.copy(t),this.isShaking||this.camera.position.copy(t)}isCurrentlyShaking(){return this.isShaking}getCurrentIntensity(){return this.isShaking?this.intensity:0}getDebugInfo(){return this.isShaking?`Shake: ${this.intensity.toFixed(1)} (${this.duration}t)`:"Shake: OFF"}}class me{constructor(t){this.queuedShakes=[],this.screenShake=new fe(t)}shakeForChain(t){if(t<2)return;let e,i;t<=3?(e=1,i=15):t<=5?(e=2,i=25):t<=7?(e=4,i=35):t<=10?(e=6,i=45):(e=8,i=60),this.screenShake.startShake({intensity:e,duration:i,frequency:12+t,dampening:.92})}shakeForCombo(t){if(t<4)return;let e,i;t<=6?(e=1.5,i=20):t<=10?(e=3,i=30):t<=15?(e=5,i=40):(e=7,i=50),this.screenShake.startShake({intensity:e,duration:i,frequency:8+t*.5,dampening:.94})}shakeForGarbageTransform(t){const e=Math.min(t*.5,4),i=Math.min(t*5,30);this.screenShake.startShake({intensity:e,duration:i,frequency:6,dampening:.96})}shakeForSpecialEvent(t,e){this.screenShake.startShake({intensity:t,duration:e,frequency:15,dampening:.9})}shakeForPanicMode(){this.screenShake.startShake({intensity:.5,duration:30,frequency:20,dampening:.98})}update(){if(this.screenShake.update(),this.queuedShakes.length>0&&!this.screenShake.isCurrentlyShaking()){const t=this.queuedShakes.shift();this.screenShake.startShake(t)}}queueShake(t){this.queuedShakes.push(t)}stopAllShakes(){this.screenShake.stopShake(),this.queuedShakes=[]}updateCameraPosition(t){this.screenShake.updateCameraPosition(t)}isShaking(){return this.screenShake.isCurrentlyShaking()}getDebugInfo(){return this.screenShake.getDebugInfo()}}class ge{constructor(t,e,i,s){this.isEnabled=!0,this.panicMode=!1,this.warningIndicators=[],this.warningMaterials=[],this.warningBlinkTimer=0,this.flashMeshes=[],this.flashTimer=0,this.scene=t,this.camera=e,this.board=i,this.config={enableParticles:!0,enablePopups:!0,enableScreenShake:!0,particleCount:200,maxPopups:50,...s},this.particleSystem=new he(t,this.config.particleCount),this.popupSystem=new pe(t,this.config.maxPopups),this.screenShakeManager=new me(e),this.initializeWarningSystem()}initializeWarningSystem(){const t=T.BOARD_WIDTH,e=32,i=T.TOP_ROW*e-(T.TOP_ROW+1)*e/2+e/2;for(let s=0;s<t;s++){const n=new ft(e*.8,e*.8),o=new it({color:16711680,transparent:!0,opacity:0,side:Tt}),r=new Y(n,o);r.position.set(s*e-t*e/2+e/2,i,.5),r.name=`WarningIndicator_${s}`,r.visible=!1,this.warningIndicators.push(r),this.warningMaterials.push(o),this.scene.add(r)}}onBlockMatch(t){if(!this.isEnabled)return;const{blocks:e,positions:i,isChain:s,chainLength:n,comboSize:o,score:r}=t;if(this.config.enableParticles&&e.length>0&&(e.forEach((c,d)=>{d<i.length&&(this.particleSystem.createBlockExplosionParticles(i[d],c.color,6+Math.min(e.length,4)),this.particleSystem.createMatchFlashParticles(i[d],c.color,8))}),s&&n&&n>1&&this.particleSystem.createChainEffectParticles(i,n)),this.config.enablePopups&&i.length>0){const c=this.calculateCenterPosition(i);s&&n&&n>1&&this.popupSystem.showChainPopup(c,n),o&&o>1&&this.popupSystem.showComboPopup(c.clone().add(new g(0,s?25:0,0)),o),r&&r>0&&this.popupSystem.showScorePopup(c.clone().add(new g(0,-15,0)),r)}this.config.enableScreenShake&&(s&&n&&n>1&&this.screenShakeManager.shakeForChain(n),o&&o>3&&this.screenShakeManager.shakeForCombo(o))}onGarbageEvent(t){if(!this.isEnabled)return;const{position:e,size:i,type:s}=t;if(s==="transform"&&this.config.enableScreenShake&&this.screenShakeManager.shakeForGarbageTransform(i),s==="transform"&&this.config.enableParticles){const n=Math.min(i*2,20);for(let o=0;o<n;o++){const r=o/n*Math.PI*2,c=1+Math.random()*2,d=new g(Math.cos(r)*c,Math.sin(r)*c+1,0),u=this.particleSystem.particlePool.getParticle({position:e.clone(),velocity:d,color:new w(8947848),size:4+Math.random()*2,lifetime:40+Math.random()*20,gravity:!0,fadeOut:!0});u&&this.particleSystem.particlePool.createParticleMesh(u,this.particleSystem.effectsGroup)}}}onSpecialEvent(t,e){if(this.isEnabled)switch(t){case"panic_start":this.setPanicMode(!0),this.config.enablePopups&&this.popupSystem.showSpecialEffectPopup(new g(0,50,0),"DANGER!",new w(16711680));break;case"panic_end":this.setPanicMode(!1);break;case"game_over":this.config.enablePopups&&this.popupSystem.showSpecialEffectPopup(new g(0,0,0),"GAME OVER",new w(16729156)),this.config.enableScreenShake&&this.screenShakeManager.shakeForSpecialEvent(5,60);break;case"level_up":this.config.enablePopups&&e?.level&&this.popupSystem.showSpecialEffectPopup(new g(0,20,0),`LEVEL ${e.level}`,new w(4521796));break}}updateWarningSystem(){this.warningBlinkTimer++;for(let t=0;t<T.BOARD_WIDTH;t++){const e=this.board.getTile(T.TOP_ROW,t),i=this.warningIndicators[t],s=this.warningMaterials[t];if(e&&e.type!==S.AIR){i.visible=!0;const n=Math.sin(this.warningBlinkTimer*.2)*.5+.5;s.opacity=.3+n*.4,this.panicMode?s.color.setHex(16711680):s.color.setHex(16729156)}else i.visible=!1}}triggerMatchFlash(t){this.flashTimer=8,t.forEach(e=>{const i=new Yt(20,25,16),s=new it({color:16777215,transparent:!0,opacity:.4,side:ht,blending:qt,alphaTest:.1}),n=new Y(i,s);n.position.copy(e),n.position.z=5,this.flashMeshes.push(n),this.scene.add(n)})}updateFlashEffects(){this.flashTimer>0&&(this.flashTimer--,this.flashMeshes.forEach(t=>{const e=t.material,i=this.flashTimer/8;e.opacity=i*.4;const s=1+(1-i)*1.5;t.scale.setScalar(s)}),this.flashTimer===0&&(this.flashMeshes.forEach(t=>{this.scene.remove(t),t.geometry&&t.geometry.dispose(),t.material instanceof F&&t.material.dispose()}),this.flashMeshes=[]))}calculateCenterPosition(t){const e=new g;return t.forEach(i=>e.add(i)),e.divideScalar(t.length),e}setPanicMode(t){this.panicMode=t,t&&this.config.enableScreenShake&&this.screenShakeManager.shakeForPanicMode()}tick(){this.isEnabled&&(this.particleSystem.tick(),this.popupSystem.tick(),this.screenShakeManager.update(),this.updateWarningSystem(),this.updateFlashEffects(),this.panicMode&&this.config.enableScreenShake&&(this.screenShakeManager.isShaking()||this.screenShakeManager.shakeForPanicMode()))}setEnabled(t){this.isEnabled=t,t||this.screenShakeManager.stopAllShakes()}updateConfig(t){this.config={...this.config,...t}}getDebugInfo(){const t=[];return t.push(`Effects: ${this.isEnabled?"ON":"OFF"}`),this.isEnabled&&(t.push(this.particleSystem.getDebugInfo()),t.push(this.popupSystem.getDebugInfo()),t.push(this.screenShakeManager.getDebugInfo()),this.panicMode&&t.push("PANIC")),t.join(" | ")}dispose(){this.particleSystem.dispose(),this.popupSystem.dispose(),this.screenShakeManager.stopAllShakes(),this.warningIndicators.forEach(t=>{this.scene.remove(t),t.geometry&&t.geometry.dispose()}),this.warningMaterials.forEach(t=>t.dispose()),this.warningIndicators=[],this.warningMaterials=[],this.flashMeshes.forEach(t=>{this.scene.remove(t),t.geometry&&t.geometry.dispose(),t.material instanceof F&&t.material.dispose()}),this.flashMeshes=[]}}class Se{constructor(t){this.WORLD_WIDTH=L.BOARD_PIXEL_WIDTH+200,this.WORLD_HEIGHT=L.BOARD_PIXEL_HEIGHT+100,this.board=null,this.boardRenderer=null,this.cursor=null,this.visualEffectsManager=null,this.audioSystem=null,this.scene=new jt,this.assetLoader=t;const e=this.WORLD_WIDTH/this.WORLD_HEIGHT,i=this.WORLD_HEIGHT;this.camera=new Qt(i*e/-2,i*e/2,i/2,i/-2,-1e3,1e3),this.camera.position.set(0,0,100),this.gameContainer=new pt,this.gameContainer.name="GameContainer",this.scene.add(this.gameContainer),this.uiContainer=new pt,this.uiContainer.name="UIContainer",this.uiContainer.position.z=10,this.scene.add(this.uiContainer)}initialize(){this.setupLighting(),this.initializeGameBoard(),console.log("SceneManager initialized with game board")}setupLighting(){const t=new Zt(16777215,.8);t.name="AmbientLight",this.scene.add(t);const e=new Jt(16777215,.4);e.position.set(100,100,100),e.name="DirectionalLight",this.scene.add(e)}initializeGameBoard(){this.board=new T(this.audioSystem||void 0),this.boardRenderer=new mt(this.board,this.assetLoader,this.cursor||void 0),this.visualEffectsManager=new ge(this.scene,this.camera,this.board,{enableParticles:!0,enablePopups:!0,enableScreenShake:!0,particleCount:200,maxPopups:50}),this.boardRenderer instanceof mt&&this.boardRenderer.setVisualEffectsManager(this.visualEffectsManager);const t=this.boardRenderer.getBoardGroup();t.position.set(-100,0,0),t.name="GameBoard",this.gameContainer.add(t)}tick(){this.board&&this.boardRenderer&&(this.board.tick(),this.boardRenderer.tick()),this.cursor&&this.cursor.tick()}render(t,e){t.render(this.scene,this.camera)}handleResize(t,e){const i=t/e,s=this.WORLD_HEIGHT;this.camera.left=s*i/-2,this.camera.right=s*i/2,this.camera.top=s/2,this.camera.bottom=s/-2,this.camera.updateProjectionMatrix(),console.log(`Scene resized to ${t}x${e}`)}getScene(){return this.scene}getCamera(){return this.camera}getGameContainer(){return this.gameContainer}getUIContainer(){return this.uiContainer}getBoard(){return this.board}getBoardRenderer(){return this.boardRenderer}setAudioSystem(t){this.audioSystem=t}setCursor(t){if(this.cursor){const e=this.boardRenderer?.getBoardGroup();e&&e.children.includes(this.cursor.getMesh())?e.remove(this.cursor.getMesh()):this.gameContainer.remove(this.cursor.getMesh()),this.cursor.dispose()}if(this.cursor=t,t){const e=this.boardRenderer?.getBoardGroup();e?e.add(t.getMesh()):this.gameContainer.add(t.getMesh())}}getCursor(){return this.cursor}getVisualEffectsManager(){return this.visualEffectsManager}dispose(){for(this.visualEffectsManager&&(this.visualEffectsManager.dispose(),this.visualEffectsManager=null),this.cursor&&(this.cursor.dispose(),this.cursor=null),this.boardRenderer&&(this.boardRenderer.dispose(),this.boardRenderer=null);this.scene.children.length>0;){const t=this.scene.children[0];this.scene.remove(t)}}}const J=class J{constructor(){this.logs=[],this.enabled=!0}static getInstance(){return J.instance||(J.instance=new J),J.instance}log(t,e){if(!this.enabled)return;const s=`[${new Date().toISOString().split("T")[1].substring(0,12)}] ${t}: ${e}`;this.logs.push(s),console.log(`üîç ${s}`),this.logs.length>100&&this.logs.shift(),this.updateDebugDisplay()}updateDebugDisplay(){const t=document.getElementById("inputDebugLog");if(t){const e=this.logs.slice(-10);t.innerHTML=e.join("<br>"),t.scrollTop=t.scrollHeight}}clear(){this.logs=[]}getLogs(){return[...this.logs]}setEnabled(t){this.enabled=t}};J.instance=null;let At=J;function _(a,t){At.getInstance().log(a,t)}var f=(a=>(a.UP="up",a.DOWN="down",a.LEFT="left",a.RIGHT="right",a.SWAP="swap",a.RAISE="raise",a.PAUSE="pause",a.DROP_GARBAGE="drop_garbage",a))(f||{}),G=(a=>(a.PRESSED="pressed",a.RELEASED="released",a.HELD="held",a))(G||{});class ye{constructor(){this.keyBindings=new Map([["ArrowUp","up"],["ArrowDown","down"],["ArrowLeft","left"],["ArrowRight","right"],["KeyX","swap"],["KeyZ","raise"],["Escape","pause"],["KeyQ","drop_garbage"],["KeyW","up"],["KeyS","down"],["KeyA","left"],["KeyD","right"]]),this.keyStates=new Map,this.actionStates=new Map,this.inputQueue=[],this.REPEAT_DELAY=250,this.REPEAT_RATE=100,this.enabled=!1,this.lastUpdateTime=0,_("InputManager","Constructor called"),Object.values(f).forEach(t=>{this.actionStates.set(t,this.createKeyState())}),this.boundKeyDown=this.handleKeyDown.bind(this),this.boundKeyUp=this.handleKeyUp.bind(this),this.enable(),_("InputManager",`Initialized with ${this.keyBindings.size} key bindings`)}createKeyState(){return{pressed:!1,justPressed:!1,justReleased:!1,pressTime:0,repeatCount:0}}enable(){if(this.enabled){_("InputManager","Already enabled, skipping addEventListener");return}this.enabled=!0,window.addEventListener("keydown",this.boundKeyDown),window.addEventListener("keyup",this.boundKeyUp),_("InputManager","Event listeners added successfully")}disable(){this.enabled&&(this.enabled=!1,window.removeEventListener("keydown",this.boundKeyDown),window.removeEventListener("keyup",this.boundKeyUp),this.clearStates())}handleKeyDown(t){if(_("InputManager",`KeyDown: ${t.code} (enabled=${this.enabled})`),!this.enabled){_("InputManager","Input disabled, ignoring keydown");return}const e=t.code,i=this.keyBindings.get(e);if(!i){_("InputManager",`No action mapped for key: ${e}`);return}_("InputManager",`Action found: ${i}`),t.preventDefault();const s=performance.now();let n=this.keyStates.get(e);n||(n=this.createKeyState(),this.keyStates.set(e,n)),n.pressed?t.repeat&&s-n.pressTime>=this.REPEAT_DELAY&&(n.repeatCount++,this.queueInputEvent(i,"held",s,!0)):(n.pressed=!0,n.justPressed=!0,n.pressTime=s,n.repeatCount=0,this.queueInputEvent(i,"pressed",s,!1));const o=this.actionStates.get(i);o&&(o.pressed||(o.pressed=!0,o.justPressed=!0,o.pressTime=s,o.repeatCount=0))}handleKeyUp(t){if(!this.enabled)return;const e=t.code,i=this.keyBindings.get(e);if(!i)return;t.preventDefault();const s=performance.now(),n=this.keyStates.get(e);n&&n.pressed&&(n.pressed=!1,n.justReleased=!0,this.queueInputEvent(i,"released",s,!1));const o=this.actionStates.get(i);o&&o.pressed&&(o.pressed=!1,o.justReleased=!0)}queueInputEvent(t,e,i,s){this.inputQueue.push({action:t,type:e,timestamp:i,repeat:s})}update(){const t=performance.now();this.lastUpdateTime=t,this.actionStates.forEach((e,i)=>{e.pressed&&!e.justPressed&&t-e.pressTime>=this.REPEAT_DELAY+e.repeatCount*this.REPEAT_RATE&&(e.repeatCount++,this.queueInputEvent(i,"held",t,!0)),e.justPressed=!1,e.justReleased=!1}),this.keyStates.forEach(e=>{e.justPressed=!1,e.justReleased=!1})}getInputEvents(){const t=[...this.inputQueue];return this.inputQueue.length=0,t}isPressed(t){return this.actionStates.get(t)?.pressed??!1}isJustPressed(t){return this.actionStates.get(t)?.justPressed??!1}isJustReleased(t){return this.actionStates.get(t)?.justReleased??!1}getHoldDuration(t){const e=this.actionStates.get(t);return!e||!e.pressed?0:this.lastUpdateTime-e.pressTime}setKeyBinding(t,e){this.keyBindings.set(t,e)}removeKeyBinding(t){this.keyBindings.delete(t)}getKeyBindings(){return new Map(this.keyBindings)}clearStates(){this.keyStates.clear(),this.actionStates.forEach(t=>{t.pressed=!1,t.justPressed=!1,t.justReleased=!1,t.pressTime=0,t.repeatCount=0}),this.inputQueue.length=0}reset(){this.clearStates()}isEnabled(){return this.enabled}getQueueSize(){return this.inputQueue.length}getDebugInfo(){const t=Array.from(this.actionStates.entries()).filter(([e,i])=>i.pressed).map(([e,i])=>e);return`Input: Queue(${this.inputQueue.length}) Pressed(${t.join(",")}) Enabled(${this.enabled})`}dispose(){this.disable(),this.clearStates(),this.keyBindings.clear(),this.actionStates.clear()}}var p=(a=>(a.LOADING="loading",a.TITLE_SCREEN="title_screen",a.MAIN_MENU="main_menu",a.OPTIONS_MENU="options_menu",a.GAME_COUNTDOWN="game_countdown",a.GAME_RUNNING="game_running",a.GAME_PAUSED="game_paused",a.GAME_OVER="game_over",a.DEMO="demo",a.TRANSITION="transition",a))(p||{}),m=(a=>(a.LOADING_COMPLETE="loading_complete",a.SHOW_MAIN_MENU="show_main_menu",a.START_GAME="start_game",a.SHOW_OPTIONS="show_options",a.SHOW_DEMO="show_demo",a.BACK_TO_TITLE="back_to_title",a.BACK_TO_MENU="back_to_menu",a.COUNTDOWN_COMPLETE="countdown_complete",a.PAUSE_GAME="pause_game",a.RESUME_GAME="resume_game",a.PLAYER_WON="player_won",a.PLAYER_LOST="player_lost",a.RESTART_GAME="restart_game",a.DEMO_TIMEOUT="demo_timeout",a.DEMO_EXIT="demo_exit",a))(m||{}),rt=(a=>(a.MAIN="main",a.PAUSE="pause",a.OPTIONS="options",a.GAME_OVER="game_over",a))(rt||{}),D=(a=>(a[a.THREE=3]="THREE",a[a.TWO=2]="TWO",a[a.ONE=1]="ONE",a[a.GO=0]="GO",a))(D||{}),E=(a=>(a.ENDLESS="endless",a.VS_AI="vs_ai",a.VS_HUMAN="vs_human",a.DEMO="demo",a))(E||{}),U=(a=>(a.NONE="none",a.SCORE="score",a.TIMER="timer",a.COUNTDOWN="countdown",a.PAUSE_MENU="pause_menu",a.GAME_OVER="game_over",a))(U||{});const St={loading:{allowedTransitions:["loading_complete"],showUI:[]},title_screen:{allowedTransitions:["show_main_menu","start_game","show_options","show_demo"],showUI:[]},main_menu:{allowedTransitions:["start_game","show_options","show_demo","back_to_title"],showUI:[]},options_menu:{allowedTransitions:["back_to_title","back_to_menu"],showUI:[]},game_countdown:{allowedTransitions:["countdown_complete","back_to_title"],requiresGameBoard:!0,showUI:["countdown","score"],isGameplayState:!0},game_running:{allowedTransitions:["pause_game","player_won","player_lost"],requiresGameBoard:!0,showUI:["score","timer"],isGameplayState:!0},game_paused:{allowedTransitions:["resume_game","restart_game","back_to_title"],requiresGameBoard:!0,showUI:["pause_menu","score"],isGameplayState:!0},game_over:{allowedTransitions:["restart_game","back_to_title"],requiresGameBoard:!0,showUI:["game_over","score"]},demo:{allowedTransitions:["demo_exit","back_to_title"],requiresGameBoard:!0,showUI:["score"],isGameplayState:!0},transition:{allowedTransitions:[],showUI:[]}};class j{static isGameplayState(t){return St[t].isGameplayState===!0}static requiresGameBoard(t){return St[t].requiresGameBoard===!0}static canTransition(t,e){return St[t].allowedTransitions.includes(e)}static getUIOverlays(t){return St[t].showUI||[]}static isMenuState(t){return["title_screen","main_menu","options_menu"].includes(t)}static isPausedState(t){return["game_paused","game_over"].includes(t)}}var Ut=(a=>(a.RUNNING="running",a.PAUSED="paused",a.GAME_OVER="game_over",a))(Ut||{});const z=class z{constructor(t,e,i){this.audioSystem=null,this.state="running",this.lastMoveTime=0,this.lastSwapTime=0,this.lastRaiseTime=0,this.moveHoldTicks=0,this.swapHoldTicks=0,this.raiseHoldTicks=0,this.totalSwaps=0,this.totalRaises=0,this.totalMoves=0,this.lastGarbageDropTime=0,_("GameController","Constructor called"),this.board=t,this.cursor=e,this.inputManager=new ye,this.audioSystem=i||null,_("GameController","GameController initialized")}tick(){if(this.state==="paused"){this.handlePauseInput();return}this.inputManager.update();const t=this.inputManager.getInputEvents();t.length>0&&(_("GameController",`Processing ${t.length} input events`),O.getInstance().onUserInput());for(const e of t)_("GameController",`Handling event: ${e.action} - ${e.type}`),this.handleInputEvent(e);this.handleContinuousInput(),this.updateTimingCounters()}handleInputEvent(t){switch(t.action){case f.PAUSE:t.type===G.PRESSED&&this.togglePause();break;case f.UP:t.type===G.PRESSED&&(this.handleCursorMove(0,1),this.resetMoveHold());break;case f.DOWN:t.type===G.PRESSED&&(this.handleCursorMove(0,-1),this.resetMoveHold());break;case f.LEFT:t.type===G.PRESSED&&(this.handleCursorMove(-1,0),this.resetMoveHold());break;case f.RIGHT:t.type===G.PRESSED&&(this.handleCursorMove(1,0),this.resetMoveHold());break;case f.SWAP:t.type===G.PRESSED&&(this.handleSwap(),this.resetSwapHold());break;case f.RAISE:t.type===G.PRESSED&&(this.handleRaise(),this.resetRaiseHold());break;case f.DROP_GARBAGE:if(t.type===G.PRESSED||t.type===G.HELD){const e=this.board.ticksRun;e-this.lastGarbageDropTime>=30&&(this.handleGarbageDrop(),this.lastGarbageDropTime=e)}break}}handleContinuousInput(){if((this.inputManager.isPressed(f.UP)||this.inputManager.isPressed(f.DOWN)||this.inputManager.isPressed(f.LEFT)||this.inputManager.isPressed(f.RIGHT))&&(this.moveHoldTicks++,this.moveHoldTicks>z.INPUT_TIMING.initialDelay&&this.moveHoldTicks%z.INPUT_TIMING.moveDelay===0)){let t=0,e=0;this.inputManager.isPressed(f.UP)&&(e=1),this.inputManager.isPressed(f.DOWN)&&(e=-1),this.inputManager.isPressed(f.LEFT)&&(t=-1),this.inputManager.isPressed(f.RIGHT)&&(t=1),this.handleCursorMove(t,e)}this.inputManager.isPressed(f.SWAP)&&(this.swapHoldTicks++,this.swapHoldTicks>z.INPUT_TIMING.initialDelay&&this.swapHoldTicks%z.INPUT_TIMING.swapDelay===0&&this.handleSwap()),this.inputManager.isPressed(f.RAISE)&&(this.raiseHoldTicks++,this.raiseHoldTicks>z.INPUT_TIMING.initialDelay&&this.raiseHoldTicks%z.INPUT_TIMING.raiseDelay===0&&this.handleRaise())}handleCursorMove(t,e){if(this.board.state!==k.RUNNING)return;this.cursor.move(t,e)&&(this.totalMoves++,this.audioSystem&&this.audioSystem.playSfx("cursor"))}handleSwap(){if(this.board.state!==k.RUNNING)return;const{x:t,y:e}=this.cursor.getTargetPosition(),i=this.board.getTile(e,t),s=this.board.getTile(e,t+1);if(!i||!s||i.type===S.GARBAGE||s.type===S.GARBAGE)return;const n=!!i.block&&(i.block.state===h.EXPLODING||i.block.state===h.MATCHED||i.block.state===h.SWAPPING_LEFT||i.block.state===h.SWAPPING_RIGHT),o=!!s.block&&(s.block.state===h.EXPLODING||s.block.state===h.MATCHED||s.block.state===h.SWAPPING_LEFT||s.block.state===h.SWAPPING_RIGHT);if(n||o)return;this.cursor.swap()&&(this.totalSwaps++,this.audioSystem&&this.audioSystem.playSfx("swap"))}handleRaise(){this.board.state===k.RUNNING&&(this.board.inputForceStackRaise(),this.totalRaises++)}handleGarbageDrop(){if(this.board.state!==k.RUNNING)return;const t=[st.NORMAL,st.GRAY],e=t[Math.floor(Math.random()*t.length)],i=Math.floor(Math.random()*4)+2,s=Math.random()<.3;this.board.queueGarbage(s,i,e)}handlePauseInput(){this.inputManager.update();const t=this.inputManager.getInputEvents();for(const e of t)if(e.action===f.PAUSE&&e.type===G.PRESSED){this.togglePause();break}}togglePause(){const t=O.getInstance(),e=t.getCurrentState();j.isGameplayState(e)&&(e===p.GAME_RUNNING?(t.requestTransition(m.PAUSE_GAME),this.state="paused",this.resetAllHoldCounters(),this.audioSystem&&this.audioSystem.playSfx("pause")):e===p.GAME_PAUSED&&(t.requestTransition(m.RESUME_GAME),this.state="running",this.audioSystem&&this.audioSystem.playSfx("pause")))}updateTimingCounters(){!this.inputManager.isPressed(f.UP)&&!this.inputManager.isPressed(f.DOWN)&&!this.inputManager.isPressed(f.LEFT)&&!this.inputManager.isPressed(f.RIGHT)&&(this.moveHoldTicks=0),this.inputManager.isPressed(f.SWAP)||(this.swapHoldTicks=0),this.inputManager.isPressed(f.RAISE)||(this.raiseHoldTicks=0)}resetMoveHold(){this.moveHoldTicks=0}resetSwapHold(){this.swapHoldTicks=0}resetRaiseHold(){this.raiseHoldTicks=0}resetAllHoldCounters(){this.moveHoldTicks=0,this.swapHoldTicks=0,this.raiseHoldTicks=0}isPaused(){return this.state==="paused"}pause(){this.state==="running"&&(this.state="paused",this.resetAllHoldCounters())}resume(){this.state==="paused"&&(this.state="running")}gameOver(){this.state="game_over",this.resetAllHoldCounters()}reset(){this.state="running",this.resetAllHoldCounters(),this.totalSwaps=0,this.totalRaises=0,this.totalMoves=0,this.inputManager.reset()}getInputManager(){return this.inputManager}setKeyBinding(t,e){this.inputManager.setKeyBinding(t,e)}getKeyBindings(){return this.inputManager.getKeyBindings()}updateCursorState(){switch(this.board.state){case k.COUNTDOWN:this.cursor.setPulseEnabled(!1),this.cursor.setVisible(!0);break;case k.RUNNING:this.cursor.setPulseEnabled(!0),this.cursor.setVisible(!0);break;case k.GAME_OVER:case k.WON:this.cursor.setPulseEnabled(!1),this.cursor.setVisible(!1);break}this.board.isPanic()?this.cursor.setColor(16729156):this.cursor.setColor(16777215)}getStats(){return{swaps:this.totalSwaps,raises:this.totalRaises,moves:this.totalMoves}}getDebugInfo(){const t=this.getStats();return`Controller: ${this.state} Swaps:${t.swaps} Raises:${t.raises} Moves:${t.moves}`}setDemoMode(t){}simulateInput(t){const e={action:t,type:G.PRESSED,timestamp:Date.now(),repeat:!1};this.handleInputEvent(e)}onGameModeEnded(t){}dispose(){this.inputManager.dispose(),this.resetAllHoldCounters()}};z.INPUT_TIMING={moveDelay:8,swapDelay:10,raiseDelay:6,initialDelay:15};let It=z;class Pt{constructor(t){this.board=null,this.gameController=null,this.startTime=0,this.gameStarted=!1,this.config=t}initialize(t,e){this.board=t,this.gameController=e,this.startTime=Date.now(),this.gameStarted=!1}start(){this.gameStarted=!0,this.startTime=Date.now(),this.onStart()}stop(){this.gameStarted=!1,this.onStop()}update(){!this.gameStarted||!this.board||!this.gameController||(this.updateProgression(),this.checkWinConditions(),this.onUpdate())}updateProgression(){if(!this.config.speedProgression||!this.board)return;const t=Date.now()-this.startTime,e=Math.min(1+t/6e4*this.config.speedProgression,this.config.maxSpeedMultiplier),i=Math.round(this.config.initialStackRaiseSpeed/e);this.board.setStackRaiseSpeed(Math.max(i,1))}checkWinConditions(){for(const t of this.config.winConditions);}getStats(){const t=this.gameStarted?Date.now()-this.startTime:0;return{mode:this.getMode(),elapsedTime:t,score:this.board?.getScore()||0,level:this.getCurrentLevel(),isActive:this.gameStarted}}getCurrentLevel(){const t=Date.now()-this.startTime;return Math.floor(t/6e4)+1}}const Dt={[E.ENDLESS]:{initialStackRaiseSpeed:10,speedProgression:.1,maxSpeedMultiplier:5,sendsGarbage:!1,trackScore:!0,trackHighScore:!0,winConditions:[]},[E.VS_AI]:{initialStackRaiseSpeed:15,speedProgression:.05,maxSpeedMultiplier:3,sendsGarbage:!0,aiConfig:{difficulty:"normal",decisionDelay:30,strategy:"chain_focused"},trackScore:!0,trackHighScore:!1,winConditions:["opponent_defeat"]},[E.VS_HUMAN]:{initialStackRaiseSpeed:20,speedProgression:.02,maxSpeedMultiplier:2,sendsGarbage:!0,trackScore:!0,trackHighScore:!1,winConditions:["opponent_defeat"]},[E.DEMO]:{initialStackRaiseSpeed:12,speedProgression:.05,maxSpeedMultiplier:3,sendsGarbage:!1,aiConfig:{difficulty:"normal",decisionDelay:20,strategy:"chain_focused"},trackScore:!1,trackHighScore:!1,winConditions:[]}};class Me extends Pt{constructor(){super(Dt[E.ENDLESS]),this.scoreThresholds=[1e4,25e3,5e4,1e5,2e5],this.currentThresholdIndex=0,this.highScore=0,this.loadHighScore()}getMode(){return E.ENDLESS}onStart(){console.log("EndlessMode: Starting Endless Mode"),this.currentThresholdIndex=0,this.board&&(this.board.setStackRaiseSpeed(this.config.initialStackRaiseSpeed),this.board.setAutoRaise(!0),this.board.setGarbageSpawningEnabled(!1)),console.log(`EndlessMode: Started with high score ${this.highScore}`)}onStop(){console.log("EndlessMode: Stopping Endless Mode"),this.board&&this.board.getScore()>this.highScore&&(this.highScore=this.board.getScore(),this.saveHighScore(),console.log(`EndlessMode: New high score! ${this.highScore}`))}onUpdate(){this.board&&(this.checkScoreThresholds(),this.board.isGameOver()&&this.handleGameOver())}checkScoreThresholds(){if(!this.board||this.currentThresholdIndex>=this.scoreThresholds.length)return;const t=this.board.getScore(),e=this.scoreThresholds[this.currentThresholdIndex];t>=e&&(this.onScoreThresholdReached(e),this.currentThresholdIndex++)}onScoreThresholdReached(t){console.log(`EndlessMode: Score threshold reached: ${t}`),this.increaseDifficulty()}increaseDifficulty(){if(!this.board)return;const t=this.board.getStackRaiseSpeed(),e=Math.max(1,Math.floor(t*.9));this.board.setStackRaiseSpeed(e),console.log(`EndlessMode: Difficulty increased, stack speed now ${e}`)}handleGameOver(){if(console.log("EndlessMode: Game Over"),!this.board)return;const t=this.board.getScore(),e=t>this.highScore;e&&(this.highScore=t,this.saveHighScore()),this.stop(),this.gameController&&this.gameController.onGameModeEnded({mode:E.ENDLESS,score:t,isHighScore:e,elapsedTime:Date.now()-this.startTime})}getCurrentLevel(){const t=Math.floor((Date.now()-this.startTime)/6e4)+1,e=this.currentThresholdIndex+1;return Math.max(t,e)}loadHighScore(){try{const t=localStorage.getItem("panelPop_highScore_endless");this.highScore=t?parseInt(t,10):0}catch(t){console.warn("EndlessMode: Failed to load high score:",t),this.highScore=0}}saveHighScore(){try{localStorage.setItem("panelPop_highScore_endless",this.highScore.toString())}catch(t){console.warn("EndlessMode: Failed to save high score:",t)}}getHighScore(){return this.highScore}getDetailedStats(){return{...this.getStats(),highScore:this.highScore,currentThreshold:this.currentThresholdIndex<this.scoreThresholds.length?this.scoreThresholds[this.currentThresholdIndex]:null,thresholdProgress:this.calculateThresholdProgress()}}calculateThresholdProgress(){if(!this.board||this.currentThresholdIndex>=this.scoreThresholds.length)return 1;const t=this.board.getScore(),e=this.scoreThresholds[this.currentThresholdIndex],i=this.currentThresholdIndex>0?this.scoreThresholds[this.currentThresholdIndex-1]:0,s=(t-i)/(e-i);return Math.min(Math.max(s,0),1)}}class Lt extends Pt{constructor(t){super(Dt[t]),this.player1Board=null,this.player2Board=null,this.isAIMode=!1,this.aiConfig=null,this.garbageQueue=new Map,this.matchWinner=null,this.aiDecisionTimer=0,this.aiLastAction="",this.isAIMode=t===E.VS_AI,this.isAIMode&&(this.aiConfig=this.config.aiConfig||null),this.garbageQueue.set("player1",[]),this.garbageQueue.set("player2",[])}getMode(){return this.isAIMode?E.VS_AI:E.VS_HUMAN}initializeVS(t,e,i){this.player1Board=t,this.player2Board=e,this.board=t,this.gameController=i,this.setupGarbageSending()}onStart(){if(console.log(`VSMode: Starting ${this.getMode()}`),!this.player1Board||!this.player2Board)throw new Error("VSMode: Both player boards must be initialized before starting");this.configureBoardForVS(this.player1Board,"player1"),this.configureBoardForVS(this.player2Board,"player2"),this.matchWinner=null,this.garbageQueue.get("player1")?.splice(0),this.garbageQueue.get("player2")?.splice(0),this.isAIMode&&this.aiConfig&&this.initializeAI(),console.log(`VSMode: Both boards configured for ${this.getMode()}`)}onStop(){console.log(`VSMode: Stopping ${this.getMode()}`),this.garbageQueue.get("player1")?.splice(0),this.garbageQueue.get("player2")?.splice(0)}onUpdate(){!this.player1Board||!this.player2Board||(this.processGarbageQueues(),this.isAIMode&&this.updateAI(),this.checkVSWinConditions())}configureBoardForVS(t,e){t.setStackRaiseSpeed(this.config.initialStackRaiseSpeed),t.setAutoRaise(!0),t.setGarbageSpawningEnabled(!0)}setupGarbageSending(){!this.player1Board||!this.player2Board||(this.player1Board.onChainComplete=(t,e)=>{this.onPlayerChainComplete("player1",t,e)},this.player2Board.onChainComplete=(t,e)=>{this.onPlayerChainComplete("player2",t,e)})}onPlayerChainComplete(t,e,i){const s=this.calculateGarbageToSend(e,i,t);if(s){const n=t==="player1"?"player2":"player1";this.queueGarbageForPlayer(n,s),console.log(`VSMode: ${t} sent garbage (${s.width}x${s.height}) to ${n}`)}}calculateGarbageToSend(t,e,i){if(t<2&&e<4)return null;const s=6;let n=1,o=st.NORMAL;return t>=2&&(n=Math.min(t-1,6)),e>=6&&(n+=Math.floor(e/6)),(t>=6||e>=10)&&(o=st.GRAY),{width:s,height:Math.min(n,8),type:o,sourcePlayer:i,chainLength:t,comboSize:e}}queueGarbageForPlayer(t,e){const i=this.garbageQueue.get(t);i&&i.push(e)}processGarbageQueues(){this.processPlayerGarbageQueue("player1",this.player1Board),this.processPlayerGarbageQueue("player2",this.player2Board)}processPlayerGarbageQueue(t,e){if(!e)return;const i=this.garbageQueue.get(t);if(!i||i.length===0)return;const s=i.shift();this.spawnGarbageOnBoard(e,s)}spawnGarbageOnBoard(t,e){const i=t.findGarbageSpawnRow(e.height);if(i===-1){console.warn("VSMode: Unable to spawn garbage - board full");return}const s=new Wt(0,i,e.width,e.height,e.type);t.addGarbageBlock(s)}checkVSWinConditions(){if(!this.player1Board||!this.player2Board||this.matchWinner)return;const t=this.player1Board.isGameOver(),e=this.player2Board.isGameOver();if(t&&e){const i=this.player1Board.getScore(),s=this.player2Board.getScore();this.matchWinner=i>s?"player1":s>i?"player2":null}else t?this.matchWinner="player2":e&&(this.matchWinner="player1");this.matchWinner!==null&&this.handleMatchEnd()}handleMatchEnd(){console.log(`VSMode: Match ended, winner: ${this.matchWinner||"TIE"}`),this.stop(),this.gameController&&this.gameController.onGameModeEnded({mode:this.getMode(),winner:this.matchWinner,player1Score:this.player1Board?.getScore()||0,player2Score:this.player2Board?.getScore()||0,elapsedTime:Date.now()-this.startTime})}initializeAI(){this.aiConfig&&(this.aiDecisionTimer=0,this.aiLastAction="",console.log(`VSMode: AI initialized with ${this.aiConfig.difficulty} difficulty`))}updateAI(){!this.aiConfig||!this.player2Board||(this.aiDecisionTimer++,this.aiDecisionTimer>=this.aiConfig.decisionDelay&&(this.makeAIDecision(),this.aiDecisionTimer=0))}makeAIDecision(){const t=["left","right","up","down","swap"],e=t[Math.floor(Math.random()*t.length)];this.aiLastAction=e}getVSStats(){return{mode:this.getMode(),elapsedTime:Date.now()-this.startTime,player1Score:this.player1Board?.getScore()||0,player2Score:this.player2Board?.getScore()||0,isActive:this.gameStarted,matchWinner:this.matchWinner,garbageQueueSizes:{player1:this.garbageQueue.get("player1")?.length||0,player2:this.garbageQueue.get("player2")?.length||0}}}}class yt extends Pt{constructor(){super(Dt[E.DEMO]),this.idleTimer=0,this.userInputDetected=!1,this.aiDecisionTimer=0,this.lastAIAction="",this.aiCursorX=2,this.aiCursorY=5,this.aiActionQueue=[],this.demoConfig={idleTimeout:600,maxDuration:12e4,interruptible:!0}}getMode(){return E.DEMO}checkIdleTimeout(t){return t>=this.demoConfig.idleTimeout}resetIdleTimer(){this.idleTimer=0,this.userInputDetected=!0}onStart(){this.userInputDetected=!1,this.idleTimer=0,this.aiDecisionTimer=0,this.lastAIAction="",this.aiCursorX=2,this.aiCursorY=5,this.aiActionQueue=[],this.board&&(this.board.setStackRaiseSpeed(this.config.initialStackRaiseSpeed),this.board.setAutoRaise(!0),this.board.setGarbageSpawningEnabled(!1),this.board.resetToStartingState()),this.gameController&&this.gameController.setDemoMode(!0),console.log("DemoMode: AI is now controlling the game")}onStop(){console.log("DemoMode: Stopping Demo Mode"),this.gameController&&this.gameController.setDemoMode(!1),this.aiActionQueue=[]}onUpdate(){if(!(!this.board||!this.gameController)){if(this.demoConfig.interruptible&&this.userInputDetected){console.log("DemoMode: User input detected, ending demo"),this.stop();return}if(Date.now()-this.startTime>this.demoConfig.maxDuration){console.log("DemoMode: Demo timeout reached"),this.stop();return}this.updateAI()}}updateAI(){!this.board||!this.gameController||!this.config.aiConfig||(this.aiDecisionTimer++,this.aiDecisionTimer>=this.config.aiConfig.decisionDelay&&(this.makeAIDecision(),this.aiDecisionTimer=0),this.executeQueuedActions())}makeAIDecision(){if(!this.board)return;const t=this.analyzeBoard(),e=this.chooseAction(t);e&&(this.queueAIAction(e),this.lastAIAction=e.toString())}analyzeBoard(){return this.board?{hasMatches:this.board.hasActiveMatches(),hasFloatingBlocks:this.board.hasFloatingBlocks(),canMakeMatch:this.findPossibleMatches().length>0,riskLevel:this.calculateRiskLevel()}:{hasMatches:!1,hasFloatingBlocks:!1,canMakeMatch:!1,riskLevel:0}}chooseAction(t){if(t.hasMatches||t.hasFloatingBlocks)return null;const e=this.findBestMatchOpportunity();return e?this.getActionToReachPosition(e.x,e.y):this.getExplorationAction()}findPossibleMatches(){const t=[];if(!this.board)return t;for(let e=0;e<12;e++)for(let i=0;i<5;i++)this.canCreateMatchAtPosition(i,e)&&t.push({x:i,y:e,priority:this.calculateMatchPriority(i,e)});return t.sort((e,i)=>i.priority-e.priority),t}findBestMatchOpportunity(){const t=this.findPossibleMatches();return t.length>0?t[0]:null}canCreateMatchAtPosition(t,e){return Math.random()<.3}calculateMatchPriority(t,e){let i=(12-e)*10;return i+=Math.random()*20,i}getActionToReachPosition(t,e){const i=t-this.aiCursorX,s=e-this.aiCursorY;if(Math.abs(i)>Math.abs(s)){if(i>0)return this.aiCursorX=Math.min(this.aiCursorX+1,4),f.RIGHT;if(i<0)return this.aiCursorX=Math.max(this.aiCursorX-1,0),f.LEFT}else{if(s>0)return this.aiCursorY=Math.min(this.aiCursorY+1,11),f.DOWN;if(s<0)return this.aiCursorY=Math.max(this.aiCursorY-1,0),f.UP}return f.SWAP}getExplorationAction(){const t=[f.UP,f.DOWN,f.LEFT,f.RIGHT,f.SWAP],e=[2,2,2,2,1],i=e.reduce((o,r)=>o+r,0),s=Math.random()*i;let n=0;for(let o=0;o<t.length;o++)if(n+=e[o],s<=n)return this.updateAICursorPosition(t[o]),t[o];return f.SWAP}updateAICursorPosition(t){switch(t){case f.LEFT:this.aiCursorX=Math.max(this.aiCursorX-1,0);break;case f.RIGHT:this.aiCursorX=Math.min(this.aiCursorX+1,4);break;case f.UP:this.aiCursorY=Math.max(this.aiCursorY-1,0);break;case f.DOWN:this.aiCursorY=Math.min(this.aiCursorY+1,11);break}}calculateRiskLevel(){if(!this.board)return 0;const t=this.board.getHighestOccupiedRow();return Math.max(0,(12-t)/12)}queueAIAction(t){this.aiActionQueue.push(t)}executeQueuedActions(){if(this.aiActionQueue.length===0||!this.gameController)return;const t=this.aiActionQueue.shift();this.gameController.simulateInput(t)}getDemoStats(){return{mode:this.getMode(),elapsedTime:Date.now()-this.startTime,score:this.board?.getScore()||0,level:this.getCurrentLevel(),isActive:this.gameStarted,aiCursorPosition:{x:this.aiCursorX,y:this.aiCursorY},lastAIAction:this.lastAIAction,queuedActions:this.aiActionQueue.length}}}const K=class K{constructor(){this.currentMode=null,this.board=null,this.gameController=null,this.idleTickCounter=0,this.player1Board=null,this.player2Board=null}static getInstance(){return K.instance||(K.instance=new K),K.instance}static resetInstance(){K.instance=null}initialize(t,e){this.board=t,this.gameController=e,this.idleTickCounter=0}startMode(t){if(this.currentMode&&this.stopCurrentMode(),this.currentMode=this.createModeInstance(t),!this.currentMode){console.error(`GameModeManager: Failed to create mode ${t}`);return}this.isVSMode(t)?this.initializeVSMode(t):this.initializeSinglePlayerMode(),this.currentMode.start(),this.idleTickCounter=0}stopCurrentMode(){this.currentMode&&(this.currentMode.stop(),this.currentMode=null),this.idleTickCounter=0}update(){this.currentMode&&this.currentMode.update(),this.updateIdleTracking()}onUserInput(){this.idleTickCounter=0,this.currentMode instanceof yt&&this.currentMode.resetIdleTimer()}getCurrentMode(){return this.currentMode}getCurrentModeType(){return this.currentMode?.getMode()||null}isInMode(t){return this.currentMode?.getMode()===t}createModeInstance(t){switch(t){case E.ENDLESS:return new Me;case E.VS_AI:return new Lt(E.VS_AI);case E.VS_HUMAN:return new Lt(E.VS_HUMAN);case E.DEMO:return new yt;default:return console.error(`GameModeManager: Unknown game mode ${t}`),null}}initializeVSMode(t){if(!this.gameController)throw new Error("GameModeManager: GameController required for VS mode");this.player2Board||(this.player2Board=new T),this.player1Board=this.board;const e=this.currentMode;e&&this.player1Board&&this.player2Board&&e.initializeVS(this.player1Board,this.player2Board,this.gameController)}initializeSinglePlayerMode(){if(!this.board||!this.gameController||!this.currentMode)throw new Error("GameModeManager: Board and GameController required");this.currentMode.initialize(this.board,this.gameController)}isVSMode(t){return t===E.VS_AI||t===E.VS_HUMAN}updateIdleTracking(){this.currentMode instanceof yt||(this.idleTickCounter++,this.shouldStartDemoMode()&&this.startMode(E.DEMO))}shouldStartDemoMode(){return this.currentMode&&this.currentMode.getMode()!==E.ENDLESS?!1:new yt().checkIdleTimeout(this.idleTickCounter)}setupDualBoardRendering(t){this.isVSMode(this.getCurrentModeType()||E.ENDLESS)}getCurrentModeStats(){return this.currentMode?this.currentMode.getStats():null}isAnyModeActive(){return this.currentMode!==null}forceEndCurrentGame(){this.currentMode&&this.stopCurrentMode()}getIdleTickCounter(){return this.idleTickCounter}resetIdleCounter(){this.idleTickCounter=0}};K.instance=null;let ct=K;const X=class X{constructor(){this.currentState=p.LOADING,this.previousState=p.LOADING,this.transitionInProgress=!1,this.stateData={},this.currentGameMode=E.ENDLESS,this.stateChangeListeners=[],this.eventListeners=[],this.board=null,this.gameController=null,this.audioSystem=null,this.activeUIOverlays=new Set,this.currentMenu=null,this.countdownState=D.THREE,this.countdownTicks=0,this.COUNTDOWN_DURATION=188,this.demoTimeoutTicks=0,this.DEMO_TIMEOUT=600,this.ENABLE_TITLE_AUTO_DEMO=!1,this.activeUIOverlays.clear(),j.getUIOverlays(this.currentState).forEach(e=>this.activeUIOverlays.add(e))}static getInstance(){return X.instance||(X.instance=new X),X.instance}static resetInstance(){X.instance=null}initialize(t,e,i){this.board=t,this.gameController=e,this.audioSystem=i||null,ct.getInstance().initialize(t,e)}initializeUI(){this.updateUIOverlays(),this.currentState!==p.LOADING&&this.notifyStateChange(p.LOADING,this.currentState)}tick(){switch(ct.getInstance().update(),this.currentState){case p.TITLE_SCREEN:this.tickTitleScreen();break;case p.GAME_COUNTDOWN:this.tickCountdown();break;case p.GAME_RUNNING:this.tickGameRunning();break;case p.DEMO:break}this.updateStateData()}requestTransition(t,e){return this.transitionInProgress?(console.warn("Transition already in progress, ignoring request:",t),!1):j.canTransition(this.currentState,t)?this.executeTransition(t,e):(console.warn(`Invalid transition ${t} from state ${this.currentState}`),!1)}executeTransition(t,e){const i=this.currentState,s=this.getNextState(t);return s?(this.transitionInProgress=!0,this.emitEvent({type:"transitionStart",data:{oldState:i,newState:s,transition:t,stateData:e||void 0}}),e&&(this.stateData={...this.stateData,...e}),this.exitState(i),this.previousState=i,this.currentState=s,this.enterState(s),this.handleMusicTransition(i,s),this.updateUIOverlays(),this.notifyStateChange(i,s),this.transitionInProgress=!1,this.emitEvent({type:"transitionComplete",data:{oldState:i,newState:s,transition:t,stateData:this.stateData}}),!0):(console.warn("No target state defined for transition:",t),!1)}getNextState(t){switch(t){case m.LOADING_COMPLETE:return p.TITLE_SCREEN;case m.SHOW_MAIN_MENU:return p.MAIN_MENU;case m.START_GAME:return p.GAME_COUNTDOWN;case m.SHOW_OPTIONS:return p.OPTIONS_MENU;case m.SHOW_DEMO:return p.DEMO;case m.BACK_TO_TITLE:return p.TITLE_SCREEN;case m.BACK_TO_MENU:return p.MAIN_MENU;case m.COUNTDOWN_COMPLETE:return p.GAME_RUNNING;case m.PAUSE_GAME:return p.GAME_PAUSED;case m.RESUME_GAME:return p.GAME_RUNNING;case m.PLAYER_WON:case m.PLAYER_LOST:return p.GAME_OVER;case m.RESTART_GAME:return p.GAME_COUNTDOWN;case m.DEMO_TIMEOUT:case m.DEMO_EXIT:return p.TITLE_SCREEN;default:return null}}enterState(t){switch(t){case p.TITLE_SCREEN:this.currentMenu=rt.MAIN,this.demoTimeoutTicks=0;break;case p.MAIN_MENU:this.currentMenu=rt.MAIN;break;case p.GAME_COUNTDOWN:this.countdownState=D.THREE,this.countdownTicks=0,this.initializeGameBoard();break;case p.GAME_RUNNING:this.startGame();break;case p.GAME_PAUSED:this.currentMenu=rt.PAUSE,this.pauseGame();break;case p.GAME_OVER:this.currentMenu=rt.GAME_OVER,this.endGame();break;case p.OPTIONS_MENU:this.currentMenu=rt.OPTIONS;break;case p.DEMO:this.startDemo();break}}exitState(t){switch(t){case p.GAME_PAUSED:this.resumeGame();break;case p.DEMO:this.stopDemo();break}(j.isMenuState(t)||j.isPausedState(t))&&(this.currentMenu=null)}updateUIOverlays(){this.activeUIOverlays.clear(),j.getUIOverlays(this.currentState).forEach(e=>this.activeUIOverlays.add(e)),this.emitEvent({type:"uiUpdate",data:{uiOverlays:Array.from(this.activeUIOverlays)}})}tickTitleScreen(){this.ENABLE_TITLE_AUTO_DEMO&&(this.demoTimeoutTicks++,this.demoTimeoutTicks>=this.DEMO_TIMEOUT&&this.requestTransition(m.SHOW_DEMO))}tickCountdown(){this.countdownTicks++;const t=Math.floor(this.COUNTDOWN_DURATION/4),e=Math.floor(this.countdownTicks/t);if(e<4){const i=[D.THREE,D.TWO,D.ONE,D.GO][e];i!==this.countdownState&&(this.countdownState=i)}this.countdownTicks>=this.COUNTDOWN_DURATION&&this.requestTransition(m.COUNTDOWN_COMPLETE)}tickGameRunning(){this.board&&(this.board.state===k.GAME_OVER?this.requestTransition(m.PLAYER_LOST):this.board.state===k.WON&&this.requestTransition(m.PLAYER_WON,{playerWon:!0}))}initializeGameBoard(){if(!this.board)return;this.board.resetForNewGame(),ct.getInstance().startMode(this.currentGameMode),console.log(`Game board initialized for new game with mode: ${this.currentGameMode}`)}startGame(){!this.board||!this.gameController||(this.board.state=k.RUNNING,this.gameController.state=Ut.RUNNING,console.log("Game started"))}pauseGame(){this.gameController&&(this.gameController.pause(),console.log("Game paused"))}resumeGame(){this.gameController&&(this.gameController.resume(),console.log("Game resumed"))}endGame(){!this.board||!this.gameController||console.log("Game ended. Final score:",this.board.getScore())}startDemo(){this.board&&(this.initializeGameBoard(),console.log("Demo mode started"))}stopDemo(){console.log("Demo mode stopped")}updateStateData(){this.board&&(this.stateData.score=this.board.getScore())}notifyStateChange(t,e){this.stateChangeListeners.forEach((i,s)=>{try{i.onStateChange(t,e)}catch(n){console.error(`Error in state change listener ${s}:`,n)}}),this.emitEvent({type:"stateChange",data:{oldState:t,newState:e,stateData:this.stateData}})}emitEvent(t){this.eventListeners.forEach((e,i)=>{try{e(t)}catch(s){console.error(`Error in event listener ${i}:`,s)}})}handleMusicTransition(t,e){if(!(!this.audioSystem||!this.audioSystem.isReady()))switch(e){case p.TITLE_SCREEN:t===p.LOADING?this.audioSystem.playMusic("title_intro",1):this.audioSystem.playMusic("title_loop",1);break;case p.GAME_COUNTDOWN:this.audioSystem.crossfadeMusic("battle_normal",2);break;case p.GAME_RUNNING:t===p.GAME_PAUSED?this.audioSystem.resumeMusic():this.audioSystem.crossfadeMusic("battle_normal",2);break;case p.GAME_PAUSED:this.audioSystem.pauseMusic();break;case p.GAME_OVER:this.audioSystem.stopMusic(2);break}}getCurrentState(){return this.currentState}getPreviousState(){return this.previousState}getStateData(){return{...this.stateData}}getActiveUIOverlays(){return Array.from(this.activeUIOverlays)}getCurrentMenu(){return this.currentMenu}getCountdownState(){return this.countdownState}isTransitionInProgress(){return this.transitionInProgress}addStateChangeListener(t){this.stateChangeListeners.push(t)}removeStateChangeListener(t){const e=this.stateChangeListeners.indexOf(t);e>-1&&this.stateChangeListeners.splice(e,1)}addEventListener(t){this.eventListeners.push(t)}removeEventListener(t){const e=this.eventListeners.indexOf(t);e>-1&&this.eventListeners.splice(e,1)}setGameMode(t){this.currentGameMode=t}getCurrentGameMode(){return this.currentGameMode}onUserInput(){ct.getInstance().onUserInput(),this.currentState===p.TITLE_SCREEN&&(this.demoTimeoutTicks=0)}getDebugInfo(){return`State: ${this.currentState} | Previous: ${this.previousState} | Mode: ${this.currentGameMode} | Transitioning: ${this.transitionInProgress} | Menu: ${this.currentMenu||"none"}`}};X.instance=null;let O=X;var W=(a=>(a[a.BACKGROUND=100]="BACKGROUND",a[a.HUD=200]="HUD",a[a.MENU=300]="MENU",a[a.OVERLAY=400]="OVERLAY",a[a.MODAL=500]="MODAL",a))(W||{});class ot{constructor(t=W.HUD,e=!0){this.isVisible=!1,this.layer=t,e&&this.init()}init(){this.element||(this.element=this.createElement(),this.container=this.element,this.setupStyles(),this.setupEventListeners())}createContainer(){const t=document.createElement("div");return t.style.cssText=`
      position: fixed;
      pointer-events: auto;
      z-index: ${this.layer+1e3};
    `,t}setupStyles(){}setupEventListeners(){}show(){this.element.style.display="block",this.isVisible=!0,this.onShow()}hide(){this.element.style.display="none",this.isVisible=!1,this.onHide()}onShow(){}onHide(){}setPosition(t,e){this.element.style.left=`${t}px`,this.element.style.top=`${e}px`}setSize(t,e){this.element.style.width=`${t}px`,this.element.style.height=`${e}px`}centerHorizontally(){this.element.style.left="50%",this.element.style.transform="translateX(-50%)"}centerVertically(){this.element.style.top="50%",this.element.style.transform="translateY(-50%)"}center(){this.element.style.left="50%",this.element.style.top="50%",this.element.style.transform="translate(-50%, -50%)"}addClass(t){this.element.classList.add(t)}removeClass(t){this.element.classList.remove(t)}toggleClass(t){this.element.classList.toggle(t)}setOpacity(t){this.element.style.opacity=t.toString()}fadeIn(t=300){return new Promise(e=>{this.element.style.transition=`opacity ${t}ms ease`,this.element.style.opacity="1",setTimeout(e,t)})}fadeOut(t=300){return new Promise(e=>{this.element.style.transition=`opacity ${t}ms ease`,this.element.style.opacity="0",setTimeout(e,t)})}createTextElement(t,e){const i=document.createElement("div");return i.textContent=t,i.style.fontFamily="monospace",i.style.color="white",i.style.textAlign="center",i.style.userSelect="none",e&&Object.assign(i.style,e),i}createButton(t,e,i){const s=document.createElement("button");return s.textContent=t,s.onclick=e,s.style.fontFamily="monospace",s.style.backgroundColor="#333",s.style.color="white",s.style.border="2px solid #555",s.style.padding="10px 20px",s.style.cursor="pointer",s.style.fontSize="14px",s.style.transition="all 0.2s ease",s.onmouseenter=()=>{s.style.backgroundColor="#555",s.style.borderColor="#777"},s.onmouseleave=()=>{s.style.backgroundColor="#333",s.style.borderColor="#555"},i&&Object.assign(s.style,i),s}createStyledContainer(t){const e=document.createElement("div");if(e.style.position="relative",e.style.boxSizing="border-box",t)for(const[i,s]of Object.entries(t))s!=null&&(e.style[i]=String(s));return e}destroy(){this.element.remove(),this.isVisible=!1}}class Ee extends ot{constructor(){super(W.HUD),this.currentScore=0,this.currentChain=1,this.currentCombo=0,this.gameTime=0}createElement(){const t=this.createStyledContainer({position:"fixed",top:"20px",right:"20px",width:"200px",backgroundColor:"rgba(0, 0, 0, 0.7)",border:"2px solid #333",borderRadius:"8px",padding:"15px",fontFamily:"monospace",fontSize:"12px"}),e=this.createTextElement("SCORE",{fontSize:"16px",fontWeight:"bold",marginBottom:"10px",textAlign:"center",borderBottom:"1px solid #555",paddingBottom:"5px"});t.appendChild(e),this.scoreElement=this.createTextElement("0",{fontSize:"24px",fontWeight:"bold",color:"#f1c40f",textAlign:"center",marginBottom:"8px"}),t.appendChild(this.scoreElement);const i=this.createStyledContainer({display:"flex",justifyContent:"space-between",marginBottom:"5px"});i.appendChild(this.createTextElement("Chain:",{fontSize:"11px"})),this.chainElement=this.createTextElement("1",{fontSize:"11px",fontWeight:"bold",color:"#3498db"}),i.appendChild(this.chainElement),t.appendChild(i);const s=this.createStyledContainer({display:"flex",justifyContent:"space-between",marginBottom:"5px"});s.appendChild(this.createTextElement("Combo:",{fontSize:"11px"})),this.comboElement=this.createTextElement("0",{fontSize:"11px",fontWeight:"bold",color:"#e74c3c"}),s.appendChild(this.comboElement),t.appendChild(s);const n=this.createStyledContainer({display:"flex",justifyContent:"space-between",marginTop:"8px",paddingTop:"8px",borderTop:"1px solid #555"});return n.appendChild(this.createTextElement("Time:",{fontSize:"11px"})),this.timeElement=this.createTextElement("00:00",{fontSize:"11px",fontWeight:"bold",color:"#27ae60"}),n.appendChild(this.timeElement),t.appendChild(n),t}update(t){if(!this.isVisible)return;const e=O.getInstance(),i=t?.score??e.getStateData().score??0,s=t?.chain??1,n=t?.combo??0,o=t?.time??this.gameTime;i!==this.currentScore&&this.updateScore(i),s!==this.currentChain&&this.updateChain(s),n!==this.currentCombo&&this.updateCombo(n),this.updateTime(o),this.gameTime++}updateScore(t){const e=t-this.currentScore;this.currentScore=t;const i=t.toLocaleString();this.scoreElement.textContent=i,e>0&&e>=100&&this.animateScoreIncrease(e)}updateChain(t){this.currentChain=t,this.chainElement.textContent=t.toString(),t>=4?this.chainElement.style.color="#e74c3c":t>=2?this.chainElement.style.color="#f39c12":this.chainElement.style.color="#3498db",t>1&&this.animateChainIncrease()}updateCombo(t){this.currentCombo=t,this.comboElement.textContent=t.toString(),t>1&&this.animateCombo()}updateTime(t){const e=Math.floor(t/60),i=Math.floor(e/60),s=e%60,n=`${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;this.timeElement.textContent=n}animateScoreIncrease(t){const e=this.createTextElement(`+${t.toLocaleString()}`,{position:"absolute",top:"0px",right:"-50px",fontSize:"14px",fontWeight:"bold",color:"#f1c40f",pointerEvents:"none",zIndex:"1000"});this.element.appendChild(e);let i=0,s=1;const n=()=>{i-=2,s-=.05,e.style.top=`${i}px`,e.style.opacity=s.toString(),s>0?requestAnimationFrame(n):e.remove()};requestAnimationFrame(n)}animateChainIncrease(){this.chainElement.style.transform="scale(1.2)",this.chainElement.style.transition="transform 0.2s ease",setTimeout(()=>{this.chainElement.style.transform="scale(1)"},200)}animateCombo(){const t=this.comboElement.style.color;this.comboElement.style.color="#ffffff",this.comboElement.style.transition="color 0.1s ease",setTimeout(()=>{this.comboElement.style.color=t},100)}onShow(){this.gameTime=0,console.log("ScoreHUD shown")}onHide(){console.log("ScoreHUD hidden")}reset(){this.currentScore=0,this.currentChain=1,this.currentCombo=0,this.gameTime=0,this.scoreElement.textContent="0",this.chainElement.textContent="1",this.comboElement.textContent="0",this.timeElement.textContent="00:00",this.chainElement.style.color="#3498db"}}class Te extends ot{constructor(){super(W.OVERLAY),this.currentCountdownState=D.THREE}createElement(){const t=this.createStyledContainer({position:"fixed",top:"0",left:"0",width:"100%",height:"100%",display:"flex",justifyContent:"center",alignItems:"center",backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:W.OVERLAY.toString()});return this.countdownElement=this.createTextElement("3",{fontSize:"120px",fontWeight:"bold",color:"#f1c40f",textAlign:"center",textShadow:"4px 4px 8px rgba(0, 0, 0, 0.8)",userSelect:"none",fontFamily:"monospace"}),t.appendChild(this.countdownElement),t}setupStyles(){const t=document.createElement("style");t.textContent=`
      @keyframes countdownPulse {
        0% { transform: scale(0.5); opacity: 0; }
        50% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
      }
      
      @keyframes countdownExit {
        0% { transform: scale(1); opacity: 1; }
        100% { transform: scale(1.5); opacity: 0; }
      }
      
      @keyframes goAnimation {
        0% { 
          transform: scale(0.5); 
          opacity: 0; 
          color: #f1c40f;
        }
        30% { 
          transform: scale(1.3); 
          opacity: 1; 
          color: #e74c3c;
        }
        70% { 
          transform: scale(1.1); 
          opacity: 1; 
          color: #27ae60;
        }
        100% { 
          transform: scale(1.5); 
          opacity: 0; 
          color: #27ae60;
        }
      }
    `,document.head.appendChild(t)}update(t){if(!this.isVisible)return;const i=O.getInstance().getCountdownState();i!==this.currentCountdownState&&(this.updateCountdown(i),this.currentCountdownState=i)}updateCountdown(t){let e,i,s;switch(t){case D.THREE:e="3",i="#e74c3c",s="countdownPulse 0.5s ease-in-out";break;case D.TWO:e="2",i="#f39c12",s="countdownPulse 0.5s ease-in-out";break;case D.ONE:e="1",i="#f1c40f",s="countdownPulse 0.5s ease-in-out";break;case D.GO:e="GO!",i="#27ae60",s="goAnimation 1s ease-in-out",setTimeout(()=>{this.hide()},1e3);break}this.countdownElement.textContent=e,this.countdownElement.style.color=i,this.countdownElement.style.animation=s,this.playCountdownSound(t),console.log("Countdown:",e)}playCountdownSound(t){t===D.GO?console.log("Should play: go.wav"):console.log("Should play: countdown.wav")}onShow(){this.currentCountdownState=D.THREE,this.countdownElement.textContent="3",this.countdownElement.style.color="#e74c3c",this.countdownElement.style.animation="countdownPulse 0.5s ease-in-out",console.log("CountdownOverlay shown")}onHide(){console.log("CountdownOverlay hidden")}skipToGO(){this.updateCountdown(D.GO)}reset(){this.currentCountdownState=D.THREE,this.countdownElement.textContent="3",this.countdownElement.style.color="#e74c3c",this.countdownElement.style.animation="none"}}class be extends ot{constructor(){super(W.MENU,!1),this.selectedOption=0,this.menuOptions=[],this.setupMenuOptions(),this.init()}createElement(){const t=this.createStyledContainer({position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.8)",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"}),e=this.createTextElement("MAIN MENU",{fontSize:"36px",fontWeight:"bold",color:"#f1c40f",textAlign:"center",marginBottom:"40px",textShadow:"2px 2px 4px rgba(0, 0, 0, 0.8)"});t.appendChild(e),this.menuContainer=this.createStyledContainer({display:"flex",flexDirection:"column",alignItems:"center",gap:"20px"}),t.appendChild(this.menuContainer),this.createMenuItems();const i=this.createTextElement("Use Arrow Keys / WASD to navigate ‚Ä¢ Enter to select ‚Ä¢ Escape to go back",{position:"absolute",bottom:"40px",left:"50%",transform:"translateX(-50%)",fontSize:"12px",color:"#95a5a6",textAlign:"center"});return t.appendChild(i),t}setupMenuOptions(){const t=O.getInstance();this.menuOptions=[{text:"Endless Mode",action:()=>{t.setGameMode(E.ENDLESS),t.requestTransition(m.START_GAME)}},{text:"VS Computer",action:()=>{t.setGameMode(E.VS_AI),t.requestTransition(m.START_GAME)}},{text:"VS Human",action:()=>{t.setGameMode(E.VS_HUMAN),t.requestTransition(m.START_GAME)}},{text:"Options",action:()=>{t.requestTransition(m.SHOW_OPTIONS)}},{text:"Demo",action:()=>{t.setGameMode(E.DEMO),t.requestTransition(m.SHOW_DEMO)}},{text:"Back to Title",action:()=>{t.requestTransition(m.BACK_TO_TITLE)}}]}createMenuItems(){this.menuOptions.forEach((t,e)=>{const i=this.createMenuButton(t.text,t.action,e);this.menuContainer.appendChild(i)}),this.updateSelection()}createMenuButton(t,e,i){const s=this.createStyledContainer({padding:"15px 40px",backgroundColor:"transparent",border:"2px solid transparent",borderRadius:"8px",cursor:"pointer",transition:"all 0.3s ease",minWidth:"200px"}),n=this.createTextElement(t,{fontSize:"18px",fontWeight:"bold",color:"#ecf0f1",textAlign:"center",pointerEvents:"none"});return s.appendChild(n),s.onclick=()=>{this.selectedOption=i,this.updateSelection(),e()},s.onmouseenter=()=>{i!==this.selectedOption&&(s.style.backgroundColor="rgba(255, 255, 255, 0.1)")},s.onmouseleave=()=>{i!==this.selectedOption&&(s.style.backgroundColor="transparent")},s}setupEventListeners(){document.addEventListener("keydown",t=>{if(this.isVisible)switch(t.code){case"ArrowUp":case"KeyW":t.preventDefault(),this.selectedOption=(this.selectedOption-1+this.menuOptions.length)%this.menuOptions.length,this.updateSelection();break;case"ArrowDown":case"KeyS":t.preventDefault(),this.selectedOption=(this.selectedOption+1)%this.menuOptions.length,this.updateSelection();break;case"Enter":case"Space":t.preventDefault(),this.selectCurrentOption();break;case"Escape":t.preventDefault(),O.getInstance().requestTransition(m.BACK_TO_TITLE);break}})}updateSelection(){const t=this.menuContainer.children;for(let e=0;e<t.length;e++){const i=t[e],s=i.firstChild;e===this.selectedOption?(i.style.backgroundColor="rgba(241, 196, 15, 0.2)",i.style.borderColor="#f1c40f",i.style.transform="scale(1.05)",s.style.color="#f1c40f"):(i.style.backgroundColor="transparent",i.style.borderColor="transparent",i.style.transform="scale(1)",s.style.color="#ecf0f1")}}selectCurrentOption(){this.selectedOption>=0&&this.selectedOption<this.menuOptions.length&&this.menuOptions[this.selectedOption].action()}update(t){}onShow(){this.selectedOption=0,this.updateSelection(),console.log("MainMenu shown")}onHide(){console.log("MainMenu hidden")}setSelectedOption(t){t>=0&&t<this.menuOptions.length&&(this.selectedOption=t,this.updateSelection())}getSelectedOption(){return this.selectedOption}}class we extends ot{constructor(){super(W.OVERLAY),this.selectedOption=0,this.menuOptions=[],this.setupMenuOptions()}createElement(){const t=this.createStyledContainer({position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.7)",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"}),e=this.createTextElement("GAME PAUSED",{fontSize:"48px",fontWeight:"bold",color:"#e74c3c",textAlign:"center",marginBottom:"40px",textShadow:"3px 3px 6px rgba(0, 0, 0, 0.8)",letterSpacing:"2px"});t.appendChild(e),this.menuContainer=this.createStyledContainer({display:"flex",flexDirection:"column",alignItems:"center",gap:"15px",backgroundColor:"rgba(0, 0, 0, 0.8)",padding:"30px",borderRadius:"12px",border:"2px solid #34495e"}),t.appendChild(this.menuContainer),this.createMenuItems();const i=this.createTextElement("Arrow Keys to navigate ‚Ä¢ Enter to select ‚Ä¢ Escape to resume",{position:"absolute",bottom:"40px",left:"50%",transform:"translateX(-50%)",fontSize:"14px",color:"#95a5a6",textAlign:"center"});return t.appendChild(i),t}setupMenuOptions(){const t=O.getInstance();this.menuOptions=[{text:"Resume Game",action:()=>t.requestTransition(m.RESUME_GAME)},{text:"Restart Game",action:()=>t.requestTransition(m.RESTART_GAME)},{text:"Main Menu",action:()=>t.requestTransition(m.BACK_TO_TITLE)}]}createMenuItems(){this.menuOptions.forEach((t,e)=>{const i=this.createMenuButton(t.text,t.action,e);this.menuContainer.appendChild(i)}),this.updateSelection()}createMenuButton(t,e,i){const s=this.createStyledContainer({padding:"12px 30px",backgroundColor:"transparent",border:"2px solid transparent",borderRadius:"6px",cursor:"pointer",transition:"all 0.3s ease",minWidth:"180px"}),n=this.createTextElement(t,{fontSize:"16px",fontWeight:"bold",color:"#ecf0f1",textAlign:"center",pointerEvents:"none"});return s.appendChild(n),s.onclick=()=>{this.selectedOption=i,this.updateSelection(),e()},s}setupEventListeners(){document.addEventListener("keydown",t=>{if(this.isVisible)switch(t.code){case"ArrowUp":case"KeyW":t.preventDefault(),this.selectedOption=(this.selectedOption-1+this.menuOptions.length)%this.menuOptions.length,this.updateSelection();break;case"ArrowDown":case"KeyS":t.preventDefault(),this.selectedOption=(this.selectedOption+1)%this.menuOptions.length,this.updateSelection();break;case"Enter":case"Space":t.preventDefault(),this.selectCurrentOption();break;case"Escape":t.preventDefault(),O.getInstance().requestTransition(m.RESUME_GAME);break}})}updateSelection(){const t=this.menuContainer.children;for(let e=0;e<t.length;e++){const i=t[e],s=i.firstChild;e===this.selectedOption?(i.style.backgroundColor="rgba(52, 152, 219, 0.3)",i.style.borderColor="#3498db",i.style.transform="scale(1.05)",s.style.color="#3498db"):(i.style.backgroundColor="transparent",i.style.borderColor="transparent",i.style.transform="scale(1)",s.style.color="#ecf0f1")}}selectCurrentOption(){this.selectedOption>=0&&this.selectedOption<this.menuOptions.length&&this.menuOptions[this.selectedOption].action()}update(t){}onShow(){this.selectedOption=0,this.updateSelection(),this.menuContainer.style.transform="scale(0.8)",this.menuContainer.style.opacity="0",this.menuContainer.style.transition="all 0.3s ease",requestAnimationFrame(()=>{this.menuContainer.style.transform="scale(1)",this.menuContainer.style.opacity="1"}),console.log("PauseMenu shown")}onHide(){console.log("PauseMenu hidden")}showWithOption(t){this.selectedOption=Math.max(0,Math.min(t,this.menuOptions.length-1)),this.show()}}class Ce extends ot{constructor(){super(W.OVERLAY),this.selectedOption=0,this.menuOptions=[],this.isWin=!1,this.setupMenuOptions()}createElement(){const t=this.createStyledContainer({position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.8)",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"});this.titleElement=this.createTextElement("GAME OVER",{fontSize:"48px",fontWeight:"bold",color:"#e74c3c",textAlign:"center",marginBottom:"20px",textShadow:"3px 3px 6px rgba(0, 0, 0, 0.8)"}),t.appendChild(this.titleElement),this.scoreElement=this.createTextElement("Final Score: 0",{fontSize:"32px",fontWeight:"bold",color:"#f1c40f",textAlign:"center",marginBottom:"30px",textShadow:"2px 2px 4px rgba(0, 0, 0, 0.8)"}),t.appendChild(this.scoreElement),this.statsContainer=this.createStyledContainer({backgroundColor:"rgba(0, 0, 0, 0.6)",border:"2px solid #34495e",borderRadius:"10px",padding:"20px",marginBottom:"30px",minWidth:"300px"}),t.appendChild(this.statsContainer),this.menuContainer=this.createStyledContainer({display:"flex",flexDirection:"column",alignItems:"center",gap:"15px"}),t.appendChild(this.menuContainer),this.createMenuItems();const e=this.createTextElement("Arrow Keys to navigate ‚Ä¢ Enter to select",{position:"absolute",bottom:"40px",left:"50%",transform:"translateX(-50%)",fontSize:"14px",color:"#95a5a6",textAlign:"center"});return t.appendChild(e),t}setupMenuOptions(){const t=O.getInstance();this.menuOptions=[{text:"Play Again",action:()=>t.requestTransition(m.RESTART_GAME)},{text:"Main Menu",action:()=>t.requestTransition(m.BACK_TO_TITLE)}]}createMenuItems(){this.menuOptions.forEach((t,e)=>{const i=this.createMenuButton(t.text,t.action,e);this.menuContainer.appendChild(i)}),this.updateSelection()}createMenuButton(t,e,i){const s=this.createStyledContainer({padding:"12px 30px",backgroundColor:"transparent",border:"2px solid transparent",borderRadius:"6px",cursor:"pointer",transition:"all 0.3s ease",minWidth:"150px"}),n=this.createTextElement(t,{fontSize:"18px",fontWeight:"bold",color:"#ecf0f1",textAlign:"center",pointerEvents:"none"});return s.appendChild(n),s.onclick=()=>{this.selectedOption=i,this.updateSelection(),e()},s}updateStatsDisplay(t){this.statsContainer.innerHTML="";const e=this.createTextElement("Game Statistics",{fontSize:"18px",fontWeight:"bold",color:"#3498db",textAlign:"center",marginBottom:"15px",borderBottom:"1px solid #34495e",paddingBottom:"8px"});this.statsContainer.appendChild(e);const i=t.gameTime||0,s=Math.floor(i/3600),n=Math.floor(i%3600/60),o=`${s.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`;this.addStatLine("Time Played:",o);const r=t.highestChain||1;this.addStatLine("Highest Chain:",r.toString());const c=t.totalMatches||0;c>0&&this.addStatLine("Total Matches:",c.toString());const d=t.blocksCleared||0;d>0&&this.addStatLine("Blocks Cleared:",d.toString())}addStatLine(t,e){const i=this.createStyledContainer({display:"flex",justifyContent:"space-between",marginBottom:"8px"}),s=this.createTextElement(t,{fontSize:"14px",color:"#95a5a6"}),n=this.createTextElement(e,{fontSize:"14px",fontWeight:"bold",color:"#ecf0f1"});i.appendChild(s),i.appendChild(n),this.statsContainer.appendChild(i)}setupEventListeners(){document.addEventListener("keydown",t=>{if(this.isVisible)switch(t.code){case"ArrowUp":case"KeyW":t.preventDefault(),this.selectedOption=(this.selectedOption-1+this.menuOptions.length)%this.menuOptions.length,this.updateSelection();break;case"ArrowDown":case"KeyS":t.preventDefault(),this.selectedOption=(this.selectedOption+1)%this.menuOptions.length,this.updateSelection();break;case"Enter":case"Space":t.preventDefault(),this.selectCurrentOption();break}})}updateSelection(){const t=this.menuContainer.children;for(let e=0;e<t.length;e++){const i=t[e],s=i.firstChild;e===this.selectedOption?(i.style.backgroundColor=this.isWin?"rgba(39, 174, 96, 0.3)":"rgba(231, 76, 60, 0.3)",i.style.borderColor=this.isWin?"#27ae60":"#e74c3c",i.style.transform="scale(1.05)",s.style.color=this.isWin?"#27ae60":"#e74c3c"):(i.style.backgroundColor="transparent",i.style.borderColor="transparent",i.style.transform="scale(1)",s.style.color="#ecf0f1")}}selectCurrentOption(){this.selectedOption>=0&&this.selectedOption<this.menuOptions.length&&this.menuOptions[this.selectedOption].action()}update(t){if(!this.isVisible||!t)return;const e=t.score||0;this.scoreElement.textContent=`Final Score: ${e.toLocaleString()}`;const i=t.playerWon;i!==void 0&&i!==this.isWin&&(this.isWin=i,this.updateWinLoseDisplay()),this.updateStatsDisplay(t)}updateWinLoseDisplay(){this.isWin?(this.titleElement.textContent="VICTORY!",this.titleElement.style.color="#27ae60",this.element.style.background="linear-gradient(135deg, rgba(39, 174, 96, 0.3) 0%, rgba(0, 0, 0, 0.8) 100%)"):(this.titleElement.textContent="GAME OVER",this.titleElement.style.color="#e74c3c",this.element.style.background="linear-gradient(135deg, rgba(231, 76, 60, 0.3) 0%, rgba(0, 0, 0, 0.8) 100%)"),this.updateSelection()}onShow(){this.selectedOption=0,this.updateSelection(),this.element.style.opacity="0",this.element.style.transform="scale(0.9)",this.element.style.transition="all 0.4s ease",requestAnimationFrame(()=>{this.element.style.opacity="1",this.element.style.transform="scale(1)"}),console.log("GameOverScreen shown")}onHide(){console.log("GameOverScreen hidden")}setWinStatus(t){this.isWin=t,this.updateWinLoseDisplay()}}class ke extends ot{constructor(t){super(W.MENU,!1),this.selectedOption=0,this.options=[],this.optionElements=[],this.audioSystem=null,this.audioSystem=t||null,this.setupOptions(),this.init()}createElement(){const t=this.createStyledContainer({position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.8)",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"}),e=this.createTextElement("OPTIONS",{fontSize:"36px",fontWeight:"bold",color:"#3498db",textAlign:"center",marginBottom:"40px",textShadow:"2px 2px 4px rgba(0, 0, 0, 0.8)"});t.appendChild(e),this.menuContainer=this.createStyledContainer({backgroundColor:"rgba(0, 0, 0, 0.6)",border:"2px solid #34495e",borderRadius:"12px",padding:"30px",minWidth:"400px",maxHeight:"60vh",overflowY:"auto"}),t.appendChild(this.menuContainer),this.createOptionItems();const i=this.createTextElement("Arrow Keys to navigate ‚Ä¢ Left/Right to change ‚Ä¢ Enter to activate ‚Ä¢ Escape to go back",{position:"absolute",bottom:"40px",left:"50%",transform:"translateX(-50%)",fontSize:"12px",color:"#95a5a6",textAlign:"center",maxWidth:"80%"});return t.appendChild(i),t}setupOptions(){this.options=[{label:"Show Debug Info",type:"boolean",value:!1},{label:"Show FPS",type:"boolean",value:!0},{label:"Master Volume",type:"number",value:this.audioSystem?Math.round(this.audioSystem.getVolume("master")*100):80,min:0,max:100,step:10},{label:"Music Volume",type:"number",value:this.audioSystem?Math.round(this.audioSystem.getVolume("music")*100):80,min:0,max:100,step:10},{label:"Sound Effects Volume",type:"number",value:this.audioSystem?Math.round(this.audioSystem.getVolume("sfx")*100):80,min:0,max:100,step:10},{label:"Auto-raise Speed",type:"select",value:"Normal",options:["Slow","Normal","Fast","Fastest"]},{label:"Configure Controls",type:"action",action:()=>{console.log("Control configuration not implemented yet")}},{label:"Reset to Defaults",type:"action",action:()=>this.resetToDefaults()},{label:"Back to Title",type:"action",action:()=>O.getInstance().requestTransition(m.BACK_TO_TITLE)}]}createOptionItems(){this.options.forEach((t,e)=>{const i=this.createOptionElement(t,e);this.menuContainer.appendChild(i),this.optionElements.push(i)}),this.updateSelection()}createOptionElement(t,e){const i=this.createStyledContainer({display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 16px",marginBottom:"8px",backgroundColor:"transparent",border:"2px solid transparent",borderRadius:"6px",cursor:"pointer",transition:"all 0.3s ease"}),s=this.createTextElement(t.label,{fontSize:"16px",color:"#ecf0f1",flexGrow:"1"});i.appendChild(s);const n=this.createStyledContainer({display:"flex",alignItems:"center",gap:"10px"});switch(t.type){case"boolean":{const o=this.createToggle(t.value);n.appendChild(o);break}case"number":{const o=this.createNumberDisplay(t);n.appendChild(o);break}case"select":{const o=this.createSelectDisplay(t);n.appendChild(o);break}case"action":{const o=this.createTextElement("‚ñ∫",{fontSize:"16px",color:"#3498db",fontWeight:"bold"});n.appendChild(o);break}}return i.appendChild(n),i}createToggle(t){const e=this.createStyledContainer({width:"40px",height:"20px",backgroundColor:t?"#27ae60":"#7f8c8d",borderRadius:"10px",position:"relative",transition:"background-color 0.3s ease"}),i=this.createStyledContainer({width:"16px",height:"16px",backgroundColor:"white",borderRadius:"50%",position:"absolute",top:"2px",left:t?"22px":"2px",transition:"left 0.3s ease"});return e.appendChild(i),e}createNumberDisplay(t){const e=this.createStyledContainer({display:"flex",alignItems:"center",gap:"8px"}),i=this.createTextElement("‚óÑ",{fontSize:"12px",color:"#95a5a6",cursor:"pointer"}),s=this.createTextElement(t.value?.toString()||"0",{fontSize:"16px",color:"#3498db",fontWeight:"bold",minWidth:"40px",textAlign:"center"}),n=this.createTextElement("‚ñ∫",{fontSize:"12px",color:"#95a5a6",cursor:"pointer"});return e.appendChild(i),e.appendChild(s),e.appendChild(n),e}createSelectDisplay(t){const e=this.createStyledContainer({display:"flex",alignItems:"center",gap:"8px"}),i=this.createTextElement("‚óÑ",{fontSize:"12px",color:"#95a5a6"}),s=this.createTextElement(t.value?.toString()||"",{fontSize:"16px",color:"#3498db",fontWeight:"bold",minWidth:"80px",textAlign:"center"}),n=this.createTextElement("‚ñ∫",{fontSize:"12px",color:"#95a5a6"});return e.appendChild(i),e.appendChild(s),e.appendChild(n),e}setupEventListeners(){document.addEventListener("keydown",t=>{if(this.isVisible)switch(t.code){case"ArrowUp":case"KeyW":t.preventDefault(),this.selectedOption=(this.selectedOption-1+this.options.length)%this.options.length,this.updateSelection();break;case"ArrowDown":case"KeyS":t.preventDefault(),this.selectedOption=(this.selectedOption+1)%this.options.length,this.updateSelection();break;case"ArrowLeft":case"KeyA":t.preventDefault(),this.changeOptionValue(-1);break;case"ArrowRight":case"KeyD":t.preventDefault(),this.changeOptionValue(1);break;case"Enter":case"Space":t.preventDefault(),this.activateOption();break;case"Escape":t.preventDefault(),O.getInstance().requestTransition(m.BACK_TO_TITLE);break}})}updateSelection(){this.optionElements.forEach((t,e)=>{e===this.selectedOption?(t.style.backgroundColor="rgba(52, 152, 219, 0.3)",t.style.borderColor="#3498db",t.style.transform="translateX(5px)"):(t.style.backgroundColor="transparent",t.style.borderColor="transparent",t.style.transform="translateX(0)")})}changeOptionValue(t){const e=this.options[this.selectedOption];switch(e.type){case"boolean":{e.value=!e.value,this.updateOptionDisplay();break}case"number":{const i=e.value,s=e.step||1,n=e.min||0,o=e.max||100;let r=i+t*s;r=Math.max(n,Math.min(o,r)),e.value=r,this.updateOptionDisplay(),this.applyAudioSetting(e.label,r);break}case"select":{const i=e.options||[],n=(i.indexOf(e.value)+t+i.length)%i.length;e.value=i[n],this.updateOptionDisplay();break}}}activateOption(){const t=this.options[this.selectedOption];t.type==="action"&&t.action?t.action():t.type==="boolean"&&this.changeOptionValue(1)}updateOptionDisplay(){this.menuContainer.innerHTML="",this.optionElements=[],this.createOptionItems()}applyAudioSetting(t,e){if(!this.audioSystem)return;const i=e/100;switch(t){case"Master Volume":this.audioSystem.setVolume("master",i);break;case"Music Volume":this.audioSystem.setVolume("music",i);break;case"Sound Effects Volume":this.audioSystem.setVolume("sfx",i),this.audioSystem.playSfx("cursor");break}}resetToDefaults(){this.options[0].value=!1,this.options[1].value=!0,this.options[2].value=80,this.options[3].value=70,this.options[4].value=80,this.options[5].value="Normal",this.audioSystem&&(this.audioSystem.setVolume("master",.8),this.audioSystem.setVolume("music",.7),this.audioSystem.setVolume("sfx",.8)),this.updateOptionDisplay(),console.log("Options reset to defaults")}update(t){}onShow(){this.selectedOption=0,this.updateSelection(),console.log("OptionsMenu shown")}onHide(){console.log("OptionsMenu hidden")}getOptionValue(t){return this.options.find(i=>i.label===t)?.value}setOptionValue(t,e){const i=this.options.find(s=>s.label===t);i&&(i.value=e,this.updateOptionDisplay())}}class xe extends ot{constructor(){super(W.MENU,!1),this.selectedOption=0,this.menuOptions=["Endless Mode","VS Computer","VS Human","Options","Demo"],this.demoTimeoutTicks=0,this.init()}createElement(){const t=this.createStyledContainer({position:"fixed",top:"0",left:"0",width:"100%",height:"100%",background:"linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",zIndex:"1500",pointerEvents:"auto"});this.titleElement=this.createTextElement("PANEL POP",{fontSize:"64px",fontWeight:"bold",color:"#f1c40f",textAlign:"center",marginBottom:"20px",textShadow:"4px 4px 8px rgba(0, 0, 0, 0.5)",letterSpacing:"4px"}),t.appendChild(this.titleElement);const e=this.createTextElement("Three.js Edition",{fontSize:"18px",color:"#ecf0f1",textAlign:"center",marginBottom:"60px",opacity:"0.8"});t.appendChild(e),this.menuContainer=this.createStyledContainer({display:"flex",flexDirection:"column",alignItems:"center",gap:"15px"}),t.appendChild(this.menuContainer),this.createMenuOptions(),this.demoTimeoutWarning=this.createTextElement("Demo starts in 10 seconds...",{position:"absolute",bottom:"60px",left:"50%",transform:"translateX(-50%)",fontSize:"14px",color:"#e74c3c",opacity:"0",transition:"opacity 0.3s ease"}),t.appendChild(this.demoTimeoutWarning);const i=this.createTextElement("Press Enter to select ‚Ä¢ Arrow keys to navigate",{position:"absolute",bottom:"20px",left:"50%",transform:"translateX(-50%)",fontSize:"12px",color:"#95a5a6",opacity:"0.7"});return t.appendChild(i),t}createMenuOptions(){this.menuOptions.forEach((t,e)=>{const i=this.createTextElement(t,{fontSize:"24px",fontWeight:"bold",color:e===this.selectedOption?"#f1c40f":"#ecf0f1",textAlign:"center",padding:"10px 30px",cursor:"pointer",transition:"all 0.3s ease",border:e===this.selectedOption?"2px solid #f1c40f":"2px solid transparent",borderRadius:"8px",backgroundColor:e===this.selectedOption?"rgba(241, 196, 15, 0.1)":"transparent"});i.onclick=()=>{O.getInstance().onUserInput(),this.resetDemoTimeout(),this.selectedOption=e,this.updateMenuSelection(),this.selectCurrentOption()},i.onmouseenter=()=>{e!==this.selectedOption&&(i.style.color="#f39c12")},i.onmouseleave=()=>{e!==this.selectedOption&&(i.style.color="#ecf0f1")},this.menuContainer.appendChild(i)})}setupEventListeners(){document.addEventListener("keydown",t=>{if(this.isVisible)switch(O.getInstance().onUserInput(),this.resetDemoTimeout(),t.code){case"ArrowUp":case"KeyW":t.preventDefault(),this.selectedOption=(this.selectedOption-1+this.menuOptions.length)%this.menuOptions.length,this.updateMenuSelection();break;case"ArrowDown":case"KeyS":t.preventDefault(),this.selectedOption=(this.selectedOption+1)%this.menuOptions.length,this.updateMenuSelection();break;case"Enter":case"Space":t.preventDefault(),this.selectCurrentOption();break}})}updateMenuSelection(){const t=this.menuContainer.children;for(let e=0;e<t.length;e++){const i=t[e],s=e===this.selectedOption;i.style.color=s?"#f1c40f":"#ecf0f1",i.style.border=s?"2px solid #f1c40f":"2px solid transparent",i.style.backgroundColor=s?"rgba(241, 196, 15, 0.1)":"transparent"}}selectCurrentOption(){const t=O.getInstance();switch(this.selectedOption){case 0:t.setGameMode(E.ENDLESS),t.requestTransition(m.START_GAME);break;case 1:t.setGameMode(E.VS_AI),t.requestTransition(m.START_GAME);break;case 2:t.setGameMode(E.VS_HUMAN),t.requestTransition(m.START_GAME);break;case 3:t.requestTransition(m.SHOW_OPTIONS);break;case 4:t.setGameMode(E.DEMO),t.requestTransition(m.SHOW_DEMO);break}}update(t){this.isVisible&&(this.demoTimeoutWarning.style.opacity="0")}onShow(){this.selectedOption=0,this.demoTimeoutTicks=0,this.updateMenuSelection(),this.demoTimeoutWarning.style.opacity="0",this.animateTitle()}onHide(){}animateTitle(){const t=[{transform:"scale(1)",textShadow:"4px 4px 8px rgba(0, 0, 0, 0.5)"},{transform:"scale(1.05)",textShadow:"6px 6px 12px rgba(0, 0, 0, 0.8)"},{transform:"scale(1)",textShadow:"4px 4px 8px rgba(0, 0, 0, 0.5)"}];this.titleElement.animate(t,{duration:3e3,iterations:1/0,easing:"ease-in-out"})}resetDemoTimeout(){this.demoTimeoutTicks=0,this.demoTimeoutWarning.style.opacity="0"}}const tt=class tt{constructor(){this.components=new Map,this.activeOverlays=new Set,this.scoreHUD=null,this.countdownOverlay=null,this.titleScreen=null,this.mainMenu=null,this.pauseMenu=null,this.gameOverScreen=null,this.optionsMenu=null,console.log("UIManager: Constructor called"),this.stateManager=O.getInstance(),console.log("UIManager: StateManager instance obtained"),this.uiContainer=this.createUIContainer(),console.log("UIManager: UI container created"),this.setupStateListeners(),console.log("UIManager: Constructor completed")}static getInstance(){return tt.instance?console.log("UIManager: Returning existing singleton instance"):(console.log("UIManager: Creating new singleton instance"),tt.instance=new tt),tt.instance}initialize(){console.log("UIManager: initialize() called"),console.log("UIManager: UI container element:",this.uiContainer),console.log("UIManager: State manager:",this.stateManager),console.log("UIManager initialized")}createUIContainer(){let t=document.getElementById("uiContainer");return t||(t=document.createElement("div"),t.id="uiContainer",t.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        font-family: monospace;
        color: white;
        z-index: 1000;
      `,document.body.appendChild(t)),t}setupStateListeners(){console.log("UIManager: Setting up state listeners"),this.stateManager.addEventListener(t=>{switch(console.log(`UIManager: Received event ${t.type}`),t.type){case"stateChange":console.log("UIManager: Handling state change event"),this.handleStateChange(t);break;case"uiUpdate":console.log("UIManager: Handling UI update event"),this.handleUIUpdate(t);break;default:console.log(`UIManager: Unhandled event type: ${t.type}`);break}}),console.log("UIManager: State listeners setup complete")}handleStateChange(t){const{oldState:e,newState:i}=t.data;console.log(`UIManager: State change ${e} -> ${i}`),console.log(`UIManager: Hiding components for old state: ${e}`),this.hideStateComponents(e),console.log(`UIManager: Showing components for new state: ${i}`),this.showStateComponents(i)}handleUIUpdate(t){const{uiOverlays:e}=t.data;e&&this.updateOverlays(e)}hideStateComponents(t){if(t)switch(t){case p.TITLE_SCREEN:this.titleScreen?.hide();break;case p.MAIN_MENU:this.mainMenu?.hide();break;case p.GAME_PAUSED:this.pauseMenu?.hide();break;case p.GAME_OVER:this.gameOverScreen?.hide();break;case p.OPTIONS_MENU:this.optionsMenu?.hide();break}}showStateComponents(t){if(!t){console.log("UIManager: showStateComponents called with no state");return}switch(console.log(`UIManager: showStateComponents called for state: ${t}`),t){case p.TITLE_SCREEN:console.log("UIManager: Calling showTitleScreen()"),this.showTitleScreen();break;case p.MAIN_MENU:console.log("UIManager: Calling showMainMenu()"),this.showMainMenu();break;case p.GAME_PAUSED:console.log("UIManager: Calling showPauseMenu()"),this.showPauseMenu();break;case p.GAME_OVER:console.log("UIManager: Calling showGameOverScreen()"),this.showGameOverScreen();break;case p.OPTIONS_MENU:console.log("UIManager: Calling showOptionsMenu()"),this.showOptionsMenu();break;default:console.log(`UIManager: No UI component handler for state: ${t}`);break}}updateOverlays(t){for(const e of this.activeOverlays)t.includes(e)||(this.hideOverlay(e),this.activeOverlays.delete(e));for(const e of t)this.activeOverlays.has(e)||(this.showOverlay(e),this.activeOverlays.add(e))}showOverlay(t){switch(t){case U.SCORE:this.showScoreHUD();break;case U.COUNTDOWN:this.showCountdownOverlay();break;case U.PAUSE_MENU:this.showPauseMenu();break;case U.GAME_OVER:this.showGameOverScreen();break}}hideOverlay(t){switch(t){case U.SCORE:this.scoreHUD?.hide();break;case U.COUNTDOWN:this.countdownOverlay?.hide();break;case U.PAUSE_MENU:this.pauseMenu?.hide();break;case U.GAME_OVER:this.gameOverScreen?.hide();break}}showTitleScreen(){console.log("UIManager: Showing title screen"),this.titleScreen||(console.log("UIManager: Creating new TitleScreen component"),this.titleScreen=new xe,this.titleScreen.init(),console.log("UIManager: TitleScreen instance created"),this.uiContainer.appendChild(this.titleScreen.element),this.components.set("titleScreen",this.titleScreen),console.log("UIManager: TitleScreen added to DOM")),console.log("UIManager: Calling titleScreen.show()"),this.titleScreen.show(),console.log("UIManager: TitleScreen.show() completed")}showMainMenu(){this.mainMenu||(this.mainMenu=new be,this.mainMenu.init(),this.uiContainer.appendChild(this.mainMenu.element),this.components.set("mainMenu",this.mainMenu)),this.mainMenu.show()}showScoreHUD(){this.scoreHUD||(this.scoreHUD=new Ee,this.scoreHUD.init(),this.uiContainer.appendChild(this.scoreHUD.element),this.components.set("scoreHUD",this.scoreHUD)),this.scoreHUD.show()}showCountdownOverlay(){this.countdownOverlay||(this.countdownOverlay=new Te,this.countdownOverlay.init(),this.uiContainer.appendChild(this.countdownOverlay.element),this.components.set("countdownOverlay",this.countdownOverlay)),this.countdownOverlay.show()}showPauseMenu(){this.pauseMenu||(this.pauseMenu=new we,this.pauseMenu.init(),this.uiContainer.appendChild(this.pauseMenu.element),this.components.set("pauseMenu",this.pauseMenu)),this.pauseMenu.show()}showGameOverScreen(){this.gameOverScreen||(this.gameOverScreen=new Ce,this.gameOverScreen.init(),this.uiContainer.appendChild(this.gameOverScreen.element),this.components.set("gameOverScreen",this.gameOverScreen)),this.gameOverScreen.show()}showOptionsMenu(){this.optionsMenu||(this.optionsMenu=new ke,this.optionsMenu.init(),this.uiContainer.appendChild(this.optionsMenu.element),this.components.set("optionsMenu",this.optionsMenu)),this.optionsMenu.show()}update(){const t=this.stateManager.getStateData();for(const[e,i]of this.components)if(i.isVisible)try{i.update(t)}catch(s){console.error(`Error updating UI component ${e}:`,s)}}getComponent(t){return this.components.get(t)}destroy(){for(const t of this.components.values())t.destroy();this.components.clear(),this.uiContainer.remove()}getDebugInfo(){const t=Array.from(this.components.keys()).filter(i=>this.components.get(i)?.isVisible).join(", "),e=Array.from(this.activeOverlays).join(", ");return`UI: Components(${t||"none"}) | Overlays(${e||"none"})`}};tt.instance=null;let Ot=tt;class Ae{constructor(){this.context=null,this.masterGain=null,this.musicGain=null,this.sfxGain=null,this.settings={masterVolume:.8,musicVolume:.7,sfxVolume:.8,enabled:!0},this.initialized=!1,this.audioPool=new Map}async initialize(){if(!this.initialized)try{this.context=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.context.createGain(),this.musicGain=this.context.createGain(),this.sfxGain=this.context.createGain(),this.masterGain.connect(this.context.destination),this.musicGain.connect(this.masterGain),this.sfxGain.connect(this.masterGain),this.updateVolumes(),this.context.state==="suspended"&&await this.context.resume(),this.initialized=!0,console.log("AudioEngine initialized successfully")}catch(t){console.error("Failed to initialize AudioEngine:",t),this.settings.enabled=!1}}isReady(){return this.initialized&&this.context!==null&&this.settings.enabled}getContext(){return this.context}getMusicGain(){return this.musicGain}getSfxGain(){return this.sfxGain}async loadAudio(t,e){if(!this.context)throw new Error("AudioEngine not initialized");const i=this.audioPool.get(t);if(i)return i;try{const n=await(await fetch(e)).arrayBuffer(),o=await this.context.decodeAudioData(n);return this.audioPool.set(t,o),o}catch(s){throw console.error(`Failed to load audio ${t}:`,s),s}}getAudio(t){return this.audioPool.get(t)||null}createSource(t){if(!this.context)return null;const e=this.context.createBufferSource();return e.buffer=t,e}setVolume(t,e){switch(e=Math.max(0,Math.min(1,e)),t){case"master":this.settings.masterVolume=e;break;case"music":this.settings.musicVolume=e;break;case"sfx":this.settings.sfxVolume=e;break}this.updateVolumes()}getVolume(t){switch(t){case"master":return this.settings.masterVolume;case"music":return this.settings.musicVolume;case"sfx":return this.settings.sfxVolume;default:return 0}}setEnabled(t){this.settings.enabled=t,this.updateVolumes()}isEnabled(){return this.settings.enabled}getSettings(){return{...this.settings}}applySettings(t){Object.assign(this.settings,t),this.updateVolumes()}updateVolumes(){if(!this.masterGain||!this.musicGain||!this.sfxGain)return;const t=this.settings.enabled?this.settings.masterVolume:0;this.context&&(this.masterGain.gain.setValueAtTime(t,this.context.currentTime),this.musicGain.gain.setValueAtTime(this.settings.musicVolume,this.context.currentTime),this.sfxGain.gain.setValueAtTime(this.settings.sfxVolume,this.context.currentTime))}async resume(){this.context&&this.context.state==="suspended"&&await this.context.resume()}async suspend(){this.context&&this.context.state==="running"&&await this.context.suspend()}dispose(){this.context&&(this.context.close(),this.context=null),this.masterGain=null,this.musicGain=null,this.sfxGain=null,this.audioPool.clear(),this.initialized=!1,console.log("AudioEngine disposed")}}class Ie{constructor(t){this.currentTrack=null,this.currentSource=null,this.currentGain=null,this.crossfadeSource=null,this.crossfadeGain=null,this.fadeTimeout=null,this.isPlaying=!1,this.isPaused=!1,this.startTime=0,this.pauseTime=0,this.trackDefinitions=new Map([["title_intro",{url:"/assets/audio/music/panelpop_intro.ogg",loop:!1}],["title_loop",{url:"/assets/audio/music/panelpop_loop.ogg",loop:!0}],["battle_normal",{url:"/assets/audio/music/battle1_loop.ogg",loop:!0}],["battle_panic",{url:"/assets/audio/music/battle1_panic.ogg",loop:!0}]]),this.audioEngine=t}async loadAllTracks(){if(!this.audioEngine.isReady()){console.warn("AudioEngine not ready, skipping music loading");return}const t=[];for(const[e,i]of this.trackDefinitions){const s=this.audioEngine.loadAudio(`music_${e}`,i.url).then(()=>{}).catch(n=>{console.warn(`Failed to load music track ${e}:`,n)});t.push(s)}await Promise.all(t),console.log("Music tracks loaded")}async play(t,e=.5){if(!this.audioEngine.isReady()){console.warn("AudioEngine not ready, cannot play music");return}this.isPlaying&&this.stop(e);const i=this.trackDefinitions.get(t);if(!i){console.error(`Unknown music track: ${t}`);return}const s=this.audioEngine.getAudio(`music_${t}`);if(!s){console.error(`Music track not loaded: ${t}`);return}const n=this.audioEngine.getContext(),o=this.audioEngine.getMusicGain();!n||!o||(this.currentSource=this.audioEngine.createSource(s),this.currentGain=n.createGain(),!(!this.currentSource||!this.currentGain)&&(this.currentSource.connect(this.currentGain),this.currentGain.connect(o),this.currentSource.loop=i.loop,i.loopStart!==void 0&&(this.currentSource.loopStart=i.loopStart),i.loopEnd!==void 0&&(this.currentSource.loopEnd=i.loopEnd),this.currentGain.gain.setValueAtTime(0,n.currentTime),this.currentSource.start(),this.startTime=n.currentTime,this.isPlaying=!0,this.isPaused=!1,this.currentTrack=t,e>0?this.currentGain.gain.linearRampToValueAtTime(1,n.currentTime+e):this.currentGain.gain.setValueAtTime(1,n.currentTime),this.currentSource.onended=()=>{this.currentTrack===t&&!i.loop&&this.handleTrackEnded()}))}stop(t=.5){if(!this.isPlaying||!this.currentSource||!this.currentGain)return;const e=this.audioEngine.getContext();e&&(this.fadeTimeout&&(clearTimeout(this.fadeTimeout),this.fadeTimeout=null),t>0?(this.currentGain.gain.linearRampToValueAtTime(0,e.currentTime+t),this.fadeTimeout=window.setTimeout(()=>{this.stopImmediate()},t*1e3)):this.stopImmediate())}stopImmediate(){if(this.currentSource){try{this.currentSource.stop()}catch{}this.currentSource=null}this.currentGain=null,this.isPlaying=!1,this.isPaused=!1,this.currentTrack=null,this.startTime=0,this.pauseTime=0}async crossfade(t,e=1){if(!this.audioEngine.isReady()||this.currentTrack===t)return;this.crossfadeSource&&(this.crossfadeSource.stop(),this.crossfadeSource=null,this.crossfadeGain=null);const i=this.trackDefinitions.get(t);if(!i){console.error(`Unknown music track: ${t}`);return}const s=this.audioEngine.getAudio(`music_${t}`);if(!s){console.error(`Music track not loaded: ${t}`);return}const n=this.audioEngine.getContext(),o=this.audioEngine.getMusicGain();if(!n||!o||(this.crossfadeSource=this.audioEngine.createSource(s),this.crossfadeGain=n.createGain(),!this.crossfadeSource||!this.crossfadeGain))return;this.crossfadeSource.connect(this.crossfadeGain),this.crossfadeGain.connect(o),this.crossfadeSource.loop=i.loop,i.loopStart!==void 0&&(this.crossfadeSource.loopStart=i.loopStart),i.loopEnd!==void 0&&(this.crossfadeSource.loopEnd=i.loopEnd);const r=e/2;this.currentGain&&this.isPlaying&&this.currentGain.gain.linearRampToValueAtTime(0,n.currentTime+r),this.crossfadeGain.gain.setValueAtTime(0,n.currentTime),this.crossfadeSource.start(),this.crossfadeGain.gain.linearRampToValueAtTime(1,n.currentTime+e),setTimeout(()=>{this.stopImmediate(),this.currentSource=this.crossfadeSource,this.currentGain=this.crossfadeGain,this.currentTrack=t,this.isPlaying=!0,this.isPaused=!1,this.startTime=n.currentTime,this.crossfadeSource=null,this.crossfadeGain=null},r*1e3)}pause(){if(!this.isPlaying||this.isPaused)return;const t=this.audioEngine.getContext();t&&(this.pauseTime=t.currentTime-this.startTime,this.stopImmediate(),this.isPaused=!0)}async resume(){if(!this.isPaused||!this.currentTrack)return;const t=this.trackDefinitions.get(this.currentTrack),e=this.audioEngine.getAudio(`music_${this.currentTrack}`);if(!t||!e){this.isPaused=!1;return}const i=this.audioEngine.getContext(),s=this.audioEngine.getMusicGain();!i||!s||(this.currentSource=this.audioEngine.createSource(e),this.currentGain=i.createGain(),!(!this.currentSource||!this.currentGain)&&(this.currentSource.connect(this.currentGain),this.currentGain.connect(s),this.currentSource.loop=t.loop,t.loopStart!==void 0&&(this.currentSource.loopStart=t.loopStart),t.loopEnd!==void 0&&(this.currentSource.loopEnd=t.loopEnd),this.currentGain.gain.setValueAtTime(1,i.currentTime),this.currentSource.start(0,this.pauseTime),this.startTime=i.currentTime-this.pauseTime,this.isPlaying=!0,this.isPaused=!1))}getCurrentTrack(){return this.currentTrack}isCurrentlyPlaying(){return this.isPlaying&&!this.isPaused}isCurrentlyPaused(){return this.isPaused}handleTrackEnded(){if(this.currentTrack==="title_intro"){this.play("title_loop",.5);return}this.stopImmediate()}dispose(){if(this.stop(0),this.crossfadeSource){try{this.crossfadeSource.stop()}catch{}this.crossfadeSource=null,this.crossfadeGain=null}this.fadeTimeout&&(clearTimeout(this.fadeTimeout),this.fadeTimeout=null),console.log("MusicSystem disposed")}}class Oe{constructor(t){this.playingSfx=[],this.sfxPool=new Map,this.sfxDefinitions=new Map,this.audioEngine=t,this.initializeSfxDefinitions()}initializeSfxDefinitions(){this.sfxDefinitions.set("cursor",{url:"/assets/audio/sfx/cursor.wav",volume:.6,priority:1}),this.sfxDefinitions.set("swap",{url:"/assets/audio/sfx/swap.wav",volume:.8,priority:2}),this.sfxDefinitions.set("countdown",{url:"/assets/audio/sfx/countdown.wav",volume:.9,priority:10}),this.sfxDefinitions.set("go",{url:"/assets/audio/sfx/go.wav",volume:.9,priority:10}),this.sfxDefinitions.set("pause",{url:"/assets/audio/sfx/pause.wav",volume:.7,priority:8}),this.sfxDefinitions.set("chain",{url:"/assets/audio/sfx/chain.wav",volume:.8,priority:6}),this.sfxDefinitions.set("combo",{url:"/assets/audio/sfx/combo.wav",volume:.8,priority:6}),this.sfxDefinitions.set("thump",{url:"/assets/audio/sfx/thump.wav",volume:.7,priority:3,maxConcurrent:3}),this.sfxDefinitions.set("bigthump",{url:"/assets/audio/sfx/bigthump.wav",volume:.8,priority:5}),this.sfxDefinitions.set("fanfare1",{url:"/assets/audio/sfx/fanfare1.wav",volume:.9,priority:9}),this.sfxDefinitions.set("fanfare2",{url:"/assets/audio/sfx/fanfare2.wav",volume:.9,priority:9}),this.sfxDefinitions.set("fanfare3",{url:"/assets/audio/sfx/fanfare3.wav",volume:.9,priority:9});for(let t=1;t<=4;t++)for(let e=1;e<=10;e++){const i=`chain_${t}x${e}`;this.sfxDefinitions.set(i,{url:`/assets/audio/sfx/${t}x${e}.wav`,volume:.8,priority:7,maxConcurrent:2})}}async loadAllSfx(){if(!this.audioEngine.isReady()){console.warn("AudioEngine not ready, skipping SFX loading");return}const t=[];for(const[e,i]of this.sfxDefinitions){const s=this.audioEngine.loadAudio(`sfx_${e}`,i.url).then(n=>{this.sfxPool.set(e,n)}).catch(n=>{console.warn(`Failed to load SFX ${e}:`,n)});t.push(s)}await Promise.all(t),console.log("Sound effects loaded")}play(t,e,i){if(!this.audioEngine.isReady())return!1;const s=this.sfxDefinitions.get(t),n=this.sfxPool.get(t);if(!s||!n)return console.warn(`Sound effect not found or loaded: ${t}`),!1;const o=this.audioEngine.getContext(),r=this.audioEngine.getSfxGain();if(!o||!r)return!1;if(s.maxConcurrent&&this.playingSfx.filter(R=>R.type===t).length>=s.maxConcurrent){const R=this.playingSfx.filter(y=>y.type===t).sort((y,C)=>y.startTime-C.startTime)[0];R&&this.stopSfx(R)}const c=this.audioEngine.createSource(n);if(!c)return!1;const d=o.createGain(),u=(e!==void 0?e:1)*(s.volume||1);d.gain.setValueAtTime(u,o.currentTime),i!==void 0&&c.playbackRate.setValueAtTime(i,o.currentTime),c.connect(d),d.connect(r);const b={source:c,gainNode:d,startTime:o.currentTime,type:t};return this.playingSfx.push(b),c.onended=()=>{this.removeSfx(b)},c.start(),!0}playChain(t,e){const i=Math.max(1,Math.min(4,t)),s=Math.max(1,Math.min(10,e)),n=`chain_${i}x${s}`;return this.play(n)}playFanfare(t){const e=`fanfare${Math.max(1,Math.min(3,t))}`;return this.play(e)}stopType(t){this.playingSfx.filter(i=>i.type===t).forEach(i=>this.stopSfx(i))}stopAll(){[...this.playingSfx].forEach(e=>this.stopSfx(e))}stopSfx(t){try{t.source.stop()}catch{}this.removeSfx(t)}removeSfx(t){const e=this.playingSfx.indexOf(t);e!==-1&&this.playingSfx.splice(e,1)}cleanup(){const t=this.audioEngine.getContext()?.currentTime||0,e=10;this.playingSfx=this.playingSfx.filter(i=>{if(t-i.startTime>e){try{i.source.stop()}catch{}return!1}return!0})}getPlayingCount(){return this.playingSfx.length}getPlayingByType(t){return this.playingSfx.filter(e=>e.type===t).length}dispose(){this.stopAll(),this.sfxPool.clear(),console.log("SoundEffectManager disposed")}}class Re{constructor(){this.initialized=!1,this.audioEngine=new Ae,this.musicSystem=new Ie(this.audioEngine),this.sfxManager=new Oe(this.audioEngine)}async initialize(){if(!this.initialized)try{await this.audioEngine.initialize(),this.audioEngine.isReady()?(await Promise.all([this.musicSystem.loadAllTracks(),this.sfxManager.loadAllSfx()]),this.initialized=!0,console.log("AudioSystem initialized successfully")):console.warn("AudioEngine failed to initialize, audio disabled")}catch(t){console.error("Failed to initialize AudioSystem:",t)}}isReady(){return this.initialized&&this.audioEngine.isReady()}async playMusic(t,e){this.isReady()&&await this.musicSystem.play(t,e)}stopMusic(t){this.isReady()&&this.musicSystem.stop(t)}async crossfadeMusic(t,e){this.isReady()&&await this.musicSystem.crossfade(t,e)}pauseMusic(){this.isReady()&&this.musicSystem.pause()}async resumeMusic(){this.isReady()&&await this.musicSystem.resume()}getCurrentMusicTrack(){return this.musicSystem.getCurrentTrack()}isMusicPlaying(){return this.musicSystem.isCurrentlyPlaying()}isMusicPaused(){return this.musicSystem.isCurrentlyPaused()}playSfx(t,e,i){return this.isReady()?this.sfxManager.play(t,e,i):!1}playChain(t,e){return this.isReady()?this.sfxManager.playChain(t,e):!1}playFanfare(t){return this.isReady()?this.sfxManager.playFanfare(t):!1}stopSfxType(t){this.isReady()&&this.sfxManager.stopType(t)}stopAllSfx(){this.isReady()&&this.sfxManager.stopAll()}setVolume(t,e){this.audioEngine.setVolume(t,e)}getVolume(t){return this.audioEngine.getVolume(t)}setEnabled(t){this.audioEngine.setEnabled(t)}isEnabled(){return this.audioEngine.isEnabled()}getSettings(){return this.audioEngine.getSettings()}applySettings(t){this.audioEngine.applySettings(t)}async resume(){await this.audioEngine.resume()}async suspend(){await this.audioEngine.suspend()}update(){this.isReady()&&this.sfxManager.cleanup()}getDebugInfo(){return{initialized:this.initialized,audioEngineReady:this.audioEngine.isReady(),currentTrack:this.musicSystem.getCurrentTrack(),musicPlaying:this.musicSystem.isCurrentlyPlaying(),musicPaused:this.musicSystem.isCurrentlyPaused(),playingSfxCount:this.sfxManager.getPlayingCount(),settings:this.audioEngine.getSettings()}}dispose(){this.musicSystem.dispose(),this.sfxManager.dispose(),this.audioEngine.dispose(),this.initialized=!1,console.log("AudioSystem disposed")}}class Pe{constructor(t){this.gameController=null,this.accumulator=0,this.timestep=1/60,this.maxFrameTime=.25,this.ticksRun=0,this.frameTimeHistory=[],this.isRunning=!1,this.debugMode=!1,console.log("GameEngine: Constructor called"),this.renderer=new te({canvas:t,antialias:!0,alpha:!1,powerPreference:"high-performance"}),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.setClearColor(0,1),this.clock=new ee,this.assetLoader=new ie,this.sceneManager=new Se(this.assetLoader),this.stateManager=O.getInstance(),this.uiManager=Ot.getInstance(),console.log("GameEngine: Initializing AudioSystem"),this.audioSystem=new Re,console.log("GameEngine: Phase 10 systems initialized"),this.setupEventListeners(),this.handleResize(),console.log("GameEngine: Constructor completed")}async initialize(){try{await this.assetLoader.loadEssentialAssets(),this.sceneManager.initialize(),console.log("GameEngine: Calling uiManager.initialize()"),this.uiManager.initialize(),console.log("GameEngine: Calling stateManager.initializeUI()"),this.stateManager.initializeUI(),console.log("GameEngine: Initializing AudioSystem"),await this.audioSystem.initialize(),this.sceneManager.setAudioSystem(this.audioSystem),this.setupGameComponents(),this.hideLoadingScreen(),console.log("GameEngine: Requesting transition to LOADING_COMPLETE"),this.stateManager.requestTransition(m.LOADING_COMPLETE),console.log("GameEngine initialized successfully")}catch(t){throw console.error("Failed to initialize GameEngine:",t),t}}start(){this.isRunning||(this.isRunning=!0,this.clock.start(),this.gameLoop(),console.log("GameEngine started"))}stop(){this.isRunning=!1,console.log("GameEngine stopped")}setupGameComponents(){if(!this.sceneManager.getBoard())throw new Error("Board not found in SceneManager");console.log("Game components set up for Phase 9")}gameLoop(){if(!this.isRunning)return;requestAnimationFrame(()=>this.gameLoop());const t=Math.min(this.clock.getDelta(),this.maxFrameTime);this.accumulator+=t;let e=0;for(;this.accumulator>=this.timestep&&e<4;)this.tick(),this.accumulator-=this.timestep,e++;const i=this.accumulator/this.timestep;this.render(i),this.debugMode&&this.updateDebugInfo(t)}tick(){this.ticksRun++,this.stateManager.tick();const t=this.stateManager.getCurrentState();j.isGameplayState(t)&&(this.gameController&&(this.gameController.tick(),this.gameController.updateCursorState()),this.sceneManager.tick()),this.audioSystem.update(),this.uiManager.update()}render(t){this.renderer.clear(),this.sceneManager.render(this.renderer,t)}setupEventListeners(){window.addEventListener("resize",()=>this.handleResize()),document.addEventListener("visibilitychange",()=>{document.hidden?(this.clock.stop(),this.audioSystem.suspend()):(this.clock.start(),this.audioSystem.resume())});const t=async()=>{await this.audioSystem.resume(),document.removeEventListener("click",t),document.removeEventListener("keydown",t),document.removeEventListener("touchstart",t)};document.addEventListener("click",t,{once:!0}),document.addEventListener("keydown",t,{once:!0}),document.addEventListener("touchstart",t,{once:!0})}handleResize(){const t=Math.max(1,window.innerWidth),e=Math.max(1,window.innerHeight);this.renderer.setSize(t,e),this.sceneManager.handleResize(t,e)}hideLoadingScreen(){const t=document.getElementById("loadingScreen");t&&(t.style.display="none")}setupDebugUI(){const t=document.getElementById("debugInfo");t&&(t.style.display="block"),console.log("Debug UI enabled - Press F3 to toggle, Arrow keys to move cursor"),console.log("Keybindings: ‚Üë‚Üì‚Üê‚Üí/WASD = move, X = swap, Z = raise stack, ESC = pause"),window.addEventListener("keydown",e=>{if(e.code==="F3"){e.preventDefault();const i=document.getElementById("debugInfo");i&&(i.style.display=i.style.display==="none"?"block":"none")}})}updateDebugInfo(t){this.frameTimeHistory.push(t*1e3),this.frameTimeHistory.length>60&&this.frameTimeHistory.shift();const e=this.frameTimeHistory.reduce((y,C)=>y+C,0)/this.frameTimeHistory.length,i=Math.round(1e3/e),s=document.getElementById("fps"),n=document.getElementById("frameTime"),o=document.getElementById("ticks");if(s&&(s.textContent=i.toString()),n&&(n.textContent=`${e.toFixed(2)}ms`),o&&(o.textContent=this.ticksRun.toString()),this.gameController){const y=document.getElementById("gameController");y&&(y.textContent=this.gameController.getDebugInfo());const C=document.getElementById("inputManager");C&&(C.textContent=this.gameController.getInputManager().getDebugInfo());const P=document.getElementById("inputStates");if(P){const I=this.gameController.getInputManager(),q=[`UP: ${I.isPressed(f.UP)?"‚ñ†":"‚ñ°"}`,`DOWN: ${I.isPressed(f.DOWN)?"‚ñ†":"‚ñ°"}`,`LEFT: ${I.isPressed(f.LEFT)?"‚ñ†":"‚ñ°"}`,`RIGHT: ${I.isPressed(f.RIGHT)?"‚ñ†":"‚ñ°"}`,`SWAP: ${I.isPressed(f.SWAP)?"‚ñ†":"‚ñ°"}`,`RAISE: ${I.isPressed(f.RAISE)?"‚ñ†":"‚ñ°"}`,`PAUSE: ${I.isPressed(f.PAUSE)?"‚ñ†":"‚ñ°"}`];P.textContent=q.join(" | ")}}const r=this.sceneManager,c=r.getCursor();if(c){const y=document.getElementById("cursor");y&&(y.textContent=c.getDebugInfo());const C=document.getElementById("cursorPos");if(C){const P=c.getPosition(),I=c.getTargetPosition(),q=c.isMoving();C.textContent=`Pos:(${P.x},${P.y}) Target:(${I.x},${I.y}) Moving:${q}`}}const d=r.getBoard();if(d){const y=document.getElementById("board");y&&(y.textContent=d.getDebugInfo());const C=document.getElementById("boardState");C&&(C.textContent=`State: ${d.state} | Panic: ${d.isPanic()} | Score: ${d.getScore()}`)}const u=r.getVisualEffectsManager();if(u){const y=document.getElementById("visualEffects");y&&(y.textContent=u.getDebugInfo())}const b=document.getElementById("stateManager");b&&(b.textContent=this.stateManager.getDebugInfo());const N=document.getElementById("uiManager");N&&(N.textContent=this.uiManager.getDebugInfo());const R=document.getElementById("audioSystem");if(R){const y=this.audioSystem.getDebugInfo();R.textContent=`Audio: ${y.initialized?"Ready":"Not Ready"} | Music: ${y.currentTrack||"None"} | SFX: ${y.playingSfxCount}`}}getTicksRun(){return this.ticksRun}getRenderer(){return this.renderer}getSceneManager(){return this.sceneManager}isDebugMode(){return this.debugMode}setGameController(t){this.gameController=t;const e=this.sceneManager.getBoard();e&&this.stateManager.initialize(e,t,this.audioSystem)}getGameController(){return this.gameController}getStateManager(){return this.stateManager}getUIManager(){return this.uiManager}getAudioSystem(){return this.audioSystem}isPaused(){return this.gameController?.isPaused()??!1}pause(){this.gameController?.pause()}resume(){this.gameController?.resume()}}const x=class x{constructor(t,e){this.targetWorldX=0,this.targetWorldY=0,this.pulseTimer=0,this.pulseEnabled=!0,this.board=t,this.tileSize=e,this.boardPixelWidth=T.BOARD_WIDTH*e,this.boardPixelHeight=(T.TOP_ROW+1)*e,this.x=this.board.cursorX,this.y=this.board.cursorY,this.targetX=this.x,this.targetY=this.y,this.updateWorldPositions(),this.currentWorldX=this.targetWorldX,this.currentWorldY=this.targetWorldY,this.createMesh()}createMesh(){this.geometry=new ft(x.CURSOR_SIZE,x.CURSOR_SIZE),this.material=new V({color:16777215,transparent:!0,opacity:.8,side:Tt}),this.mesh=new Y(this.geometry,this.material),this.mesh.name="Cursor",this.mesh.position.set(this.currentWorldX,this.currentWorldY,x.CURSOR_Z_POSITION);const t=new Ct(this.geometry),e=new Mt({color:0,transparent:!0,opacity:.6}),i=new kt(t,e);this.mesh.add(i)}updateWorldPositions(){this.targetWorldX=this.targetX*this.tileSize-this.boardPixelWidth/2+this.tileSize,this.targetWorldY=this.targetY*this.tileSize-this.boardPixelHeight/2+this.tileSize/2}move(t,e){const i=this.targetX+t,s=this.targetY+e;let n=i,o=s;const r=T.BOARD_WIDTH-2;return n<0?n=r:n>r&&(n=0),o=Math.max(0,Math.min(T.TOP_ROW,o)),n!==this.targetX||o!==this.targetY?(this.targetX=n,this.targetY=o,this.updateWorldPositions(),this.board.cursorX=this.targetX,this.board.cursorY=this.targetY,!0):!1}setPosition(t,e){const i=T.BOARD_WIDTH-2;this.targetX=Math.max(0,Math.min(i,t)),this.targetY=Math.max(0,Math.min(T.TOP_ROW,e)),this.updateWorldPositions(),this.board.cursorX=this.targetX,this.board.cursorY=this.targetY}getPosition(){return{x:this.x,y:this.y}}getTargetPosition(){return{x:this.targetX,y:this.targetY}}canSwap(){const t=T.BOARD_WIDTH-2;if(this.targetX>t)return!1;const e=this.board.getTile(this.targetY,this.targetX),i=this.board.getTile(this.targetY,this.targetX+1);return e!==null&&i!==null}swap(){if(!this.canSwap())return!1;const t=this.board.getTile(this.targetY,this.targetX),e=this.board.getTile(this.targetY,this.targetX+1);if(!t||!e)return!1;const i=t.block,s=e.block,n=t.type,o=t.block,r=t.garbageRef,c=t.chain;t.type=e.type,t.block=e.block,t.garbageRef=e.garbageRef,t.chain=e.chain,e.type=n,e.block=o,e.garbageRef=r,e.chain=c;const d=et(this.targetY,this.targetX),u=et(this.targetY,this.targetX+1);return console.log(`[CURSOR] Swap targets: left=(${d.x.toFixed(2)}, ${d.y.toFixed(2)}), right=(${u.x.toFixed(2)}, ${u.y.toFixed(2)})`),i&&(console.log(`[CURSOR] Setting RIGHT target for original left block (${A[i.color]})`),i.startSwap("right",u)),s&&(console.log(`[CURSOR] Setting LEFT target for original right block (${A[s.color]})`),s.startSwap("left",d)),this.board.graceTimer=30,!0}tick(){this.pulseTimer++,this.x=this.targetX,this.y=this.targetY;const t=x.MOVE_SMOOTHING;if(this.currentWorldX+=(this.targetWorldX-this.currentWorldX)*t,this.currentWorldY+=(this.targetWorldY-this.currentWorldY)*t,this.mesh.position.x=this.currentWorldX,this.mesh.position.y=this.currentWorldY,this.pulseEnabled){const e=Math.sin(this.pulseTimer*x.PULSE_SPEED),i=x.PULSE_SCALE_MIN+(x.PULSE_SCALE_MAX-x.PULSE_SCALE_MIN)*(e*.5+.5);this.mesh.scale.set(i,i,1);const s=.6+.3*(e*.5+.5);this.material.opacity=s}}setPulseEnabled(t){this.pulseEnabled=t,t||(this.mesh.scale.set(1,1,1),this.material.opacity=.8)}setColor(t){this.material.color.setHex(t)}setVisible(t){this.mesh.visible=t}getMesh(){return this.mesh}getBounds(){return{x:this.currentWorldX-x.CURSOR_SIZE/2,y:this.currentWorldY-x.CURSOR_SIZE/2,width:x.CURSOR_SIZE,height:x.CURSOR_SIZE}}static worldToGrid(t,e,i,s,n){const o=s*i,r=n*i,c=t+o/2-i/2,d=e+r/2-i/2;return{x:Math.floor(c/i),y:Math.floor(d/i)}}isAt(t,e){return this.x===t&&this.y===e}isMoving(){return Math.abs(this.currentWorldX-this.targetWorldX)>.1||Math.abs(this.currentWorldY-this.targetWorldY)>.1}resetToCenter(){this.setPosition(Math.floor(T.BOARD_WIDTH/2),Math.floor(T.TOP_ROW/2)),this.currentWorldX=this.targetWorldX,this.currentWorldY=this.targetWorldY}getDebugInfo(){return`Cursor: (${this.x},${this.y}) Target:(${this.targetX},${this.targetY}) Moving:${this.isMoving()}`}dispose(){if(this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.mesh.children.length>0){const t=this.mesh.children[0];t.geometry&&t.geometry.dispose(),t.material instanceof F&&t.material.dispose()}}};x.CURSOR_Z_POSITION=2,x.CURSOR_SIZE=30,x.PULSE_SPEED=.15,x.PULSE_SCALE_MIN=.9,x.PULSE_SCALE_MAX=1.1,x.MOVE_SMOOTHING=.3;let Rt=x;class De{constructor(){this.gameEngine=null,this.initialize()}async initialize(){try{const t=document.getElementById("gameCanvas");if(!t)throw new Error("Canvas element not found");this.gameEngine=new Pe(t),await this.gameEngine.initialize(),this.setupGame(),this.gameEngine.start(),console.log("Panel Pop application started successfully"),this.setupErrorHandlers()}catch(t){console.error("Failed to initialize application:",t),this.showError("Failed to start the game. Please refresh the page and try again.")}}setupGame(){if(!this.gameEngine)return;const t=this.gameEngine.getSceneManager(),e=this.gameEngine.getAudioSystem(),i=t.getBoard();if(!i)throw new Error("Board not found in SceneManager");const s=new Rt(i,mt.TILE_SIZE),n=new It(i,s,e);t.setCursor(s),this.gameEngine.setGameController(n),console.log("Game components initialized - Phase 3 complete")}setupErrorHandlers(){window.addEventListener("error",t=>{console.error("Unhandled error:",t.error),this.showError("An unexpected error occurred. Please refresh the page.")}),window.addEventListener("unhandledrejection",t=>{console.error("Unhandled promise rejection:",t.reason),this.showError("An unexpected error occurred. Please refresh the page.")})}showError(t){const e=document.getElementById("loadingScreen");e&&(e.style.display="none");const i=document.createElement("div");i.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #ff4444;
      color: white;
      padding: 20px;
      border-radius: 10px;
      font-family: monospace;
      text-align: center;
      z-index: 1000;
      max-width: 400px;
    `,i.innerHTML=`
      <h3>Error</h3>
      <p>${t}</p>
      <button onclick="location.reload()" style="
        margin-top: 10px;
        padding: 10px 20px;
        background: white;
        color: #ff4444;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-family: monospace;
      ">Reload Game</button>
    `,document.body.appendChild(i)}}document.addEventListener("DOMContentLoaded",()=>{new De});
